<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Demo - Hor√°rio Inteligente</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">

    <!-- Intro.js para tour guiado -->
    <link rel="stylesheet" href="https://unpkg.com/intro.js/minified/introjs.min.css">
    <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>

    <style>
        body { background: #f8fafc; }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        /* Custom Intro.js styling */
        .introjs-tooltip {
            max-width: 400px;
            padding-top: 35px !important;
        }
        .introjs-tooltiptext {
            font-size: 14px;
        }
        .introjs-skipbutton {
            position: absolute !important;
            top: 10px !important;
            right: 10px !important;
            color: #666 !important;
            font-size: 14px !important;
            padding: 4px 8px !important;
        }
        .introjs-skipbutton:hover {
            color: #333 !important;
        }
        .demo-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .introjs-helperLayer {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Chat Simulator Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 500px;
            max-height: 70vh;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4ccc4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .chat-bubble.user {
            background: #dcf8c6;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .chat-bubble.bot {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        .chat-bubble .time {
            font-size: 11px;
            color: #667781;
            margin-top: 4px;
            text-align: right;
        }
        .chat-bubble.bot .time {
            text-align: left;
        }
        /* Audio button styles */
        .audio-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #128C7E;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
            vertical-align: middle;
        }
        .audio-btn:hover {
            background: #075E54;
            transform: scale(1.1);
        }
        .audio-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .audio-btn.playing {
            background: #e74c3c;
            animation: pulse-audio 1s infinite;
        }
        .audio-btn.loading {
            background: #f39c12;
        }
        @keyframes pulse-audio {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .chat-bubble .message-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 4px;
        }
        .chat-bubble.bot .message-footer {
            justify-content: flex-start;
            gap: 8px;
        }
        /* Mic button styles */
        .mic-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #128C7E;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .mic-btn:hover {
            background: #075E54;
        }
        .mic-btn.recording {
            background: #e74c3c;
            animation: pulse-mic 1s infinite;
        }
        .mic-btn.processing {
            background: #f39c12;
        }
        .mic-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        @keyframes pulse-mic {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        }
        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fee2e2;
            border-radius: 20px;
            color: #dc2626;
            font-size: 14px;
            animation: fadeIn 0.3s;
        }
        .recording-indicator .dot {
            width: 8px;
            height: 8px;
            background: #dc2626;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            width: fit-content;
            margin-bottom: 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #90949c;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        .suggestion-chip {
            display: inline-block;
            padding: 8px 16px;
            background: white;
            border: 1px solid #128C7E;
            color: #128C7E;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px;
        }
        .suggestion-chip:hover {
            background: #128C7E;
            color: white;
        }
        .chat-input-container {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: #f0f2f5;
            border-top: 1px solid #e0e0e0;
        }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 24px;
            background: white;
            font-size: 15px;
            outline: none;
        }
        .chat-send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #128C7E;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .chat-send-btn:hover {
            background: #075E54;
        }
        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .chat-header {
            background: #128C7E;
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chat-header .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid white;
        }
        .chat-header .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .chat-header .info h4 {
            font-weight: 600;
            font-size: 16px;
        }
        .chat-header .info p {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Demo Banner -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 px-4 text-sm">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-center gap-x-4 gap-y-1">
            <span class="demo-badge inline-flex items-center gap-2">
                <i class="fas fa-flask"></i>
                <span class="hidden sm:inline">Ambiente de Demonstra√ß√£o</span>
                <span class="sm:hidden">Demo</span>
            </span>
            <span class="hidden sm:inline text-white/50">|</span>
            <button onclick="voltarDemo()" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-exchange-alt"></i>
                <span>Trocar Perfil</span>
            </button>
            <span class="hidden sm:inline text-white/50">|</span>
            <button onclick="iniciarTour()" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-route"></i>
                <span>Tour</span>
            </button>
            <span class="hidden sm:inline text-white/50">|</span>
            <a href="https://horariointeligente.com.br/#contato" class="inline-flex items-center gap-1 hover:underline">
                <i class="fab fa-whatsapp"></i>
                <span class="hidden sm:inline">Contratar</span>
            </a>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b" data-intro="Este √© o cabe√ßalho do sistema. Aqui voc√™ encontra o menu principal e informa√ß√µes do usu√°rio logado." data-step="1">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="/static/images/logo.png" alt="Hor√°rio Inteligente" class="w-20 h-20 object-contain">
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Consult√≥rio Demonstra√ß√£o</h1>
                    <p class="text-xs text-gray-500">Hor√°rio Inteligente</p>
                </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-4">
                <button class="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" data-intro="Central de notifica√ß√µes: lembretes, confirma√ß√µes e alertas importantes." data-step="2">
                    <i class="fas fa-bell text-xl"></i>
                    <span class="absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">3</span>
                </button>
                <button onclick="abrirPerfil()" class="hidden sm:flex items-center gap-2 text-gray-700 hover:text-purple-600 transition" title="Meu Perfil">
                    <div class="w-9 h-9 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-user-md text-purple-600"></i>
                    </div>
                    <span class="font-medium" id="userName">Dr. Carlos Silva</span>
                    <i class="fas fa-chevron-down text-xs text-gray-400"></i>
                </button>
                <button onclick="voltarDemo()" class="flex items-center gap-2 px-3 py-2 text-sm text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition" title="Voltar para sele√ß√£o de perfil">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden sm:inline">Voltar</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" data-intro="Cards de estat√≠sticas r√°pidas. Visualize m√©tricas importantes do seu dia em um relance." data-step="3">
            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-bold text-gray-800" id="consultasHoje">8</p>
                        <p class="text-sm text-gray-500">Consultas Hoje</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                        <i class="fas fa-calendar-day text-blue-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-bold text-gray-800" id="pacientesTotal">20</p>
                        <p class="text-sm text-gray-500">Pacientes</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                        <i class="fas fa-users text-green-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-bold text-gray-800" id="confirmados">5</p>
                        <p class="text-sm text-gray-500">Confirmados</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-check-circle text-purple-500 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl p-4 shadow-sm border">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-bold text-gray-800" id="pendentes">3</p>
                        <p class="text-sm text-gray-500">Pendentes</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-500 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Agenda do Dia -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border" data-intro="Agenda do dia: visualize todas as consultas agendadas, com status de confirma√ß√£o e informa√ß√µes do paciente." data-step="4">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                        Agenda de Hoje
                    </h2>
                    <button onclick="abrirAgendamento()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Novo Agendamento
                    </button>
                </div>
                <div class="p-4 space-y-3" id="agendaHoje">
                    <!-- Agendamentos ser√£o carregados aqui -->
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- A√ß√µes R√°pidas -->
                <div class="bg-white rounded-xl shadow-sm border p-4" data-intro="A√ß√µes r√°pidas: acesse as funcionalidades mais utilizadas com um clique." data-step="5">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                        A√ß√µes R√°pidas
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="abrirAgendamento()" class="flex flex-col items-center gap-2 p-3 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
                            <i class="fas fa-calendar-plus text-purple-600 text-xl"></i>
                            <span class="text-xs text-gray-700">Agendar</span>
                        </button>
                        <button onclick="abrirWhatsApp()" class="flex flex-col items-center gap-2 p-3 bg-emerald-50 rounded-lg hover:bg-emerald-100 transition">
                            <i class="fab fa-whatsapp text-emerald-600 text-xl"></i>
                            <span class="text-xs text-gray-700">WhatsApp</span>
                        </button>
                        <button onclick="abrirRelatorios()" class="flex flex-col items-center gap-2 p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                            <i class="fas fa-chart-bar text-blue-600 text-xl"></i>
                            <span class="text-xs text-gray-700">Relat√≥rios</span>
                        </button>
                        <button onclick="abrirCalendario()" class="flex flex-col items-center gap-2 p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                            <i class="fas fa-calendar text-indigo-600 text-xl"></i>
                            <span class="text-xs text-gray-700">Calend√°rio</span>
                        </button>
                    </div>
                </div>

                <!-- Simulador Secret√°ria IA -->
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl shadow-sm p-4 text-white" data-intro="Simulador de Atendimento: experimente como seus pacientes ser√£o atendidos pela nossa IA via WhatsApp." data-step="6">
                    <div class="flex items-start gap-3 mb-3">
                        <!-- Avatar da Fernanda -->
                        <img src="/static/images/fernanda.png"
                             alt="Fernanda - Assistente Virtual"
                             class="w-14 h-14 rounded-full border-2 border-white shadow-lg flex-shrink-0 object-cover">
                        <div>
                            <h3 class="text-lg font-bold">
                                Fale com a Fernanda!
                            </h3>
                            <p class="text-sm text-purple-100">
                                Nossa atendente de teste
                            </p>
                        </div>
                    </div>
                    <p class="text-sm text-purple-100 mb-4">
                        Simule uma conversa como paciente e veja o agendamento inteligente em a√ß√£o! <span class="opacity-75">Voc√™ poder√° escolher o nome da sua assistente.</span>
                    </p>
                    <button onclick="abrirAssistente()" class="w-full bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 transition font-medium flex items-center justify-center gap-2">
                        <i class="fab fa-whatsapp"></i>
                        Conversar com a Fernanda
                    </button>
                </div>

                <!-- WhatsApp Status -->
                <div class="bg-white rounded-xl shadow-sm border p-4" data-intro="Integra√ß√£o WhatsApp: envie lembretes autom√°ticos e comunique-se com pacientes diretamente pelo sistema." data-step="7">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">
                        <i class="fab fa-whatsapp mr-2 text-green-500"></i>
                        WhatsApp
                    </h3>
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-sm text-green-700">Conectado</span>
                        </div>
                        <span class="text-xs text-green-600">Lembretes ativos</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-bell mr-1"></i>
                        3 lembretes enviados hoje
                    </p>
                </div>
            </div>
        </div>

        <!-- Funcionalidades Extras -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4" data-intro="Mais funcionalidades: explore o dashboard anal√≠tico, calend√°rio completo e configura√ß√µes." data-step="8">
            <button onclick="abrirDashboardAnalitico()" class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition text-left group">
                <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center mb-4 group-hover:bg-purple-200 transition">
                    <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-1">Dashboard Anal√≠tico</h3>
                <p class="text-sm text-gray-500">M√©tricas, gr√°ficos e an√°lise de desempenho do consult√≥rio</p>
            </button>

            <button onclick="abrirCalendario()" class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition text-left group">
                <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center mb-4 group-hover:bg-blue-200 transition">
                    <i class="fas fa-calendar text-blue-600 text-xl"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-1">Calend√°rio Completo</h3>
                <p class="text-sm text-gray-500">Visualiza√ß√£o mensal, semanal e di√°ria</p>
            </button>

            <button onclick="abrirConfiguracoes()" class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition text-left group">
                <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mb-4 group-hover:bg-gray-200 transition">
                    <i class="fas fa-cog text-gray-600 text-xl"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-1">Configura√ß√µes</h3>
                <p class="text-sm text-gray-500">Hor√°rios de atendimento, conv√™nios e prefer√™ncias</p>
            </button>

            <button onclick="abrirPerfil()" class="bg-white rounded-xl shadow-sm border p-6 hover:shadow-md transition text-left group">
                <div class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center mb-4 group-hover:bg-indigo-200 transition">
                    <i class="fas fa-user-cog text-indigo-600 text-xl"></i>
                </div>
                <h3 class="font-bold text-gray-800 mb-1">Meu Perfil</h3>
                <p class="text-sm text-gray-500">Foto, notifica√ß√µes e dados profissionais</p>
            </button>
        </div>
    </main>

    <!-- Modal Novo Agendamento -->
    <div id="modalAgendamento" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-calendar-plus mr-2 text-purple-500"></i>
                    Novo Agendamento
                </h3>
                <button onclick="fecharModal('modalAgendamento')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="formAgendamentoDemo" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Paciente *</label>
                    <input type="text" id="demo_paciente_nome"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="Digite o nome do paciente" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone (WhatsApp) *</label>
                    <input type="tel" id="demo_paciente_telefone"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="(21) 99999-9999"
                           maxlength="15"
                           required>
                    <span class="text-xs text-gray-500">Formato: (XX) XXXXX-XXXX</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data *</label>
                        <input type="date" id="demo_data"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hor√°rio *</label>
                        <select id="demo_hora" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                            <option value="">Selecione...</option>
                            <option value="08:00">08:00</option>
                            <option value="08:30">08:30</option>
                            <option value="09:00">09:00</option>
                            <option value="09:30">09:30</option>
                            <option value="10:00">10:00</option>
                            <option value="10:30">10:30</option>
                            <option value="11:00">11:00</option>
                            <option value="11:30">11:30</option>
                            <option value="14:00">14:00</option>
                            <option value="14:30">14:30</option>
                            <option value="15:00">15:00</option>
                            <option value="15:30">15:30</option>
                            <option value="16:00">16:00</option>
                            <option value="16:30">16:30</option>
                            <option value="17:00">17:00</option>
                            <option value="17:30">17:30</option>
                            <option value="18:00">18:00</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                    <select id="demo_tipo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Motivo da Consulta</label>
                    <input type="text" id="demo_motivo"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="Ex: Consulta de rotina">
                </div>
                <div id="demo_erro" class="hidden bg-red-50 text-red-700 p-3 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="demo_erro_msg"></span>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="fecharModal('modalAgendamento')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button type="button" id="btnSalvarAgendamento" onclick="salvarAgendamento()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-check"></i>
                        Agendar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Info Demo -->
    <div id="modalInfo" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl text-center">
            <div class="w-16 h-16 mx-auto rounded-full bg-purple-100 flex items-center justify-center mb-4">
                <i class="fas fa-info-circle text-purple-500 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="modalInfoTitulo">Funcionalidade Demo</h3>
            <p class="text-gray-600 mb-6" id="modalInfoTexto">Esta √© uma demonstra√ß√£o. No sistema completo, voc√™ ter√° acesso a todas as funcionalidades.</p>
            <div class="flex gap-3">
                <button onclick="fecharModal('modalInfo')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Entendi
                </button>
                <a href="https://horariointeligente.com.br/#contato" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition inline-flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i>
                    Contratar
                </a>
            </div>
        </div>
    </div>

    <!-- Modal Chat Simulator -->
    <div id="modalChat" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl w-full max-w-lg mx-4 shadow-2xl overflow-hidden">
            <!-- Chat Header -->
            <div class="chat-header">
                <button onclick="fecharModal('modalChat')" class="text-white hover:bg-white/20 p-2 rounded-full transition -ml-1">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="avatar">
                    <img src="/static/images/fernanda.png" alt="Fernanda - Assistente Virtual">
                </div>
                <div class="info flex-1">
                    <h4>Fernanda - Assistente Virtual</h4>
                    <p id="chatStatus">online</p>
                </div>
                <button onclick="reiniciarChat()" class="text-white hover:bg-white/20 p-2 rounded-full transition" title="Reiniciar conversa">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Messages Area -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Mensagem de boas-vindas -->
                    <div class="chat-bubble bot" id="msg-welcome" data-texto-original="Ol√°! Seja bem-vindo ao Consult√≥rio Dr. Carlos Silva! Sou a assistente virtual e estou aqui para ajudar voc√™ a agendar sua consulta. Como posso ajudar?">
                        <p>Ol√°! üëã Seja bem-vindo(a) ao Consult√≥rio Dr. Carlos Silva!</p>
                        <p class="mt-2">Sou a assistente virtual e estou aqui para ajudar voc√™ a agendar sua consulta.</p>
                        <p class="mt-2">Como posso ajudar?</p>
                        <div class="message-footer">
                            <span class="time">agora</span>
                            <button class="audio-btn" id="audio-msg-welcome" onclick="reproduzirAudio('msg-welcome', this)" title="Ouvir mensagem">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Sugest√µes iniciais -->
                    <div id="suggestions" class="text-center py-4">
                        <p class="text-sm text-gray-600 mb-3">Toque em uma op√ß√£o ou digite sua mensagem:</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            <button class="suggestion-chip" onclick="enviarSugestao('Ol√°, gostaria de agendar uma consulta')">
                                üìÖ Agendar consulta
                            </button>
                            <button class="suggestion-chip" onclick="enviarSugestao('Quais especialidades voc√™s atendem?')">
                                üè• Ver especialidades
                            </button>
                            <button class="suggestion-chip" onclick="enviarSugestao('Quais conv√™nios s√£o aceitos?')">
                                üí≥ Conv√™nios aceitos
                            </button>
                            <button class="suggestion-chip" onclick="enviarSugestao('Qual o hor√°rio de funcionamento?')">
                                üïê Hor√°rios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-container">
                    <button class="mic-btn" id="btnMic" onclick="toggleGravacao()" title="Gravar √°udio">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <input
                        type="text"
                        id="chatInput"
                        class="chat-input"
                        placeholder="Digite ou grave um √°udio..."
                        onkeypress="if(event.key === 'Enter') enviarMensagem()"
                    >
                    <button class="chat-send-btn" onclick="enviarMensagem()" id="btnEnviar">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- Footer info -->
            <div class="bg-gray-100 px-4 py-2 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Este √© um simulador. No sistema real, a conversa ocorre via WhatsApp.
                </p>
            </div>
        </div>
    </div>

    <!-- Tour Completo Button -->
    <button onclick="iniciarTour()" class="fixed bottom-6 right-6 w-14 h-14 bg-purple-600 text-white rounded-full shadow-lg hover:bg-purple-700 transition flex items-center justify-center z-40" title="Iniciar tour guiado">
        <i class="fas fa-question text-xl"></i>
    </button>

    <script>
        // Verificar autentica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const medico = localStorage.getItem('medico');

            if (!token) {
                window.location.href = '/static/demo/index.html';
                return;
            }

            // Sincronizar token para authToken (compatibilidade com calend√°rio)
            if (!localStorage.getItem('authToken') && token) {
                localStorage.setItem('authToken', token);
            }

            // Sincronizar medico para userData (compatibilidade com dashboard anal√≠tico)
            if (!localStorage.getItem('userData') && medico) {
                localStorage.setItem('userData', medico);
            }

            if (medico) {
                const medicoData = JSON.parse(medico);
                document.getElementById('userName').textContent = medicoData.nome || 'Dr. Carlos Silva';
            }

            carregarAgendaHoje();
            carregarConveniosDemo();

            // Iniciar tour automaticamente na primeira visita
            const tourDone = localStorage.getItem('demo_tour_done');
            if (tourDone !== 'true') {
                setTimeout(() => {
                    iniciarTour();
                }, 1000);
            }
        });

        async function carregarAgendaHoje() {
            const container = document.getElementById('agendaHoje');
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');

            if (!token) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Fa√ßa login para ver a agenda</p>';
                return;
            }

            try {
                // Mostrar loading
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-purple-500 text-2xl"></i><p class="text-gray-500 mt-2">Carregando agenda...</p></div>';

                // Buscar agendamentos de hoje da API real
                const hoje = new Date();
                const mes = hoje.getMonth() + 1;
                const ano = hoje.getFullYear();

                const response = await fetch(`/api/agendamentos/calendario?mes=${mes}&ano=${ano}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar agendamentos');
                }

                const data = await response.json();
                const todosEventos = data.eventos || data || [];

                // Filtrar apenas agendamentos de hoje (usando data local)
                const hojeStr = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}-${String(hoje.getDate()).padStart(2, '0')}`;

                const agendamentosHoje = todosEventos.filter(evento => {
                    const dataEvento = new Date(evento.start);
                    const dataEventoStr = `${dataEvento.getFullYear()}-${String(dataEvento.getMonth() + 1).padStart(2, '0')}-${String(dataEvento.getDate()).padStart(2, '0')}`;
                    return dataEventoStr === hojeStr;
                }).sort((a, b) => new Date(a.start) - new Date(b.start));

                if (agendamentosHoje.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-calendar-check text-gray-300 text-4xl mb-3"></i>
                            <p class="text-gray-500">Nenhum agendamento para hoje</p>
                            <button onclick="abrirAgendamento()" class="mt-3 text-purple-600 hover:text-purple-700 font-medium">
                                <i class="fas fa-plus mr-1"></i> Criar agendamento
                            </button>
                        </div>
                    `;
                    // Atualizar contadores
                    document.getElementById('consultasHoje').textContent = '0';
                    document.getElementById('confirmados').textContent = '0';
                    document.getElementById('pendentes').textContent = '0';
                    return;
                }

                // Renderizar agendamentos reais
                container.innerHTML = agendamentosHoje.map(evento => {
                    const dataEvento = new Date(evento.start);
                    const hora = `${dataEvento.getHours().toString().padStart(2, '0')}:${dataEvento.getMinutes().toString().padStart(2, '0')}`;
                    const paciente = evento.extendedProps?.paciente || evento.title?.split(' - ')[0] || 'Paciente';
                    const tipo = evento.extendedProps?.tipo || 'Consulta';
                    const status = evento.extendedProps?.status || 'agendado';
                    const telefone = evento.extendedProps?.telefone || '';

                    // Determinar badge de status
                    let statusBadge = '';
                    if (['confirmado', 'confirmada'].includes(status)) {
                        statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs"><i class="fas fa-check mr-1"></i>Confirmado</span>';
                    } else if (['realizado', 'realizada'].includes(status)) {
                        statusBadge = '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"><i class="fas fa-check-double mr-1"></i>Realizado</span>';
                    } else if (['cancelado', 'cancelada'].includes(status)) {
                        statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs"><i class="fas fa-times mr-1"></i>Cancelado</span>';
                    } else if (status === 'faltou') {
                        statusBadge = '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs"><i class="fas fa-user-slash mr-1"></i>Faltou</span>';
                    } else {
                        statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-xs"><i class="fas fa-clock mr-1"></i>Pendente</span>';
                    }

                    return `
                        <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition cursor-pointer" onclick="abrirDetalhesAgendamento(${evento.id})">
                            <div class="text-center min-w-[60px]">
                                <p class="text-lg font-bold text-gray-800">${hora}</p>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${paciente}</p>
                                <p class="text-sm text-gray-500">${tipo}${telefone ? ' ‚Ä¢ ' + telefone : ''}</p>
                            </div>
                            <div>
                                ${statusBadge}
                            </div>
                        </div>
                    `;
                }).join('');

                // Atualizar contadores
                const confirmados = agendamentosHoje.filter(e => ['confirmado', 'confirmada'].includes(e.extendedProps?.status)).length;
                const pendentes = agendamentosHoje.filter(e => ['agendado', 'agendada', 'pendente'].includes(e.extendedProps?.status)).length;

                document.getElementById('consultasHoje').textContent = agendamentosHoje.length;
                document.getElementById('confirmados').textContent = confirmados;
                document.getElementById('pendentes').textContent = pendentes;

            } catch (error) {
                console.error('Erro ao carregar agenda:', error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-red-400 text-3xl mb-3"></i>
                        <p class="text-gray-500">Erro ao carregar agenda</p>
                        <button onclick="carregarAgendaHoje()" class="mt-3 text-purple-600 hover:text-purple-700 font-medium">
                            <i class="fas fa-redo mr-1"></i> Tentar novamente
                        </button>
                    </div>
                `;
            }
        }

        // Carregar conv√™nios da API para o formul√°rio de agendamento
        async function carregarConveniosDemo() {
            const convenioSelect = document.getElementById('demo_tipo');
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');

            try {
                // Obter cliente_id do usu√°rio logado
                const medicoData = localStorage.getItem('medico');
                let clienteId = 3; // Default demo
                if (medicoData) {
                    try {
                        const medico = JSON.parse(medicoData);
                        clienteId = medico.cliente_id || 3;
                    } catch (e) {}
                }

                const response = await fetch(`/api/convenios?cliente_id=${clienteId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                convenioSelect.innerHTML = '<option value="">Selecione...</option>';

                // Adicionar "Particular" como primeira op√ß√£o
                const particularOption = document.createElement('option');
                particularOption.value = 'Particular';
                particularOption.textContent = 'Particular';
                convenioSelect.appendChild(particularOption);

                if (response.ok) {
                    const data = await response.json();

                    if (data.convenios && data.convenios.length > 0) {
                        // Filtrar "Particular" se estiver cadastrado como conv√™nio
                        const conveniosFiltrados = data.convenios.filter(c =>
                            c.codigo?.toLowerCase() !== 'particular' &&
                            c.nome?.toLowerCase() !== 'particular'
                        );

                        conveniosFiltrados.forEach(convenio => {
                            const option = document.createElement('option');
                            option.value = convenio.nome; // Usar nome como valor para manter compatibilidade
                            option.textContent = convenio.nome;
                            convenioSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar conv√™nios:', error);
                convenioSelect.innerHTML = '<option value="">Selecione...</option><option value="Particular">Particular</option>';
            }
        }

        // Fun√ß√£o para abrir detalhes (redireciona para o calend√°rio)
        function abrirDetalhesAgendamento(agendamentoId) {
            window.location.href = `/static/calendario-unificado.html?agendamento=${agendamentoId}`;
        }

        function iniciarTour() {
            introJs().setOptions({
                nextLabel: 'Pr√≥ximo ‚Üí',
                prevLabel: '‚Üê Anterior',
                doneLabel: 'Finalizar',
                skipLabel: 'Pular',
                showProgress: true,
                showBullets: true,
                exitOnOverlayClick: false,
                steps: [
                    {
                        intro: `
                            <div class="text-center">
                                <div class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center mb-4">
                                    <i class="fas fa-hand-sparkles text-white text-3xl"></i>
                                </div>
                                <h3 class="text-xl font-bold mb-2">Bem-vindo ao Tour!</h3>
                                <p class="text-gray-600">Vamos conhecer as principais funcionalidades do Hor√°rio Inteligente.</p>
                            </div>
                        `
                    }
                ]
            }).oncomplete(function() {
                localStorage.setItem('demo_tour_done', 'true');
            }).start();
        }

        function abrirAgendamento() {
            // Definir data m√≠nima como hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('demo_data').min = hoje;
            document.getElementById('demo_data').value = hoje;

            // Limpar formul√°rio
            document.getElementById('demo_paciente_nome').value = '';
            document.getElementById('demo_paciente_telefone').value = '';
            document.getElementById('demo_hora').value = '';
            document.getElementById('demo_motivo').value = '';
            document.getElementById('demo_erro').classList.add('hidden');

            document.getElementById('modalAgendamento').classList.remove('hidden');
            document.getElementById('modalAgendamento').classList.add('flex');
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
        }

        // ==========================================
        // M√ÅSCARA DE TELEFONE (WhatsApp)
        // ==========================================
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length > 11) valor = valor.substring(0, 11);

            if (valor.length > 0) valor = '(' + valor;
            if (valor.length > 3) valor = valor.substring(0, 3) + ') ' + valor.substring(3);
            if (valor.length > 10) valor = valor.substring(0, 10) + '-' + valor.substring(10);

            input.value = valor;
        }

        function validarTelefone(telefone) {
            return /^\([0-9]{2}\) [0-9]{5}-[0-9]{4}$/.test(telefone);
        }

        function extrairNumerosTelefone(telefone) {
            return telefone.replace(/\D/g, '');
        }

        // Inicializar m√°scara de telefone
        document.addEventListener('DOMContentLoaded', function() {
            const telefoneInput = document.getElementById('demo_paciente_telefone');
            if (telefoneInput) {
                telefoneInput.addEventListener('input', function() {
                    aplicarMascaraTelefone(this);
                });
                telefoneInput.addEventListener('paste', function() {
                    setTimeout(() => aplicarMascaraTelefone(this), 10);
                });
            }
        });

        // ==========================================
        // SALVAR AGENDAMENTO (API REAL)
        // ==========================================
        async function salvarAgendamento() {
            const erroDiv = document.getElementById('demo_erro');
            const erroMsg = document.getElementById('demo_erro_msg');
            const btnSalvar = document.getElementById('btnSalvarAgendamento');

            // Esconder erro anterior
            erroDiv.classList.add('hidden');

            // Obter valores
            const nome = document.getElementById('demo_paciente_nome').value.trim();
            const telefoneRaw = document.getElementById('demo_paciente_telefone').value.trim();
            const data = document.getElementById('demo_data').value;
            const hora = document.getElementById('demo_hora').value;
            const tipo = document.getElementById('demo_tipo').value;
            const motivo = document.getElementById('demo_motivo').value.trim() || 'Consulta';

            // Valida√ß√µes
            if (!nome) {
                erroMsg.textContent = 'Digite o nome do paciente';
                erroDiv.classList.remove('hidden');
                document.getElementById('demo_paciente_nome').focus();
                return;
            }

            if (!validarTelefone(telefoneRaw)) {
                erroMsg.textContent = 'Digite o telefone no formato (XX) XXXXX-XXXX';
                erroDiv.classList.remove('hidden');
                document.getElementById('demo_paciente_telefone').focus();
                return;
            }

            if (!data) {
                erroMsg.textContent = 'Selecione a data';
                erroDiv.classList.remove('hidden');
                return;
            }

            if (!hora) {
                erroMsg.textContent = 'Selecione o hor√°rio';
                erroDiv.classList.remove('hidden');
                return;
            }

            // Validar data/hora no passado
            const agora = new Date();
            const dataAgendamento = new Date(data + 'T' + hora);
            if (dataAgendamento < agora) {
                erroMsg.textContent = 'N√£o √© poss√≠vel agendar para datas ou hor√°rios passados';
                erroDiv.classList.remove('hidden');
                return;
            }

            // Obter token e m√©dico
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');
            const medicoData = localStorage.getItem('medico');
            let medicoId = 18; // Default Dr. Carlos

            if (medicoData) {
                try {
                    const medico = JSON.parse(medicoData);
                    medicoId = medico.id || 18;
                } catch (e) {}
            }

            // Mostrar loading
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agendando...';

            try {
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        paciente_nome: nome,
                        paciente_telefone: extrairNumerosTelefone(telefoneRaw),
                        medico_id: medicoId,
                        data: data,
                        hora: hora,
                        tipo_atendimento: tipo,
                        motivo_consulta: motivo
                    })
                });

                const result = await response.json();

                if (result.sucesso) {
                    // Sucesso!
                    fecharModal('modalAgendamento');
                    alert(`‚úÖ Agendamento criado com sucesso!\n\nPaciente: ${nome}\nData: ${data.split('-').reverse().join('/')}\nHor√°rio: ${hora}`);

                    // Recarregar agenda
                    carregarAgendaHoje();
                } else {
                    erroMsg.textContent = result.erro || result.detail || 'Erro ao criar agendamento';
                    erroDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                erroMsg.textContent = 'Erro de conex√£o. Tente novamente.';
                erroDiv.classList.remove('hidden');
            } finally {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = '<i class="fas fa-check"></i> Agendar';
            }
        }

        function mostrarInfo(titulo, texto) {
            document.getElementById('modalInfoTitulo').textContent = titulo;
            document.getElementById('modalInfoTexto').textContent = texto;
            document.getElementById('modalInfo').classList.remove('hidden');
            document.getElementById('modalInfo').classList.add('flex');
        }

        function abrirWhatsApp() {
            mostrarInfo('Integra√ß√£o WhatsApp', 'Envie mensagens, confirme consultas e receba respostas dos pacientes diretamente no sistema. Lembretes autom√°ticos 24h, 3h e 1h antes da consulta.');
        }

        function abrirRelatorios() {
            window.location.href = '/static/dashboard.html';
        }

        // ==================== CHAT SIMULATOR ====================
        let chatContext = [];  // Hist√≥rico de conversa para contexto
        let isProcessing = false;
        const DEMO_PHONE = 'demo-simulator-' + Date.now();  // ID √∫nico para esta sess√£o

        function abrirAssistente() {
            document.getElementById('modalChat').classList.remove('hidden');
            document.getElementById('modalChat').classList.add('flex');
            document.getElementById('chatInput').focus();
        }

        function enviarSugestao(texto) {
            document.getElementById('chatInput').value = texto;
            enviarMensagem();
            // Esconder sugest√µes ap√≥s primeira intera√ß√£o
            const suggestions = document.getElementById('suggestions');
            if (suggestions) {
                suggestions.style.display = 'none';
            }
        }

        async function enviarMensagem() {
            const input = document.getElementById('chatInput');
            const mensagem = input.value.trim();

            if (!mensagem || isProcessing) return;

            isProcessing = true;
            input.value = '';
            document.getElementById('btnEnviar').disabled = true;

            // Esconder sugest√µes
            const suggestions = document.getElementById('suggestions');
            if (suggestions) {
                suggestions.style.display = 'none';
            }

            // Adicionar mensagem do usu√°rio
            adicionarMensagem(mensagem, 'user');

            // Mostrar indicador de digita√ß√£o
            mostrarDigitando(true);

            try {
                // Chamar API de chat
                const response = await fetch('/api/chat/processar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mensagem: mensagem,
                        telefone: DEMO_PHONE,
                        cliente_id: 3,  // Cliente demo
                        contexto_conversa: chatContext
                    })
                });

                const data = await response.json();

                // Esconder indicador de digita√ß√£o
                mostrarDigitando(false);

                if (data.resposta) {
                    // Verificar se a resposta tem marcador de pausa (‚è≥)
                    // Isso indica que devemos dividir a mensagem com delay
                    if (data.resposta.includes('‚è≥')) {
                        await processarRespostaComPausa(data.resposta);
                    } else {
                        // Adicionar resposta da IA normalmente
                        adicionarMensagem(data.resposta, 'bot');
                    }

                    // Atualizar contexto (formato esperado pelo backend)
                    chatContext.push({
                        tipo: 'user',
                        texto: mensagem,
                        intencao: '',
                        dados_coletados: {}
                    });
                    chatContext.push({
                        tipo: 'assistant',
                        texto: data.resposta,
                        intencao: data.intencao || '',
                        dados_coletados: data.dados_coletados || {}
                    });

                    // Limitar contexto a √∫ltimas 20 mensagens
                    if (chatContext.length > 20) {
                        chatContext = chatContext.slice(-20);
                    }
                } else {
                    adicionarMensagem('Desculpe, ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.', 'bot');
                }
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                mostrarDigitando(false);
                adicionarMensagem('Ops! Parece que houve um problema de conex√£o. Por favor, tente novamente em alguns instantes.', 'bot');
            }

            isProcessing = false;
            document.getElementById('btnEnviar').disabled = false;
            input.focus();
        }

        // Vari√°vel global para controlar √°udio atual
        let currentAudio = null;
        let currentAudioBtn = null;
        let audioContextInitialized = false;

        // Inicializar AudioContext para evitar delay na primeira reprodu√ß√£o
        async function initAudioContext() {
            if (audioContextInitialized) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                // Criar um buffer de sil√™ncio curto para "aquecer" o sistema
                const buffer = ctx.createBuffer(1, ctx.sampleRate * 0.1, ctx.sampleRate);
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start();
                audioContextInitialized = true;
                console.log('üîä AudioContext inicializado');
            } catch (e) {
                console.log('AudioContext init:', e);
            }
        }

        function adicionarMensagem(texto, tipo, autoPlayAudio = false) {
            const container = document.getElementById('chatMessages');
            const agora = new Date();
            const hora = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const msgId = 'msg-' + Date.now();

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${tipo}`;

            if (tipo === 'bot') {
                // Mensagem do bot com bot√£o de √°udio
                bubble.innerHTML = `
                    <p>${formatarTexto(texto)}</p>
                    <div class="message-footer">
                        <span class="time">${hora}</span>
                        <button class="audio-btn" id="audio-${msgId}" onclick="reproduzirAudio('${msgId}', this)" title="Ouvir mensagem">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                `;
                // Armazenar texto original para TTS
                bubble.dataset.textoOriginal = texto;
                bubble.id = msgId;
            } else {
                // Mensagem do usu√°rio (sem bot√£o de √°udio)
                bubble.innerHTML = `
                    <p>${formatarTexto(texto)}</p>
                    <div class="time">${hora}</div>
                `;
            }

            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;

            // Auto-play √°udio se solicitado
            if (tipo === 'bot' && autoPlayAudio) {
                setTimeout(() => {
                    const audioBtn = document.getElementById(`audio-${msgId}`);
                    if (audioBtn) {
                        reproduzirAudio(msgId, audioBtn);
                    }
                }, 500);
            }
        }

        async function reproduzirAudio(msgId, btn) {
            // Inicializar AudioContext na primeira reprodu√ß√£o
            await initAudioContext();

            const bubble = document.getElementById(msgId);
            if (!bubble) return;

            const texto = bubble.dataset.textoOriginal;
            if (!texto) return;

            // Se j√° est√° tocando este √°udio, parar
            if (currentAudio && currentAudioBtn === btn) {
                currentAudio.pause();
                currentAudio = null;
                currentAudioBtn = null;
                btn.classList.remove('playing');
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                return;
            }

            // Parar √°udio anterior se houver
            if (currentAudio) {
                currentAudio.pause();
                if (currentAudioBtn) {
                    currentAudioBtn.classList.remove('playing');
                    currentAudioBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
            }

            // Mostrar loading
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Chamar API para gerar √°udio
                const response = await fetch('/api/chat/audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ texto: texto })
                });

                if (!response.ok) {
                    throw new Error('Erro ao gerar √°udio');
                }

                const data = await response.json();

                if (data.status === 'success' && data.audio) {
                    // Criar elemento de √°udio
                    const audioBlob = base64ToBlob(data.audio, 'audio/mpeg');
                    const audioUrl = URL.createObjectURL(audioBlob);

                    currentAudio = new Audio();
                    currentAudio.preload = 'auto';
                    currentAudioBtn = btn;

                    // Configurar eventos
                    currentAudio.onplay = () => {
                        btn.classList.remove('loading');
                        btn.classList.add('playing');
                        btn.innerHTML = '<i class="fas fa-stop"></i>';
                        btn.disabled = false;
                    };

                    currentAudio.onended = () => {
                        btn.classList.remove('playing');
                        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        currentAudio = null;
                        currentAudioBtn = null;
                        URL.revokeObjectURL(audioUrl);
                    };

                    currentAudio.onerror = () => {
                        btn.classList.remove('loading', 'playing');
                        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                        btn.disabled = false;
                        console.error('Erro ao reproduzir √°udio');
                    };

                    // Aguardar carregamento completo antes de reproduzir
                    currentAudio.oncanplaythrough = () => {
                        // Delay para garantir buffer est√°vel
                        setTimeout(async () => {
                            try {
                                await currentAudio.play();
                            } catch (e) {
                                console.error('Erro ao iniciar reprodu√ß√£o:', e);
                            }
                        }, 250);
                    };

                    // Definir fonte e iniciar carregamento
                    currentAudio.src = audioUrl;
                    currentAudio.load();
                } else {
                    throw new Error('Resposta inv√°lida da API');
                }

            } catch (error) {
                console.error('Erro ao reproduzir √°udio:', error);
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.disabled = false;

                // Mostrar erro brevemente
                btn.title = 'Erro ao carregar √°udio. Tente novamente.';
                setTimeout(() => {
                    btn.title = 'Ouvir mensagem';
                }, 3000);
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // ==================== GRAVA√á√ÉO DE √ÅUDIO ====================
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer = null;
        let recordingSeconds = 0;

        async function toggleGravacao() {
            if (isRecording) {
                pararGravacao();
            } else {
                await iniciarGravacao();
            }
        }

        async function iniciarGravacao() {
            try {
                // Solicitar permiss√£o do microfone
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                // Configurar MediaRecorder
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });

                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = async () => {
                    // Parar todas as tracks do stream
                    stream.getTracks().forEach(track => track.stop());

                    // Processar √°udio gravado
                    await processarAudioGravado();
                };

                // Iniciar grava√ß√£o
                mediaRecorder.start(100); // Capturar a cada 100ms
                isRecording = true;

                // Atualizar UI
                const btnMic = document.getElementById('btnMic');
                btnMic.classList.add('recording');
                btnMic.innerHTML = '<i class="fas fa-stop"></i>';
                btnMic.title = 'Parar grava√ß√£o';

                // Mostrar indicador de grava√ß√£o
                const input = document.getElementById('chatInput');
                input.placeholder = 'üî¥ Gravando...';
                input.disabled = true;

                // Timer de grava√ß√£o (m√°ximo 60 segundos)
                recordingSeconds = 0;
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    input.placeholder = `üî¥ Gravando... ${recordingSeconds}s`;
                    if (recordingSeconds >= 60) {
                        pararGravacao();
                    }
                }, 1000);

                console.log('üé§ Grava√ß√£o iniciada');

            } catch (error) {
                console.error('Erro ao acessar microfone:', error);

                let mensagemErro = 'N√£o foi poss√≠vel acessar o microfone.';
                if (error.name === 'NotAllowedError') {
                    mensagemErro = 'Permiss√£o de microfone negada. Por favor, permita o acesso ao microfone nas configura√ß√µes do navegador.';
                } else if (error.name === 'NotFoundError') {
                    mensagemErro = 'Nenhum microfone encontrado no dispositivo.';
                }

                alert(mensagemErro);
            }
        }

        function pararGravacao() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                // Parar timer
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }

                // Atualizar UI para processando
                const btnMic = document.getElementById('btnMic');
                btnMic.classList.remove('recording');
                btnMic.classList.add('processing');
                btnMic.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btnMic.title = 'Processando...';
                btnMic.disabled = true;

                const input = document.getElementById('chatInput');
                input.placeholder = 'Transcrevendo √°udio...';

                console.log('üé§ Grava√ß√£o parada, processando...');
            }
        }

        async function processarAudioGravado() {
            const btnMic = document.getElementById('btnMic');
            const input = document.getElementById('chatInput');

            try {
                // Criar blob do √°udio
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                if (audioBlob.size < 1000) {
                    throw new Error('√Åudio muito curto');
                }

                console.log(`üìä Tamanho do √°udio: ${audioBlob.size} bytes`);

                // Converter para base64
                const base64Audio = await blobToBase64(audioBlob);

                // Enviar para transcri√ß√£o
                const response = await fetch('/api/chat/audio/transcrever', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        audio: base64Audio.split(',')[1] // Remover prefixo data:audio/webm;base64,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Erro ao transcrever');
                }

                const data = await response.json();

                if (data.status === 'success' && data.texto) {
                    console.log(`‚úÖ Transcrito: "${data.texto}"`);

                    // Colocar texto no input e enviar
                    input.value = data.texto;

                    // Resetar UI
                    resetarUIGravacao();

                    // Enviar mensagem automaticamente
                    enviarMensagem();

                } else {
                    throw new Error(data.message || 'Nenhuma fala detectada');
                }

            } catch (error) {
                console.error('Erro ao processar √°udio:', error);

                // Mostrar erro
                alert(`N√£o foi poss√≠vel transcrever o √°udio: ${error.message}`);

                // Resetar UI
                resetarUIGravacao();
            }
        }

        function resetarUIGravacao() {
            const btnMic = document.getElementById('btnMic');
            const input = document.getElementById('chatInput');

            btnMic.classList.remove('recording', 'processing');
            btnMic.innerHTML = '<i class="fas fa-microphone"></i>';
            btnMic.title = 'Gravar √°udio';
            btnMic.disabled = false;

            input.placeholder = 'Digite ou grave um √°udio...';
            input.disabled = false;
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        // ==================== FIM GRAVA√á√ÉO DE √ÅUDIO ====================

        function formatarTexto(texto) {
            // Converter quebras de linha em <br>
            return texto
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Negrito
                .replace(/\*(.*?)\*/g, '<em>$1</em>');  // It√°lico
        }

        async function processarRespostaComPausa(resposta) {
            // Divide a resposta no marcador ‚è≥
            const partes = resposta.split('‚è≥');

            if (partes.length >= 2) {
                // Primeira parte: "Um momentinho, vou verificar..."
                const primeiraParte = partes[0].trim();
                if (primeiraParte) {
                    adicionarMensagem(primeiraParte, 'bot');
                }

                // Mostrar indicador de digita√ß√£o durante a "verifica√ß√£o"
                mostrarDigitando(true);

                // Aguardar 2.5 segundos (simulando verifica√ß√£o)
                await new Promise(resolve => setTimeout(resolve, 2500));

                // Esconder indicador
                mostrarDigitando(false);

                // Segunda parte: "Voc√™ est√° com sorte!..."
                const segundaParte = partes.slice(1).join('').trim();
                if (segundaParte) {
                    adicionarMensagem(segundaParte, 'bot');
                }
            } else {
                // Sem marcador, adiciona normalmente
                adicionarMensagem(resposta, 'bot');
            }
        }

        function mostrarDigitando(mostrar) {
            const container = document.getElementById('chatMessages');
            const existente = document.getElementById('typingIndicator');

            if (mostrar) {
                if (!existente) {
                    const typing = document.createElement('div');
                    typing.id = 'typingIndicator';
                    typing.className = 'typing-indicator';
                    typing.innerHTML = '<span></span><span></span><span></span>';
                    container.appendChild(typing);
                    container.scrollTop = container.scrollHeight;
                }
                document.getElementById('chatStatus').textContent = 'digitando...';
            } else {
                if (existente) {
                    existente.remove();
                }
                document.getElementById('chatStatus').textContent = 'online';
            }
        }

        function reiniciarChat() {
            chatContext = [];
            // Parar √°udio se estiver tocando
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                currentAudioBtn = null;
            }
            const container = document.getElementById('chatMessages');
            container.innerHTML = `
                <div class="chat-bubble bot" id="msg-welcome" data-texto-original="Ol√°! Seja bem-vindo ao Consult√≥rio Dr. Carlos Silva! Sou a assistente virtual e estou aqui para ajudar voc√™ a agendar sua consulta. Como posso ajudar?">
                    <p>Ol√°! üëã Seja bem-vindo(a) ao Consult√≥rio Dr. Carlos Silva!</p>
                    <p class="mt-2">Sou a assistente virtual e estou aqui para ajudar voc√™ a agendar sua consulta.</p>
                    <p class="mt-2">Como posso ajudar?</p>
                    <div class="message-footer">
                        <span class="time">agora</span>
                        <button class="audio-btn" id="audio-msg-welcome" onclick="reproduzirAudio('msg-welcome', this)" title="Ouvir mensagem">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                </div>
                <div id="suggestions" class="text-center py-4">
                    <p class="text-sm text-gray-600 mb-3">Toque em uma op√ß√£o ou digite sua mensagem:</p>
                    <div class="flex flex-wrap justify-center gap-2">
                        <button class="suggestion-chip" onclick="enviarSugestao('Ol√°, gostaria de agendar uma consulta')">
                            üìÖ Agendar consulta
                        </button>
                        <button class="suggestion-chip" onclick="enviarSugestao('Quais especialidades voc√™s atendem?')">
                            üè• Ver especialidades
                        </button>
                        <button class="suggestion-chip" onclick="enviarSugestao('Quais conv√™nios s√£o aceitos?')">
                            üí≥ Conv√™nios aceitos
                        </button>
                        <button class="suggestion-chip" onclick="enviarSugestao('Qual o hor√°rio de funcionamento?')">
                            üïê Hor√°rios
                        </button>
                    </div>
                </div>
            `;
        }
        // ==================== FIM CHAT SIMULATOR ====================

        function abrirCalendario() {
            window.location.href = '/static/calendario-unificado.html';
        }

        function abrirDashboardAnalitico() {
            window.location.href = '/static/dashboard.html';
        }

        function abrirConfiguracoes() {
            window.location.href = '/static/configuracoes.html';
        }

        function abrirPerfil() {
            window.location.href = '/static/perfil.html';
        }

        function voltarDemo() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('medico');
            localStorage.removeItem('cliente_id');
            localStorage.removeItem('demo_mode');
            window.location.href = '/static/demo/index.html';
        }
    </script>

    <!-- Design System Scripts -->
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/components/modal.js"></script>
    <script src="/static/js/components/empty-state.js"></script>
    <script src="/static/js/components/bottom-nav.js"></script>
    <script src="/static/js/components/pull-refresh.js"></script>
    <script src="/static/js/components/guided-tour.js"></script>
    <script src="/static/js/components/hero-demo.js"></script>
    <script src="/static/js/hi-design-system.js"></script>

    <!-- Mobile & Demo Integration -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializa Bottom Navigation para demo
            if (typeof HiBottomNav !== 'undefined') {
                HiBottomNav.init({
                    activeId: 'dashboard',
                    items: [
                        { id: 'agenda', label: 'Agenda', icon: 'fa-calendar-alt', onClick: () => abrirCalendario() },
                        { id: 'config', label: 'Config', icon: 'fa-cog', onClick: () => abrirConfiguracoes() },
                        { id: 'novo', label: 'Novo', icon: 'fa-plus', primary: true, onClick: () => abrirAgendamento() },
                        { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line', onClick: () => abrirDashboardAnalitico() },
                        { id: 'chat', label: 'WhatsApp', icon: 'fa-whatsapp', onClick: () => abrirWhatsApp() }
                    ]
                });
            }

            // Inicializa Pull-to-Refresh
            if (typeof HiPullRefresh !== 'undefined') {
                HiPullRefresh.init({
                    onRefresh: async () => {
                        // Simula atualiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        if (typeof HiToast !== 'undefined') {
                            HiToast.success('Demo atualizada!');
                        }
                    }
                });
            }

            // Substitui fun√ß√£o de tour pela nova implementa√ß√£o
            window.iniciarTour = function() {
                if (typeof HiGuidedTour !== 'undefined') {
                    HiGuidedTour.start({
                        steps: [
                            {
                                element: 'header',
                                title: 'Bem-vindo ao Hor√°rio Inteligente!',
                                content: 'Este √© o painel principal do m√©dico. Aqui voc√™ acompanha toda sua agenda e m√©tricas.',
                                position: 'bottom'
                            },
                            {
                                element: '.stat-card:first-child',
                                title: 'M√©tricas do Dia',
                                content: 'Visualize rapidamente quantas consultas voc√™ tem hoje, quantas foram confirmadas e quantas est√£o pendentes.',
                                position: 'bottom'
                            },
                            {
                                element: '#agendaHoje',
                                title: 'Agenda do Dia',
                                content: 'Lista completa dos seus atendimentos. Clique em qualquer consulta para ver detalhes ou gerenciar.',
                                position: 'top'
                            },
                            {
                                element: '.lg\\:col-span-1',
                                title: 'A√ß√µes R√°pidas',
                                content: 'Acesse rapidamente: novo agendamento, WhatsApp, relat√≥rios e configura√ß√µes.',
                                position: 'left'
                            },
                            {
                                element: '#chatContainer',
                                title: 'Simulador WhatsApp',
                                content: 'Experimente como seus pacientes agendam via WhatsApp. A IA responde automaticamente 24/7!',
                                position: 'top'
                            }
                        ],
                        onComplete: () => {
                            if (typeof HiToast !== 'undefined') {
                                HiToast.success('Tour conclu√≠do! Explore √† vontade.');
                            }
                        }
                    });
                } else if (typeof introJs !== 'undefined') {
                    // Fallback para Intro.js original
                    introJs().setOptions({
                        nextLabel: 'Pr√≥ximo ‚Üí',
                        prevLabel: '‚Üê Anterior',
                        doneLabel: 'Concluir',
                        skipLabel: 'Pular'
                    }).start();
                }
            };

            // Auto-inicia tour para novos visitantes
            const tourShown = localStorage.getItem('demo_tour_shown');
            if (!tourShown) {
                setTimeout(() => {
                    if (typeof HiToast !== 'undefined') {
                        HiToast.info('Primeira vez aqui? Clique em "Fazer tour guiado" no banner superior!');
                    }
                }, 2000);
            }
        });
    </script>
</body>
</html>
