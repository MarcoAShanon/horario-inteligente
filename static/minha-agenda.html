<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda - Horário Inteligente</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Agendamento e Gestão de Consultas para Clínicas">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Horário Inteligente">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .card {
            transition: all 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8">
            <div class="flex justify-between h-14 sm:h-16">
                <div class="flex items-center min-w-0 flex-1">
                    <i class="fas fa-calendar-check text-blue-600 text-lg sm:text-2xl mr-2 sm:mr-3"></i>
                    <span class="text-sm sm:text-lg md:text-xl font-bold text-gray-800 truncate">
                        <span class="hidden sm:inline">Minha Agenda - Horário Inteligente</span>
                        <span class="sm:hidden">Minha Agenda</span>
                    </span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <span class="text-xs sm:text-sm text-gray-600 hidden md:inline truncate max-w-[150px]" id="userName">Carregando...</span>
                    <button onclick="window.location.href='/static/calendario-unificado.html'" class="bg-blue-500 text-white px-2 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded hover:bg-blue-600 whitespace-nowrap">
                        <i class="fas fa-calendar-alt sm:mr-2"></i>
                        <span class="hidden sm:inline">Calendário</span>
                    </button>
                    <button onclick="logout()" class="bg-red-500 text-white px-2 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded hover:bg-red-600 whitespace-nowrap">
                        <i class="fas fa-sign-out-alt sm:mr-2"></i>
                        <span class="hidden sm:inline">Sair</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-8">
        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-md mb-4 sm:mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px overflow-x-auto">
                    <button onclick="showTab('configuracoes')" id="tab-configuracoes" class="tab-active px-3 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm whitespace-nowrap">
                        <i class="fas fa-cog sm:mr-2"></i>
                        <span class="hidden sm:inline">Configurações</span>
                    </button>
                    <button onclick="showTab('horarios')" id="tab-horarios" class="px-3 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        <i class="fas fa-clock sm:mr-2"></i>
                        <span class="hidden sm:inline">Horários</span>
                    </button>
                    <button onclick="showTab('bloqueios')" id="tab-bloqueios" class="px-3 sm:px-6 py-2 sm:py-3 text-xs sm:text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                        <i class="fas fa-ban sm:mr-2"></i>
                        <span class="hidden sm:inline">Bloqueios</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab: Configurações -->
        <div id="content-configuracoes" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 md:p-6">
                <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-4 sm:mb-6">Configurações da Agenda</h2>

                <form id="formConfiguracoes" onsubmit="salvarConfiguracoes(event)" class="space-y-4 sm:space-y-6">
                    <!-- Duração da Consulta -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                            Duração da Consulta (minutos)
                        </label>
                        <input type="number" id="intervalo_consulta" min="15" max="120" step="15"
                            class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <!-- Horário de Trabalho Geral -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Horário Início Padrão
                            </label>
                            <input type="time" id="horario_inicio"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Horário Fim Padrão
                            </label>
                            <input type="time" id="horario_fim"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Intervalo de Almoço -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Almoço Início
                            </label>
                            <input type="time" id="intervalo_almoco_inicio"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Almoço Fim
                            </label>
                            <input type="time" id="intervalo_almoco_fim"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Antecedência -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Antecedência Mínima (minutos)
                            </label>
                            <input type="number" id="antecedencia_minima" min="0"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                                Antecedência Máxima (horas)
                            </label>
                            <input type="number" id="antecedencia_maxima" min="0"
                                class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Lembretes -->
                    <div class="space-y-2 sm:space-y-3">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700">Lembretes Automáticos</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="lembrete_24h" class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600 rounded">
                            <label for="lembrete_24h" class="ml-2 text-xs sm:text-sm text-gray-700">Enviar lembrete 24h antes</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="lembrete_2h" class="w-3 h-3 sm:w-4 sm:h-4 text-blue-600 rounded">
                            <label for="lembrete_2h" class="ml-2 text-xs sm:text-sm text-gray-700">Enviar lembrete 2h antes</label>
                        </div>
                    </div>

                    <!-- Botão Salvar -->
                    <div class="flex justify-end">
                        <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white px-4 sm:px-6 py-2 text-sm rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Salvar Configurações
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Horários -->
        <div id="content-horarios" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 md:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold">Horários de Atendimento</h2>
                    <button onclick="abrirModalHorario()" class="w-full sm:w-auto bg-blue-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg hover:bg-blue-700 whitespace-nowrap">
                        <i class="fas fa-plus mr-1 sm:mr-2"></i>Adicionar Horário
                    </button>
                </div>

                <div id="listaHorarios" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    <!-- Horários serão carregados aqui -->
                </div>
            </div>
        </div>

        <!-- Tab: Bloqueios -->
        <div id="content-bloqueios" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-4 md:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 sm:mb-6">
                    <h2 class="text-lg sm:text-xl md:text-2xl font-bold">Bloqueios de Agenda</h2>
                    <button onclick="abrirModalBloqueio()" class="w-full sm:w-auto bg-blue-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm rounded-lg hover:bg-blue-700 whitespace-nowrap">
                        <i class="fas fa-plus mr-1 sm:mr-2"></i>Adicionar Bloqueio
                    </button>
                </div>

                <div id="listaBloqueios" class="space-y-3 sm:space-y-4">
                    <!-- Bloqueios serão carregados aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar Horário -->
    <div id="modalHorario" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full max-w-sm sm:w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h3 class="text-base sm:text-lg font-bold">Adicionar Horário</h3>
                <button onclick="fecharModalHorario()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="salvarHorario(event)" class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Dia da Semana</label>
                    <select id="dia_semana" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                        <option value="1">Segunda-feira</option>
                        <option value="2">Terça-feira</option>
                        <option value="3">Quarta-feira</option>
                        <option value="4">Quinta-feira</option>
                        <option value="5">Sexta-feira</option>
                        <option value="6">Sábado</option>
                        <option value="7">Domingo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Horário Início</label>
                    <input type="time" id="hora_inicio_horario" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Horário Fim</label>
                    <input type="time" id="hora_fim_horario" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                </div>
                <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-0 sm:space-x-2">
                    <button type="button" onclick="fecharModalHorario()" class="w-full sm:w-auto px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-gray-300 rounded-lg hover:bg-gray-400 order-2 sm:order-1">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 order-1 sm:order-2">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar Bloqueio -->
    <div id="modalBloqueio" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full max-w-sm sm:w-96 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-3 sm:mb-4">
                <h3 class="text-base sm:text-lg font-bold">Adicionar Bloqueio</h3>
                <button onclick="fecharModalBloqueio()" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="salvarBloqueio(event)" class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Data/Hora Início</label>
                    <input type="datetime-local" id="data_inicio_bloqueio" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Data/Hora Fim</label>
                    <input type="datetime-local" id="data_fim_bloqueio" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Motivo</label>
                    <input type="text" id="motivo_bloqueio" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Tipo</label>
                    <select id="tipo_bloqueio" class="w-full px-3 sm:px-4 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg">
                        <option value="ferias">Férias</option>
                        <option value="almoco">Almoço</option>
                        <option value="bloqueio">Bloqueio</option>
                        <option value="emergencia">Emergência</option>
                    </select>
                </div>
                <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-0 sm:space-x-2">
                    <button type="button" onclick="fecharModalBloqueio()" class="w-full sm:w-auto px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-gray-300 rounded-lg hover:bg-gray-400 order-2 sm:order-1">
                        Cancelar
                    </button>
                    <button type="submit" class="w-full sm:w-auto px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 order-1 sm:order-2">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Aviso de Conflitos -->
    <div id="modalConflitos" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-10 mx-auto p-4 sm:p-5 border w-full max-w-lg sm:max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">Atenção: Agendamentos Conflitantes</h3>
                </div>
                <p class="text-sm text-gray-600">Existem agendamentos no período selecionado. Deseja continuar e cancelar estes agendamentos?</p>
            </div>

            <div id="listaConflitos" class="max-h-60 overflow-y-auto mb-4 space-y-2">
                <!-- Conflitos serão listados aqui -->
            </div>

            <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-0 sm:space-x-2 pt-4 border-t">
                <button onclick="fecharModalConflitos()" class="w-full sm:w-auto px-4 py-2 text-sm bg-gray-300 rounded-lg hover:bg-gray-400">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </button>
                <button onclick="confirmarBloqueioComCancelamento()" class="w-full sm:w-auto px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700">
                    <i class="fas fa-check mr-2"></i>Sim, Bloquear e Cancelar Agendamentos
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let medicoId = null;

        // ==================== AUTENTICAÇÃO ====================
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Token inválido');

                currentUser = await response.json();
                medicoId = currentUser.id;
                document.getElementById('userName').textContent = `Dr(a). ${currentUser.nome}`;

                // Carregar dados iniciais
                carregarConfiguracoes();
                carregarHorarios();
                carregarBloqueios();

            } catch (error) {
                console.error('Erro na autenticação:', error);
                localStorage.removeItem('authToken');
                window.location.href = '/static/login.html';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/static/login.html';
        }

        // ==================== TABS ====================
        function showTab(tabName) {
            // Ocultar todos os conteúdos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remover estilo ativo de todas as tabs
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            // Mostrar conteúdo selecionado
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            // Ativar tab selecionada
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');
        }

        // ==================== CONFIGURAÇÕES ====================
        async function carregarConfiguracoes() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/medicos/${medicoId}/configuracoes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.sucesso) {
                    const config = data.configuracoes;
                    document.getElementById('intervalo_consulta').value = config.intervalo_consulta || 30;
                    document.getElementById('horario_inicio').value = config.horario_inicio || '08:00';
                    document.getElementById('horario_fim').value = config.horario_fim || '18:00';
                    document.getElementById('intervalo_almoco_inicio').value = config.intervalo_almoco_inicio || '';
                    document.getElementById('intervalo_almoco_fim').value = config.intervalo_almoco_fim || '';
                    document.getElementById('antecedencia_minima').value = config.antecedencia_minima || 60;
                    document.getElementById('antecedencia_maxima').value = config.antecedencia_maxima || 8760;
                    document.getElementById('lembrete_24h').checked = config.lembrete_24h !== false;
                    document.getElementById('lembrete_2h').checked = config.lembrete_2h !== false;
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                alert('Erro ao carregar configurações');
            }
        }

        async function salvarConfiguracoes(event) {
            event.preventDefault();

            try {
                const token = localStorage.getItem('authToken');
                const dados = {
                    intervalo_consulta: parseInt(document.getElementById('intervalo_consulta').value),
                    horario_inicio: document.getElementById('horario_inicio').value,
                    horario_fim: document.getElementById('horario_fim').value,
                    intervalo_almoco_inicio: document.getElementById('intervalo_almoco_inicio').value || null,
                    intervalo_almoco_fim: document.getElementById('intervalo_almoco_fim').value || null,
                    antecedencia_minima: parseInt(document.getElementById('antecedencia_minima').value),
                    antecedencia_maxima: parseInt(document.getElementById('antecedencia_maxima').value),
                    lembrete_24h: document.getElementById('lembrete_24h').checked,
                    lembrete_2h: document.getElementById('lembrete_2h').checked
                };

                const response = await fetch(`/api/medicos/${medicoId}/configuracoes`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();
                if (result.sucesso) {
                    alert('Configurações salvas com sucesso!');
                } else {
                    alert('Erro ao salvar configurações');
                }
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                alert('Erro ao salvar configurações');
            }
        }

        // ==================== HORÁRIOS ====================
        async function carregarHorarios() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/medicos/${medicoId}/horarios`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.sucesso) {
                    renderizarHorarios(data.horarios);
                }
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
            }
        }

        function renderizarHorarios(horarios) {
            const container = document.getElementById('listaHorarios');
            if (horarios.length === 0) {
                container.innerHTML = '<p class="col-span-3 text-center text-gray-500">Nenhum horário cadastrado</p>';
                return;
            }

            container.innerHTML = horarios.map(h => `
                <div class="card bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${h.dia_semana_nome}</h3>
                        <button onclick="deletarHorario(${h.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <p class="text-gray-600">
                        <i class="fas fa-clock mr-2"></i>
                        ${h.hora_inicio} - ${h.hora_fim}
                    </p>
                </div>
            `).join('');
        }

        function abrirModalHorario() {
            document.getElementById('modalHorario').classList.remove('hidden');
        }

        function fecharModalHorario() {
            document.getElementById('modalHorario').classList.add('hidden');
            document.getElementById('dia_semana').value = '1';
            document.getElementById('hora_inicio_horario').value = '';
            document.getElementById('hora_fim_horario').value = '';
        }

        async function salvarHorario(event) {
            event.preventDefault();

            try {
                const token = localStorage.getItem('authToken');
                const dados = {
                    dia_semana: parseInt(document.getElementById('dia_semana').value),
                    hora_inicio: document.getElementById('hora_inicio_horario').value,
                    hora_fim: document.getElementById('hora_fim_horario').value
                };

                const response = await fetch(`/api/medicos/${medicoId}/horarios`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                const result = await response.json();
                if (result.sucesso) {
                    fecharModalHorario();
                    carregarHorarios();
                    alert('Horário adicionado com sucesso!');
                } else {
                    alert('Erro ao adicionar horário');
                }
            } catch (error) {
                console.error('Erro ao salvar horário:', error);
                alert('Erro ao salvar horário');
            }
        }

        async function deletarHorario(horarioId) {
            if (!confirm('Deseja realmente remover este horário?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/medicos/${medicoId}/horarios/${horarioId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (result.sucesso) {
                    carregarHorarios();
                    alert('Horário removido com sucesso!');
                } else {
                    alert('Erro ao remover horário');
                }
            } catch (error) {
                console.error('Erro ao deletar horário:', error);
                alert('Erro ao deletar horário');
            }
        }

        // ==================== BLOQUEIOS ====================
        async function carregarBloqueios() {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/medicos/${medicoId}/bloqueios`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.sucesso) {
                    renderizarBloqueios(data.bloqueios);
                }
            } catch (error) {
                console.error('Erro ao carregar bloqueios:', error);
            }
        }

        function renderizarBloqueios(bloqueios) {
            const container = document.getElementById('listaBloqueios');
            if (bloqueios.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhum bloqueio cadastrado</p>';
                return;
            }

            container.innerHTML = bloqueios.map(b => `
                <div class="card bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">${b.tipo}</span>
                                <span class="ml-2 font-semibold text-gray-800">${b.motivo}</span>
                            </div>
                            <p class="text-gray-600 text-sm">
                                <i class="fas fa-calendar mr-2"></i>
                                ${new Date(b.data_inicio).toLocaleString('pt-BR')} - ${new Date(b.data_fim).toLocaleString('pt-BR')}
                            </p>
                        </div>
                        <button onclick="deletarBloqueio(${b.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function abrirModalBloqueio() {
            document.getElementById('modalBloqueio').classList.remove('hidden');
        }

        function fecharModalBloqueio() {
            document.getElementById('modalBloqueio').classList.add('hidden');
        }

        // Armazena os dados do bloqueio temporariamente
        let bloqueioTempData = null;

        async function salvarBloqueio(event) {
            event.preventDefault();

            try {
                const token = localStorage.getItem('authToken');
                const dados = {
                    data_inicio: document.getElementById('data_inicio_bloqueio').value.replace('T', ' ') + ':00',
                    data_fim: document.getElementById('data_fim_bloqueio').value.replace('T', ' ') + ':00',
                    motivo: document.getElementById('motivo_bloqueio').value,
                    tipo: document.getElementById('tipo_bloqueio').value
                };

                // Armazenar dados temporariamente
                bloqueioTempData = dados;

                // PASSO 1: Validar conflitos
                const dataInicio = document.getElementById('data_inicio_bloqueio').value.replace('T', ' ') + ':00';
                const dataFim = document.getElementById('data_fim_bloqueio').value.replace('T', ' ') + ':00';

                const validacaoResponse = await fetch(
                    `/api/medicos/${medicoId}/bloqueios/validar?data_inicio=${encodeURIComponent(dataInicio)}&data_fim=${encodeURIComponent(dataFim)}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );

                const validacao = await validacaoResponse.json();

                // Se há conflitos, mostrar modal de aviso
                if (validacao.tem_conflito) {
                    mostrarModalConflitos(validacao.agendamentos_conflitantes);
                    return;
                }

                // Se não há conflitos, criar bloqueio diretamente
                await criarBloqueio(false);

            } catch (error) {
                console.error('Erro ao salvar bloqueio:', error);
                alert('Erro ao salvar bloqueio: ' + error.message);
            }
        }

        async function criarBloqueio(force = false) {
            try {
                const token = localStorage.getItem('authToken');

                const url = force
                    ? `/api/medicos/${medicoId}/bloqueios?force=true`
                    : `/api/medicos/${medicoId}/bloqueios`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bloqueioTempData)
                });

                const result = await response.json();

                if (result.sucesso) {
                    fecharModalBloqueio();
                    fecharModalConflitos();
                    carregarBloqueios();

                    if (result.agendamentos_cancelados && result.agendamentos_cancelados.length > 0) {
                        alert(`✅ Bloqueio criado com sucesso!\n${result.agendamentos_cancelados.length} agendamento(s) foram cancelados.`);
                    } else {
                        alert('✅ Bloqueio adicionado com sucesso!');
                    }
                } else {
                    alert('❌ Erro ao adicionar bloqueio: ' + (result.mensagem || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao criar bloqueio:', error);
                alert('❌ Erro ao criar bloqueio: ' + error.message);
            }
        }

        function mostrarModalConflitos(conflitos) {
            const listaConflitos = document.getElementById('listaConflitos');

            listaConflitos.innerHTML = conflitos.map(ag => `
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                    <div class="flex items-start gap-2">
                        <i class="fas fa-calendar-times text-yellow-600 mt-1"></i>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800">${ag.paciente_nome}</p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-clock mr-1"></i>
                                ${new Date(ag.data_hora).toLocaleString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                            ${ag.motivo_consulta ? `
                                <p class="text-xs text-gray-600 mt-1">
                                    <i class="fas fa-notes-medical mr-1"></i>
                                    ${ag.motivo_consulta}
                                </p>
                            ` : ''}
                            <p class="text-xs text-gray-600 mt-1">
                                <i class="fas fa-phone mr-1"></i>
                                ${ag.paciente_telefone}
                            </p>
                        </div>
                        <span class="px-2 py-1 bg-yellow-200 text-yellow-800 text-xs rounded font-medium">
                            ${ag.status}
                        </span>
                    </div>
                </div>
            `).join('');

            document.getElementById('modalConflitos').classList.remove('hidden');
        }

        function fecharModalConflitos() {
            document.getElementById('modalConflitos').classList.add('hidden');
        }

        async function confirmarBloqueioComCancelamento() {
            await criarBloqueio(true);
        }

        async function deletarBloqueio(bloqueioId) {
            if (!confirm('Deseja realmente remover este bloqueio?')) return;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/medicos/${medicoId}/bloqueios/${bloqueioId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const result = await response.json();
                if (result.sucesso) {
                    carregarBloqueios();
                    alert('Bloqueio removido com sucesso!');
                } else {
                    alert('Erro ao remover bloqueio');
                }
            } catch (error) {
                console.error('Erro ao deletar bloqueio:', error);
                alert('Erro ao deletar bloqueio');
            }
        }

        // Inicializar ao carregar a página
        window.onload = checkAuth;
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('✅ PWA: Service Worker registrado com sucesso!', registration.scope);
                    })
                    .catch(error => {
                        console.log('❌ PWA: Falha ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
