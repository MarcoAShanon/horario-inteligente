<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Conversas - Hor√°rio Inteligente</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Layout do chat */
        .chat-container {
            height: calc(100vh - 64px);
        }

        /* Lista de conversas */
        .conversa-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .conversa-item:hover {
            background: #f3f4f6;
        }
        .conversa-item.active {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }
        .conversa-item.humano {
            border-left-color: #f59e0b;
        }

        /* Mensagens estilo WhatsApp */
        .mensagem {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
        }
        .mensagem.entrada {
            background: white;
            border: 1px solid #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .mensagem.saida {
            background: #dcfce7;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .mensagem.saida.atendente {
            background: #dbeafe;
        }
        .mensagem .remetente {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .mensagem .remetente.paciente { color: #6b7280; }
        .mensagem .remetente.ia { color: #059669; }
        .mensagem .remetente.atendente { color: #2563eb; }
        .mensagem .timestamp {
            font-size: 0.65rem;
            color: #9ca3af;
            text-align: right;
            margin-top: 4px;
        }

        /* Chat area */
        .chat-messages {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 16px;
            flex: 1;
        }

        /* Status badges */
        .status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: 500;
        }
        .status-ia { background: #d1fae5; color: #065f46; }
        .status-humano { background: #fef3c7; color: #92400e; }
        .status-encerrada { background: #f3f4f6; color: #6b7280; }

        /* Unread badge */
        .unread-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Urgency indicators */
        .urgencia-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            animation: urgencia-pulse 2s infinite;
        }
        .urgencia-critica {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        .urgencia-atencao {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        .conversa-item.urgente-critica {
            border-left-color: #dc2626 !important;
            background: linear-gradient(90deg, #fef2f2 0%, white 20%);
        }
        .conversa-item.urgente-atencao {
            border-left-color: #f59e0b !important;
            background: linear-gradient(90deg, #fffbeb 0%, white 20%);
        }
        @keyframes urgencia-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .urgencia-counter {
            background: #dc2626;
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-left: 4px;
        }
        .filtro-btn.urgente {
            background: #fef2f2 !important;
            color: #dc2626 !important;
            border: 1px solid #fecaca;
        }
        .filtro-btn.urgente.active {
            background: #dc2626 !important;
            color: white !important;
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar,
        .conversas-list::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb,
        .conversas-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }

        /* Connection status */
        .ws-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .ws-status.connected { background: #22c55e; }
        .ws-status.disconnected { background: #ef4444; }
        .ws-status.connecting { background: #f59e0b; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Janela 24h status */
        .janela-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 500;
        }
        .janela-ativa {
            background: #d1fae5;
            color: #065f46;
        }
        .janela-expirada {
            background: #fee2e2;
            color: #991b1b;
        }
        .janela-indicator {
            font-size: 0.9rem;
        }

        /* Template selector */
        .template-selector {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .template-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }
        .template-selector label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
        }
        .template-params {
            margin-top: 8px;
        }
        .template-params input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .input-desabilitado {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .mensagem {
                max-width: 85%;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm h-16 flex items-center px-4 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center gap-4 flex-1">
            <!-- Mobile menu button -->
            <button id="menuBtn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <div class="flex items-center gap-3">
                <i class="fas fa-comments text-2xl text-purple-600"></i>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Painel de Conversas</h1>
                    <p class="text-xs text-gray-500">WhatsApp Business</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Stats -->
            <div class="hidden sm:flex items-center gap-4 text-sm">
                <span class="flex items-center gap-1">
                    <span class="ws-status" id="wsStatus"></span>
                    <span id="wsStatusText" class="text-gray-600">Conectando...</span>
                </span>
                <span class="text-gray-400">|</span>
                <span id="statsAtivas" class="text-green-600">0 ativas</span>
                <span id="statsNaoLidas" class="text-red-600">0 n√£o lidas</span>
                <span id="statsUrgencias" class="text-red-600 hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="urgenciasCount">0</span> urgentes
                </span>
            </div>

            <!-- Navigation -->
            <div id="navMedico" class="flex items-center gap-2">
                <a href="/static/dashboard.html" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="Painel">
                    <i class="fas fa-chart-line"></i>
                </a>
            </div>
            <div id="navSecretaria" class="hidden flex items-center gap-2">
                <a href="/static/calendario-unificado.html" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg" title="Calend√°rio de Agendamentos">
                    <i class="fas fa-calendar-alt"></i>
                </a>
                <a href="/static/configuracoes.html" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="Configura√ß√µes do M√©dico">
                    <i class="fas fa-cog"></i>
                </a>
                <a href="/static/alterar-senha.html" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="Alterar Senha">
                    <i class="fas fa-key"></i>
                </a>
            </div>
            <button onclick="logout()" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="chat-container flex mt-16">
        <!-- Sidebar - Lista de Conversas -->
        <aside id="sidebar" class="sidebar w-80 bg-white border-r flex flex-col">
            <!-- Search and Filter -->
            <div class="p-3 border-b">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Buscar conversa..."
                        class="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="filtrarConversas('todas')" class="filtro-btn active flex-1 py-1 text-xs rounded bg-purple-600 text-white">
                        Todas
                    </button>
                    <button onclick="filtrarConversas('ia_ativa')" class="filtro-btn flex-1 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                        IA
                    </button>
                    <button onclick="filtrarConversas('humano_assumiu')" class="filtro-btn flex-1 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                        Humano
                    </button>
                    <button onclick="filtrarConversas('urgentes')" class="filtro-btn urgente flex-1 py-1 text-xs rounded" id="btnFiltroUrgente">
                        <i class="fas fa-exclamation-triangle"></i> <span id="filtroUrgenteBadge"></span>
                    </button>
                </div>
            </div>

            <!-- Conversations List -->
            <div class="conversas-list flex-1 overflow-y-auto" id="conversasList">
                <div class="empty-state py-8">
                    <i class="fas fa-comments text-4xl mb-2"></i>
                    <p>Carregando conversas...</p>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50">
            <!-- Chat Header -->
            <div id="chatHeader" class="bg-white border-b p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-purple-600"></i>
                        </div>
                        <div>
                            <h2 id="chatNome" class="font-semibold text-gray-800">Paciente</h2>
                            <p id="chatTelefone" class="text-sm text-gray-500">+55 00 00000-0000</p>
                        </div>
                        <span id="chatStatus" class="status-badge status-ia ml-2">IA Ativa</span>
                        <!-- Indicador de Janela 24h -->
                        <span id="janelaStatus" class="janela-status janela-ativa ml-2 hidden">
                            <span class="janela-indicator">üü¢</span>
                            <span id="janelaTexto">Janela ativa</span>
                        </span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnResolverUrgencia" onclick="resolverUrgencia()"
                            class="px-3 py-1.5 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition flex items-center gap-1 hidden">
                            <i class="fas fa-check-circle"></i>
                            <span class="hidden sm:inline">Resolver Urg√™ncia</span>
                        </button>
                        <button id="btnAssumir" onclick="assumirConversa()"
                            class="px-3 py-1.5 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition flex items-center gap-1">
                            <i class="fas fa-hand-paper"></i>
                            <span class="hidden sm:inline">Assumir</span>
                        </button>
                        <button id="btnDevolver" onclick="devolverParaIA()"
                            class="px-3 py-1.5 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition flex items-center gap-1 hidden">
                            <i class="fas fa-robot"></i>
                            <span class="hidden sm:inline">Devolver IA</span>
                        </button>
                        <button id="btnEncerrar" onclick="encerrarConversa()"
                            class="px-3 py-1.5 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600 transition flex items-center gap-1">
                            <i class="fas fa-times"></i>
                            <span class="hidden sm:inline">Encerrar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chatMessages" class="chat-messages flex-1">
                <div class="empty-state">
                    <i class="fas fa-comment-dots text-6xl mb-4"></i>
                    <p class="text-lg">Selecione uma conversa</p>
                    <p class="text-sm">Escolha uma conversa na lista para visualizar as mensagens</p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="chatInput" class="bg-white border-t p-3 hidden">
                <!-- Template Selector (quando janela expirada) -->
                <div id="templateSelector" class="template-selector hidden">
                    <label>
                        <i class="fas fa-file-alt"></i>
                        Janela de 24h expirada - Selecione um template aprovado:
                    </label>
                    <select id="templateSelect" onchange="onTemplateChange()">
                        <option value="">-- Selecione um template --</option>
                        <option value="lembrete_consulta">Lembrete de Consulta</option>
                        <option value="confirmacao_agendamento">Confirma√ß√£o de Agendamento</option>
                        <option value="retorno_contato">Retorno de Contato</option>
                    </select>
                    <div id="templateParams" class="template-params hidden">
                        <label class="text-xs text-gray-600">Par√¢metros do template:</label>
                        <input type="text" id="templateParam1" placeholder="Par√¢metro 1 (ex: nome do paciente)">
                    </div>
                </div>

                <form onsubmit="enviarMensagem(event)" class="flex gap-2">
                    <input type="text" id="mensagemInput" placeholder="Digite sua mensagem..."
                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit" id="btnEnviar"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        <span class="hidden sm:inline">Enviar</span>
                    </button>
                </form>
                <p id="inputHint" class="text-xs text-amber-600 mt-1 hidden">
                    <i class="fas fa-info-circle"></i>
                    Voc√™ assumiu esta conversa. A IA n√£o responder√°.
                </p>
                <p id="janelaHint" class="text-xs text-red-600 mt-1 hidden">
                    <i class="fas fa-clock"></i>
                    Janela de 24h expirada. Use um template aprovado pela Meta para enviar mensagem.
                </p>
            </div>

            <!-- Empty State (when no conversation selected) -->
            <div id="emptyState" class="empty-state flex-1">
                <i class="fas fa-comment-dots text-6xl mb-4"></i>
                <p class="text-lg">Selecione uma conversa</p>
                <p class="text-sm">Escolha uma conversa na lista para visualizar as mensagens</p>
            </div>
        </main>
    </div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQwAQJrd1LGEEABE" type="audio/wav">
    </audio>

    <script>
        // ==================== STATE ====================
        let token = localStorage.getItem('authToken');
        let conversas = [];
        let conversaAtual = null;
        let ws = null;
        let filtroAtual = 'todas';
        let urgenciasContagem = { critica: 0, atencao: 0, total: 0 };
        let janelaAtual = { ativa: true, expira_em: null }; // Status da janela 24h

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            // Verificar se √© secret√°ria usando /api/auth/me (dados atualizados)
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const currentUser = await response.json();

                    // Atualizar localStorage com dados mais recentes
                    localStorage.setItem('userData', JSON.stringify(currentUser));

                    if (currentUser.is_secretaria) {
                        document.getElementById('navMedico').classList.add('hidden');
                        document.getElementById('navSecretaria').classList.remove('hidden');
                    } else {
                        document.getElementById('navMedico').classList.remove('hidden');
                        document.getElementById('navSecretaria').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar usu√°rio:', error);
            }

            carregarConversas();
            carregarAlertasUrgencia();
            conectarWebSocket();
            setupMobileMenu();
        });

        // ==================== API CALLS ====================
        async function carregarConversas() {
            try {
                const response = await fetch('/api/conversas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                conversas = await response.json();
                renderizarConversas();
                carregarStats();
            } catch (error) {
                console.error('Erro ao carregar conversas:', error);
            }
        }

        async function carregarStats() {
            try {
                const response = await fetch('/api/conversas/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await response.json();

                document.getElementById('statsAtivas').textContent = `${stats.total_ativas + stats.total_assumidas} ativas`;
                document.getElementById('statsNaoLidas').textContent = `${stats.total_nao_lidas} n√£o lidas`;
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        async function carregarAlertasUrgencia() {
            try {
                const response = await fetch('/api/alertas/contagem', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) return;

                const data = await response.json();
                urgenciasContagem = data.contagem || { critica: 0, atencao: 0, total: 0 };

                // Atualizar indicadores no header
                const statsUrgencias = document.getElementById('statsUrgencias');
                const urgenciasCount = document.getElementById('urgenciasCount');
                const filtroUrgenteBadge = document.getElementById('filtroUrgenteBadge');

                if (urgenciasContagem.total > 0) {
                    statsUrgencias.classList.remove('hidden');
                    urgenciasCount.textContent = urgenciasContagem.total;
                    filtroUrgenteBadge.textContent = urgenciasContagem.total;
                } else {
                    statsUrgencias.classList.add('hidden');
                    filtroUrgenteBadge.textContent = '';
                }
            } catch (error) {
                console.error('Erro ao carregar alertas de urg√™ncia:', error);
            }
        }

        async function carregarMensagens(conversaId) {
            try {
                const response = await fetch(`/api/conversas/${conversaId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar mensagens');

                const data = await response.json();
                conversaAtual = data;

                renderizarMensagens(data.mensagens);
                atualizarHeader(data);
                mostrarChat();

                // Verificar status da janela 24h
                await verificarJanela24h(conversaId);

                // Atualizar lista para remover badge de n√£o lidas
                const conv = conversas.find(c => c.id === conversaId);
                if (conv) conv.nao_lidas = 0;
                renderizarConversas();

            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        async function verificarJanela24h(conversaId) {
            try {
                const response = await fetch(`/api/conversas/${conversaId}/janela-status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.error('Erro ao verificar janela 24h');
                    return;
                }

                janelaAtual = await response.json();
                atualizarUIJanela(janelaAtual);

            } catch (error) {
                console.error('Erro ao verificar janela 24h:', error);
            }
        }

        function atualizarUIJanela(janela) {
            const janelaStatusEl = document.getElementById('janelaStatus');
            const janelaTextoEl = document.getElementById('janelaTexto');
            const templateSelectorEl = document.getElementById('templateSelector');
            const mensagemInputEl = document.getElementById('mensagemInput');
            const janelaHintEl = document.getElementById('janelaHint');

            janelaStatusEl.classList.remove('hidden');

            if (janela.ativa) {
                // Janela ativa - pode enviar mensagem livre
                janelaStatusEl.classList.remove('janela-expirada');
                janelaStatusEl.classList.add('janela-ativa');
                janelaStatusEl.querySelector('.janela-indicator').textContent = 'üü¢';
                janelaTextoEl.textContent = `Janela ativa (${janela.expira_em || 'ativa'})`;

                // Habilitar input de texto e esconder template selector
                templateSelectorEl.classList.add('hidden');
                mensagemInputEl.classList.remove('input-desabilitado');
                mensagemInputEl.placeholder = 'Digite sua mensagem...';
                mensagemInputEl.disabled = false;
                janelaHintEl.classList.add('hidden');

            } else {
                // Janela expirada - obrigat√≥rio usar template
                janelaStatusEl.classList.remove('janela-ativa');
                janelaStatusEl.classList.add('janela-expirada');
                janelaStatusEl.querySelector('.janela-indicator').textContent = 'üî¥';
                janelaTextoEl.textContent = 'Janela expirada';

                // Mostrar template selector e desabilitar input livre
                templateSelectorEl.classList.remove('hidden');
                mensagemInputEl.classList.add('input-desabilitado');
                mensagemInputEl.placeholder = 'Selecione um template acima...';
                mensagemInputEl.disabled = true;
                janelaHintEl.classList.remove('hidden');
            }
        }

        function onTemplateChange() {
            const templateSelect = document.getElementById('templateSelect');
            const templateParams = document.getElementById('templateParams');
            const mensagemInput = document.getElementById('mensagemInput');

            if (templateSelect.value) {
                templateParams.classList.remove('hidden');
                // Preencher o input com uma pr√©via do template
                const templatePreviews = {
                    'lembrete_consulta': 'Ol√°! Passando para lembrar da sua consulta agendada.',
                    'confirmacao_agendamento': 'Seu agendamento foi confirmado com sucesso!',
                    'retorno_contato': 'Ol√°! Estamos retornando seu contato.'
                };
                mensagemInput.value = templatePreviews[templateSelect.value] || '';
                mensagemInput.classList.remove('input-desabilitado');
                mensagemInput.disabled = false;
            } else {
                templateParams.classList.add('hidden');
                mensagemInput.value = '';
                if (!janelaAtual.ativa) {
                    mensagemInput.classList.add('input-desabilitado');
                    mensagemInput.disabled = true;
                }
            }
        }

        async function enviarMensagem(event) {
            event.preventDefault();

            const input = document.getElementById('mensagemInput');
            const conteudo = input.value.trim();
            const templateSelect = document.getElementById('templateSelect');
            const templateParam1 = document.getElementById('templateParam1');

            if (!conteudo || !conversaAtual) return;

            // Preparar payload
            let payload = { conteudo, tipo: 'texto' };

            // Se janela expirada, verificar se tem template selecionado
            if (!janelaAtual.ativa) {
                if (!templateSelect.value) {
                    alert('Janela de 24h expirada. Selecione um template aprovado para enviar mensagem.');
                    return;
                }

                // Adicionar dados do template ao payload
                payload.template_name = templateSelect.value;
                payload.template_params = templateParam1.value ? [templateParam1.value] : [];
            }

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    // Verificar se √© erro de janela expirada
                    if (error.detail && error.detail.error === 'janela_expirada') {
                        alert(error.detail.message);
                        // Atualizar status da janela na UI
                        janelaAtual.ativa = false;
                        atualizarUIJanela(janelaAtual);
                        return;
                    }
                    alert(error.detail || 'Erro ao enviar mensagem');
                    return;
                }

                const mensagem = await response.json();
                adicionarMensagemUI(mensagem);
                input.value = '';

                // Limpar sele√ß√£o de template se usado
                if (!janelaAtual.ativa) {
                    templateSelect.value = '';
                    templateParam1.value = '';
                    document.getElementById('templateParams').classList.add('hidden');
                }

            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem');
            }
        }

        async function assumirConversa() {
            if (!conversaAtual) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/assumir`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    conversaAtual.status = 'humano_assumiu';
                    atualizarHeader(conversaAtual);
                    atualizarConversaNaLista(conversaAtual.id, 'humano_assumiu');
                }
            } catch (error) {
                console.error('Erro ao assumir conversa:', error);
            }
        }

        async function devolverParaIA() {
            if (!conversaAtual) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/devolver-ia`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    conversaAtual.status = 'ia_ativa';
                    atualizarHeader(conversaAtual);
                    atualizarConversaNaLista(conversaAtual.id, 'ia_ativa');
                }
            } catch (error) {
                console.error('Erro ao devolver para IA:', error);
            }
        }

        async function encerrarConversa() {
            if (!conversaAtual) return;
            if (!confirm('Deseja encerrar esta conversa?')) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/encerrar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // Remover da lista e limpar chat
                    conversas = conversas.filter(c => c.id !== conversaAtual.id);
                    renderizarConversas();
                    esconderChat();
                    conversaAtual = null;
                }
            } catch (error) {
                console.error('Erro ao encerrar conversa:', error);
            }
        }

        async function resolverUrgencia() {
            if (!conversaAtual) return;

            const nota = prompt('Nota sobre a resolu√ß√£o (opcional):');

            try {
                const response = await fetch(`/api/alertas/conversa/${conversaAtual.id}/resolver`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nota: nota || null })
                });

                if (response.ok) {
                    // Atualizar conversa local
                    conversaAtual.urgencia_resolvida = true;
                    const conv = conversas.find(c => c.id === conversaAtual.id);
                    if (conv) {
                        conv.urgencia_resolvida = true;
                    }

                    atualizarHeader(conversaAtual);
                    renderizarConversas();
                    carregarAlertasUrgencia();

                    alert('Urg√™ncia resolvida com sucesso!');
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Erro ao resolver urg√™ncia');
                }
            } catch (error) {
                console.error('Erro ao resolver urg√™ncia:', error);
                alert('Erro ao resolver urg√™ncia');
            }
        }

        // ==================== WEBSOCKET ====================
        function conectarWebSocket() {
            const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/conversas?token=${token}`;

            setWsStatus('connecting');
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                setWsStatus('connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processarEventoWS(data);
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                setWsStatus('disconnected');
                // Reconectar ap√≥s 3 segundos
                setTimeout(conectarWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('Erro WebSocket:', error);
                setWsStatus('disconnected');
            };
        }

        function setWsStatus(status) {
            const statusEl = document.getElementById('wsStatus');
            const textEl = document.getElementById('wsStatusText');

            statusEl.className = 'ws-status ' + status;

            const texts = {
                'connected': 'Conectado',
                'disconnected': 'Desconectado',
                'connecting': 'Conectando...'
            };
            textEl.textContent = texts[status] || status;
        }

        function processarEventoWS(data) {
            console.log('WS Event:', data);

            switch (data.tipo) {
                case 'nova_mensagem':
                    handleNovaMensagem(data);
                    break;
                case 'conversa_atualizada':
                    handleConversaAtualizada(data);
                    break;
                case 'nova_conversa':
                    handleNovaConversa(data);
                    break;
                case 'urgencia_detectada':
                    handleUrgenciaDetectada(data);
                    break;
                case 'conectado':
                    console.log('Conex√£o confirmada:', data.message);
                    break;
            }
        }

        function handleUrgenciaDetectada(data) {
            // Atualizar conversa na lista com urg√™ncia
            const conv = conversas.find(c => c.id === data.conversa_id);
            if (conv) {
                conv.urgencia_nivel = data.nivel;
                conv.urgencia_resolvida = false;
                conv.urgencia_motivo = data.motivo;
                renderizarConversas();
            }

            // Atualizar header se for a conversa atual
            if (conversaAtual && conversaAtual.id === data.conversa_id) {
                conversaAtual.urgencia_nivel = data.nivel;
                conversaAtual.urgencia_resolvida = false;
                atualizarHeader(conversaAtual);
            }

            // Recarregar contagem de alertas
            carregarAlertasUrgencia();

            // Tocar notifica√ß√£o para urg√™ncias
            if (data.nivel === 'critica') {
                tocarNotificacao();
                // Alerta visual extra para cr√≠ticas
                document.title = 'üö® URG√äNCIA - Painel de Conversas';
                setTimeout(() => { document.title = 'Painel de Conversas - Hor√°rio Inteligente'; }, 5000);
            }
        }

        function handleNovaMensagem(data) {
            // Tocar som se n√£o for a conversa atual ou se vier do paciente
            if (data.mensagem.remetente === 'paciente') {
                tocarNotificacao();
            }

            // Se for a conversa atual, adicionar mensagem
            if (conversaAtual && conversaAtual.id === data.conversa_id) {
                adicionarMensagemUI(data.mensagem);
            }

            // Atualizar lista de conversas
            const conv = conversas.find(c => c.id === data.conversa_id);
            if (conv) {
                conv.ultima_mensagem = data.mensagem.conteudo.substring(0, 50);
                conv.ultima_mensagem_at = data.mensagem.timestamp;
                if (data.mensagem.remetente === 'paciente' && (!conversaAtual || conversaAtual.id !== data.conversa_id)) {
                    conv.nao_lidas = (conv.nao_lidas || 0) + 1;
                }
                // Mover para o topo
                conversas = conversas.filter(c => c.id !== data.conversa_id);
                conversas.unshift(conv);
                renderizarConversas();
            }

            carregarStats();
        }

        function handleConversaAtualizada(data) {
            atualizarConversaNaLista(data.conversa_id, data.status);
            if (conversaAtual && conversaAtual.id === data.conversa_id) {
                conversaAtual.status = data.status;
                atualizarHeader(conversaAtual);
            }
        }

        function handleNovaConversa(data) {
            conversas.unshift(data.conversa);
            renderizarConversas();
            tocarNotificacao();
            carregarStats();
        }

        function tocarNotificacao() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        // ==================== UI RENDERING ====================
        function renderizarConversas() {
            const container = document.getElementById('conversasList');
            let lista = conversas;

            // Aplicar filtro
            if (filtroAtual === 'urgentes') {
                lista = conversas.filter(c =>
                    c.urgencia_nivel && c.urgencia_nivel !== 'normal' && !c.urgencia_resolvida
                );
            } else if (filtroAtual !== 'todas') {
                lista = conversas.filter(c => c.status === filtroAtual);
            }

            // Aplicar busca
            const busca = document.getElementById('searchInput').value.toLowerCase();
            if (busca) {
                lista = lista.filter(c =>
                    (c.paciente_nome && c.paciente_nome.toLowerCase().includes(busca)) ||
                    c.paciente_telefone.includes(busca)
                );
            }

            if (lista.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>Nenhuma conversa encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = lista.map(conv => {
                const isUrgente = conv.urgencia_nivel && conv.urgencia_nivel !== 'normal' && !conv.urgencia_resolvida;
                const urgenciaClass = isUrgente ? (conv.urgencia_nivel === 'critica' ? 'urgente-critica' : 'urgente-atencao') : '';
                const urgenciaBadge = isUrgente ? getUrgenciaBadge(conv.urgencia_nivel) : '';

                return `
                <div class="conversa-item p-3 cursor-pointer ${conv.id === conversaAtual?.id ? 'active' : ''} ${conv.status === 'humano_assumiu' ? 'humano' : ''} ${urgenciaClass}"
                     onclick="selecionarConversa(${conv.id})">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0 relative">
                            <i class="fas fa-user text-gray-500"></i>
                            ${isUrgente && conv.urgencia_nivel === 'critica' ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-800 truncate">
                                    ${escapeHtml(conv.paciente_nome || conv.paciente_telefone)}
                                </span>
                                <div class="flex items-center gap-1">
                                    ${urgenciaBadge}
                                    ${conv.nao_lidas > 0 ? `<span class="unread-badge">${conv.nao_lidas}</span>` : ''}
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 truncate">${escapeHtml(conv.ultima_mensagem || 'Sem mensagens')}</p>
                            <div class="flex items-center justify-between mt-1">
                                <span class="status-badge ${getStatusClass(conv.status)}">${getStatusLabel(conv.status)}</span>
                                <span class="text-xs text-gray-400">${formatarHora(conv.ultima_mensagem_at)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function getUrgenciaBadge(nivel) {
            if (nivel === 'critica') {
                return `<span class="urgencia-badge urgencia-critica"><i class="fas fa-exclamation-triangle"></i> Urgente</span>`;
            } else if (nivel === 'atencao') {
                return `<span class="urgencia-badge urgencia-atencao"><i class="fas fa-exclamation-circle"></i> Aten√ß√£o</span>`;
            }
            return '';
        }

        function renderizarMensagens(mensagens) {
            const container = document.getElementById('chatMessages');

            if (!mensagens || mensagens.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-slash text-4xl mb-2"></i>
                        <p>Nenhuma mensagem ainda</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = mensagens.map(m => criarMensagemHTML(m)).join('');
            container.scrollTop = container.scrollHeight;
        }

        function criarMensagemHTML(m) {
            const isEntrada = m.direcao === 'entrada';
            const remetenteLabel = {
                'paciente': 'Paciente',
                'ia': 'IA',
                'atendente': 'Atendente'
            };

            return `
                <div class="mensagem ${isEntrada ? 'entrada' : 'saida'} ${m.remetente === 'atendente' ? 'atendente' : ''}" data-msg-id="${m.id}">
                    <div class="remetente ${m.remetente}">${remetenteLabel[m.remetente] || m.remetente}</div>
                    <div class="conteudo">${escapeHtml(m.conteudo)}</div>
                    <div class="timestamp">${formatarHora(m.timestamp)}</div>
                </div>
            `;
        }

        function adicionarMensagemUI(mensagem) {
            const container = document.getElementById('chatMessages');

            // Evitar duplicatas - verificar se mensagem j√° existe pelo ID
            if (mensagem.id && container.querySelector(`[data-msg-id="${mensagem.id}"]`)) {
                console.log(`[WS] Mensagem ${mensagem.id} j√° existe, ignorando duplicata`);
                return;
            }

            // Remover empty state se existir
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            container.insertAdjacentHTML('beforeend', criarMensagemHTML(mensagem));
            container.scrollTop = container.scrollHeight;
        }

        function atualizarHeader(conversa) {
            document.getElementById('chatNome').textContent = conversa.paciente_nome || 'Paciente';
            document.getElementById('chatTelefone').textContent = conversa.paciente_telefone;

            const statusEl = document.getElementById('chatStatus');
            statusEl.className = `status-badge ${getStatusClass(conversa.status)}`;
            statusEl.textContent = getStatusLabel(conversa.status);

            // Urgency badge in header
            let urgenciaBadgeEl = document.getElementById('chatUrgenciaBadge');
            const isUrgente = conversa.urgencia_nivel && conversa.urgencia_nivel !== 'normal' && !conversa.urgencia_resolvida;

            if (!urgenciaBadgeEl) {
                // Criar elemento se n√£o existir
                urgenciaBadgeEl = document.createElement('span');
                urgenciaBadgeEl.id = 'chatUrgenciaBadge';
                statusEl.parentNode.insertBefore(urgenciaBadgeEl, statusEl.nextSibling);
            }

            if (isUrgente) {
                urgenciaBadgeEl.innerHTML = getUrgenciaBadge(conversa.urgencia_nivel);
                urgenciaBadgeEl.classList.remove('hidden');
                urgenciaBadgeEl.classList.add('ml-2');
            } else {
                urgenciaBadgeEl.innerHTML = '';
                urgenciaBadgeEl.classList.add('hidden');
            }

            // Bot√µes
            const btnAssumir = document.getElementById('btnAssumir');
            const btnDevolver = document.getElementById('btnDevolver');
            const btnResolverUrgencia = document.getElementById('btnResolverUrgencia');
            const inputHint = document.getElementById('inputHint');

            if (conversa.status === 'humano_assumiu') {
                btnAssumir.classList.add('hidden');
                btnDevolver.classList.remove('hidden');
                inputHint.classList.remove('hidden');
            } else {
                btnAssumir.classList.remove('hidden');
                btnDevolver.classList.add('hidden');
                inputHint.classList.add('hidden');
            }

            // Bot√£o de resolver urg√™ncia
            if (isUrgente) {
                btnResolverUrgencia.classList.remove('hidden');
            } else {
                btnResolverUrgencia.classList.add('hidden');
            }
        }

        function atualizarConversaNaLista(conversaId, status) {
            const conv = conversas.find(c => c.id === conversaId);
            if (conv) {
                conv.status = status;
                renderizarConversas();
            }
        }

        // ==================== ACTIONS ====================
        function selecionarConversa(conversaId) {
            carregarMensagens(conversaId);
            // Fechar sidebar em mobile
            document.getElementById('sidebar').classList.remove('open');
        }

        function filtrarConversas(filtro) {
            filtroAtual = filtro;

            // Atualizar bot√µes
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                const isUrgenteBtn = btn.classList.contains('urgente');
                btn.classList.remove('active');
                if (isUrgenteBtn) {
                    btn.classList.remove('bg-red-600', 'text-white');
                } else {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            const clickedBtn = event.target.closest('.filtro-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
                if (clickedBtn.classList.contains('urgente')) {
                    clickedBtn.classList.add('bg-red-600', 'text-white');
                } else {
                    clickedBtn.classList.add('bg-purple-600', 'text-white');
                    clickedBtn.classList.remove('bg-gray-200', 'text-gray-700');
                }
            }

            renderizarConversas();
        }

        function mostrarChat() {
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatInput').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
        }

        function esconderChat() {
            document.getElementById('chatHeader').classList.add('hidden');
            document.getElementById('chatInput').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('chatMessages').innerHTML = '';

            // Resetar status da janela
            document.getElementById('janelaStatus').classList.add('hidden');
            document.getElementById('templateSelector').classList.add('hidden');
            document.getElementById('janelaHint').classList.add('hidden');
            janelaAtual = { ativa: true, expira_em: null };
        }

        function setupMobileMenu() {
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');

            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            });
        }

        // ==================== HELPERS ====================
        function getStatusClass(status) {
            return {
                'ia_ativa': 'status-ia',
                'humano_assumiu': 'status-humano',
                'encerrada': 'status-encerrada'
            }[status] || 'status-ia';
        }

        function getStatusLabel(status) {
            return {
                'ia_ativa': 'IA Ativa',
                'humano_assumiu': 'Atendente',
                'encerrada': 'Encerrada'
            }[status] || status;
        }

        function formatarHora(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hoje = new Date();
            const ontem = new Date(hoje);
            ontem.setDate(ontem.getDate() - 1);

            if (date.toDateString() === hoje.toDateString()) {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } else if (date.toDateString() === ontem.toDateString()) {
                return 'Ontem';
            } else {
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/static/login.html';
        }

        // Search input listener
        document.getElementById('searchInput').addEventListener('input', renderizarConversas);
    </script>
</body>
</html>
