<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Conversas - Horário Inteligente</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Layout do chat */
        .chat-container {
            height: calc(100vh - 64px);
        }

        /* Lista de conversas */
        .conversa-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }
        .conversa-item:hover {
            background: #f3f4f6;
        }
        .conversa-item.active {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }
        .conversa-item.humano {
            border-left-color: #f59e0b;
        }

        /* Mensagens estilo WhatsApp */
        .mensagem {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
        }
        .mensagem.entrada {
            background: white;
            border: 1px solid #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .mensagem.saida {
            background: #dcfce7;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .mensagem.saida.atendente {
            background: #dbeafe;
        }
        .mensagem .remetente {
            font-size: 0.7rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .mensagem .remetente.paciente { color: #6b7280; }
        .mensagem .remetente.ia { color: #059669; }
        .mensagem .remetente.atendente { color: #2563eb; }
        .mensagem .timestamp {
            font-size: 0.65rem;
            color: #9ca3af;
            text-align: right;
            margin-top: 4px;
        }

        /* Chat area */
        .chat-messages {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 16px;
            flex: 1;
        }

        /* Status badges */
        .status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 9999px;
            font-weight: 500;
        }
        .status-ia { background: #d1fae5; color: #065f46; }
        .status-humano { background: #fef3c7; color: #92400e; }
        .status-encerrada { background: #f3f4f6; color: #6b7280; }

        /* Unread badge */
        .unread-badge {
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar,
        .conversas-list::-webkit-scrollbar {
            width: 6px;
        }
        .chat-messages::-webkit-scrollbar-thumb,
        .conversas-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
        }

        /* Connection status */
        .ws-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .ws-status.connected { background: #22c55e; }
        .ws-status.disconnected { background: #ef4444; }
        .ws-status.connecting { background: #f59e0b; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .mensagem {
                max-width: 85%;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm h-16 flex items-center px-4 fixed top-0 left-0 right-0 z-50">
        <div class="flex items-center gap-4 flex-1">
            <!-- Mobile menu button -->
            <button id="menuBtn" class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <div class="flex items-center gap-3">
                <i class="fas fa-comments text-2xl text-purple-600"></i>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Painel de Conversas</h1>
                    <p class="text-xs text-gray-500">WhatsApp Business</p>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Stats -->
            <div class="hidden sm:flex items-center gap-4 text-sm">
                <span class="flex items-center gap-1">
                    <span class="ws-status" id="wsStatus"></span>
                    <span id="wsStatusText" class="text-gray-600">Conectando...</span>
                </span>
                <span class="text-gray-400">|</span>
                <span id="statsAtivas" class="text-green-600">0 ativas</span>
                <span id="statsNaoLidas" class="text-red-600">0 não lidas</span>
            </div>

            <!-- Navigation -->
            <a href="/static/dashboard.html" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg" title="Dashboard">
                <i class="fas fa-chart-line"></i>
            </a>
            <button onclick="logout()" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Sair">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="chat-container flex mt-16">
        <!-- Sidebar - Lista de Conversas -->
        <aside id="sidebar" class="sidebar w-80 bg-white border-r flex flex-col">
            <!-- Search and Filter -->
            <div class="p-3 border-b">
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="Buscar conversa..."
                        class="w-full pl-9 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="filtrarConversas('todas')" class="filtro-btn active flex-1 py-1 text-xs rounded bg-purple-600 text-white">
                        Todas
                    </button>
                    <button onclick="filtrarConversas('ia_ativa')" class="filtro-btn flex-1 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                        IA
                    </button>
                    <button onclick="filtrarConversas('humano_assumiu')" class="filtro-btn flex-1 py-1 text-xs rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                        Humano
                    </button>
                </div>
            </div>

            <!-- Conversations List -->
            <div class="conversas-list flex-1 overflow-y-auto" id="conversasList">
                <div class="empty-state py-8">
                    <i class="fas fa-comments text-4xl mb-2"></i>
                    <p>Carregando conversas...</p>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50">
            <!-- Chat Header -->
            <div id="chatHeader" class="bg-white border-b p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-purple-600"></i>
                        </div>
                        <div>
                            <h2 id="chatNome" class="font-semibold text-gray-800">Paciente</h2>
                            <p id="chatTelefone" class="text-sm text-gray-500">+55 00 00000-0000</p>
                        </div>
                        <span id="chatStatus" class="status-badge status-ia ml-2">IA Ativa</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnAssumir" onclick="assumirConversa()"
                            class="px-3 py-1.5 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition flex items-center gap-1">
                            <i class="fas fa-hand-paper"></i>
                            <span class="hidden sm:inline">Assumir</span>
                        </button>
                        <button id="btnDevolver" onclick="devolverParaIA()"
                            class="px-3 py-1.5 bg-green-500 text-white text-sm rounded-lg hover:bg-green-600 transition flex items-center gap-1 hidden">
                            <i class="fas fa-robot"></i>
                            <span class="hidden sm:inline">Devolver IA</span>
                        </button>
                        <button id="btnEncerrar" onclick="encerrarConversa()"
                            class="px-3 py-1.5 bg-gray-500 text-white text-sm rounded-lg hover:bg-gray-600 transition flex items-center gap-1">
                            <i class="fas fa-times"></i>
                            <span class="hidden sm:inline">Encerrar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chatMessages" class="chat-messages flex-1">
                <div class="empty-state">
                    <i class="fas fa-comment-dots text-6xl mb-4"></i>
                    <p class="text-lg">Selecione uma conversa</p>
                    <p class="text-sm">Escolha uma conversa na lista para visualizar as mensagens</p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="chatInput" class="bg-white border-t p-3 hidden">
                <form onsubmit="enviarMensagem(event)" class="flex gap-2">
                    <input type="text" id="mensagemInput" placeholder="Digite sua mensagem..."
                        class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="submit"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        <span class="hidden sm:inline">Enviar</span>
                    </button>
                </form>
                <p id="inputHint" class="text-xs text-amber-600 mt-1 hidden">
                    <i class="fas fa-info-circle"></i>
                    Você assumiu esta conversa. A IA não responderá.
                </p>
            </div>

            <!-- Empty State (when no conversation selected) -->
            <div id="emptyState" class="empty-state flex-1">
                <i class="fas fa-comment-dots text-6xl mb-4"></i>
                <p class="text-lg">Selecione uma conversa</p>
                <p class="text-sm">Escolha uma conversa na lista para visualizar as mensagens</p>
            </div>
        </main>
    </div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQwAQJrd1LGEEABE" type="audio/wav">
    </audio>

    <script>
        // ==================== STATE ====================
        let token = localStorage.getItem('token');
        let conversas = [];
        let conversaAtual = null;
        let ws = null;
        let filtroAtual = 'todas';

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            carregarConversas();
            conectarWebSocket();
            setupMobileMenu();
        });

        // ==================== API CALLS ====================
        async function carregarConversas() {
            try {
                const response = await fetch('/api/conversas', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                conversas = await response.json();
                renderizarConversas();
                carregarStats();
            } catch (error) {
                console.error('Erro ao carregar conversas:', error);
            }
        }

        async function carregarStats() {
            try {
                const response = await fetch('/api/conversas/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const stats = await response.json();

                document.getElementById('statsAtivas').textContent = `${stats.total_ativas + stats.total_assumidas} ativas`;
                document.getElementById('statsNaoLidas').textContent = `${stats.total_nao_lidas} não lidas`;
            } catch (error) {
                console.error('Erro ao carregar stats:', error);
            }
        }

        async function carregarMensagens(conversaId) {
            try {
                const response = await fetch(`/api/conversas/${conversaId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar mensagens');

                const data = await response.json();
                conversaAtual = data;

                renderizarMensagens(data.mensagens);
                atualizarHeader(data);
                mostrarChat();

                // Atualizar lista para remover badge de não lidas
                const conv = conversas.find(c => c.id === conversaId);
                if (conv) conv.nao_lidas = 0;
                renderizarConversas();

            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        async function enviarMensagem(event) {
            event.preventDefault();

            const input = document.getElementById('mensagemInput');
            const conteudo = input.value.trim();

            if (!conteudo || !conversaAtual) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/mensagens`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ conteudo, tipo: 'texto' })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.detail || 'Erro ao enviar mensagem');
                    return;
                }

                const mensagem = await response.json();
                adicionarMensagemUI(mensagem);
                input.value = '';

            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem');
            }
        }

        async function assumirConversa() {
            if (!conversaAtual) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/assumir`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    conversaAtual.status = 'humano_assumiu';
                    atualizarHeader(conversaAtual);
                    atualizarConversaNaLista(conversaAtual.id, 'humano_assumiu');
                }
            } catch (error) {
                console.error('Erro ao assumir conversa:', error);
            }
        }

        async function devolverParaIA() {
            if (!conversaAtual) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/devolver-ia`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    conversaAtual.status = 'ia_ativa';
                    atualizarHeader(conversaAtual);
                    atualizarConversaNaLista(conversaAtual.id, 'ia_ativa');
                }
            } catch (error) {
                console.error('Erro ao devolver para IA:', error);
            }
        }

        async function encerrarConversa() {
            if (!conversaAtual) return;
            if (!confirm('Deseja encerrar esta conversa?')) return;

            try {
                const response = await fetch(`/api/conversas/${conversaAtual.id}/encerrar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // Remover da lista e limpar chat
                    conversas = conversas.filter(c => c.id !== conversaAtual.id);
                    renderizarConversas();
                    esconderChat();
                    conversaAtual = null;
                }
            } catch (error) {
                console.error('Erro ao encerrar conversa:', error);
            }
        }

        // ==================== WEBSOCKET ====================
        function conectarWebSocket() {
            const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/conversas?token=${token}`;

            setWsStatus('connecting');
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                setWsStatus('connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processarEventoWS(data);
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                setWsStatus('disconnected');
                // Reconectar após 3 segundos
                setTimeout(conectarWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('Erro WebSocket:', error);
                setWsStatus('disconnected');
            };
        }

        function setWsStatus(status) {
            const statusEl = document.getElementById('wsStatus');
            const textEl = document.getElementById('wsStatusText');

            statusEl.className = 'ws-status ' + status;

            const texts = {
                'connected': 'Conectado',
                'disconnected': 'Desconectado',
                'connecting': 'Conectando...'
            };
            textEl.textContent = texts[status] || status;
        }

        function processarEventoWS(data) {
            console.log('WS Event:', data);

            switch (data.tipo) {
                case 'nova_mensagem':
                    handleNovaMensagem(data);
                    break;
                case 'conversa_atualizada':
                    handleConversaAtualizada(data);
                    break;
                case 'nova_conversa':
                    handleNovaConversa(data);
                    break;
                case 'conectado':
                    console.log('Conexão confirmada:', data.message);
                    break;
            }
        }

        function handleNovaMensagem(data) {
            // Tocar som se não for a conversa atual ou se vier do paciente
            if (data.mensagem.remetente === 'paciente') {
                tocarNotificacao();
            }

            // Se for a conversa atual, adicionar mensagem
            if (conversaAtual && conversaAtual.id === data.conversa_id) {
                adicionarMensagemUI(data.mensagem);
            }

            // Atualizar lista de conversas
            const conv = conversas.find(c => c.id === data.conversa_id);
            if (conv) {
                conv.ultima_mensagem = data.mensagem.conteudo.substring(0, 50);
                conv.ultima_mensagem_at = data.mensagem.timestamp;
                if (data.mensagem.remetente === 'paciente' && (!conversaAtual || conversaAtual.id !== data.conversa_id)) {
                    conv.nao_lidas = (conv.nao_lidas || 0) + 1;
                }
                // Mover para o topo
                conversas = conversas.filter(c => c.id !== data.conversa_id);
                conversas.unshift(conv);
                renderizarConversas();
            }

            carregarStats();
        }

        function handleConversaAtualizada(data) {
            atualizarConversaNaLista(data.conversa_id, data.status);
            if (conversaAtual && conversaAtual.id === data.conversa_id) {
                conversaAtual.status = data.status;
                atualizarHeader(conversaAtual);
            }
        }

        function handleNovaConversa(data) {
            conversas.unshift(data.conversa);
            renderizarConversas();
            tocarNotificacao();
            carregarStats();
        }

        function tocarNotificacao() {
            try {
                const audio = document.getElementById('notificationSound');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        // ==================== UI RENDERING ====================
        function renderizarConversas() {
            const container = document.getElementById('conversasList');
            let lista = conversas;

            // Aplicar filtro
            if (filtroAtual !== 'todas') {
                lista = conversas.filter(c => c.status === filtroAtual);
            }

            // Aplicar busca
            const busca = document.getElementById('searchInput').value.toLowerCase();
            if (busca) {
                lista = lista.filter(c =>
                    (c.paciente_nome && c.paciente_nome.toLowerCase().includes(busca)) ||
                    c.paciente_telefone.includes(busca)
                );
            }

            if (lista.length === 0) {
                container.innerHTML = `
                    <div class="empty-state py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>Nenhuma conversa encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = lista.map(conv => `
                <div class="conversa-item p-3 cursor-pointer ${conv.id === conversaAtual?.id ? 'active' : ''} ${conv.status === 'humano_assumiu' ? 'humano' : ''}"
                     onclick="selecionarConversa(${conv.id})">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-gray-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-800 truncate">
                                    ${conv.paciente_nome || conv.paciente_telefone}
                                </span>
                                ${conv.nao_lidas > 0 ? `<span class="unread-badge">${conv.nao_lidas}</span>` : ''}
                            </div>
                            <p class="text-sm text-gray-500 truncate">${conv.ultima_mensagem || 'Sem mensagens'}</p>
                            <div class="flex items-center justify-between mt-1">
                                <span class="status-badge ${getStatusClass(conv.status)}">${getStatusLabel(conv.status)}</span>
                                <span class="text-xs text-gray-400">${formatarHora(conv.ultima_mensagem_at)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderizarMensagens(mensagens) {
            const container = document.getElementById('chatMessages');

            if (!mensagens || mensagens.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comment-slash text-4xl mb-2"></i>
                        <p>Nenhuma mensagem ainda</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = mensagens.map(m => criarMensagemHTML(m)).join('');
            container.scrollTop = container.scrollHeight;
        }

        function criarMensagemHTML(m) {
            const isEntrada = m.direcao === 'entrada';
            const remetenteLabel = {
                'paciente': 'Paciente',
                'ia': 'IA',
                'atendente': 'Atendente'
            };

            return `
                <div class="mensagem ${isEntrada ? 'entrada' : 'saida'} ${m.remetente === 'atendente' ? 'atendente' : ''}">
                    <div class="remetente ${m.remetente}">${remetenteLabel[m.remetente] || m.remetente}</div>
                    <div class="conteudo">${escapeHtml(m.conteudo)}</div>
                    <div class="timestamp">${formatarHora(m.timestamp)}</div>
                </div>
            `;
        }

        function adicionarMensagemUI(mensagem) {
            const container = document.getElementById('chatMessages');

            // Remover empty state se existir
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            container.insertAdjacentHTML('beforeend', criarMensagemHTML(mensagem));
            container.scrollTop = container.scrollHeight;
        }

        function atualizarHeader(conversa) {
            document.getElementById('chatNome').textContent = conversa.paciente_nome || 'Paciente';
            document.getElementById('chatTelefone').textContent = conversa.paciente_telefone;

            const statusEl = document.getElementById('chatStatus');
            statusEl.className = `status-badge ${getStatusClass(conversa.status)}`;
            statusEl.textContent = getStatusLabel(conversa.status);

            // Botões
            const btnAssumir = document.getElementById('btnAssumir');
            const btnDevolver = document.getElementById('btnDevolver');
            const inputHint = document.getElementById('inputHint');

            if (conversa.status === 'humano_assumiu') {
                btnAssumir.classList.add('hidden');
                btnDevolver.classList.remove('hidden');
                inputHint.classList.remove('hidden');
            } else {
                btnAssumir.classList.remove('hidden');
                btnDevolver.classList.add('hidden');
                inputHint.classList.add('hidden');
            }
        }

        function atualizarConversaNaLista(conversaId, status) {
            const conv = conversas.find(c => c.id === conversaId);
            if (conv) {
                conv.status = status;
                renderizarConversas();
            }
        }

        // ==================== ACTIONS ====================
        function selecionarConversa(conversaId) {
            carregarMensagens(conversaId);
            // Fechar sidebar em mobile
            document.getElementById('sidebar').classList.remove('open');
        }

        function filtrarConversas(filtro) {
            filtroAtual = filtro;

            // Atualizar botões
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.add('active', 'bg-purple-600', 'text-white');
            event.target.classList.remove('bg-gray-200', 'text-gray-700');

            renderizarConversas();
        }

        function mostrarChat() {
            document.getElementById('chatHeader').classList.remove('hidden');
            document.getElementById('chatInput').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('chatMessages').classList.remove('hidden');
        }

        function esconderChat() {
            document.getElementById('chatHeader').classList.add('hidden');
            document.getElementById('chatInput').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('chatMessages').innerHTML = '';
        }

        function setupMobileMenu() {
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');

            menuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            });
        }

        // ==================== HELPERS ====================
        function getStatusClass(status) {
            return {
                'ia_ativa': 'status-ia',
                'humano_assumiu': 'status-humano',
                'encerrada': 'status-encerrada'
            }[status] || 'status-ia';
        }

        function getStatusLabel(status) {
            return {
                'ia_ativa': 'IA Ativa',
                'humano_assumiu': 'Atendente',
                'encerrada': 'Encerrada'
            }[status] || status;
        }

        function formatarHora(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hoje = new Date();
            const ontem = new Date(hoje);
            ontem.setDate(ontem.getDate() - 1);

            if (date.toDateString() === hoje.toDateString()) {
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } else if (date.toDateString() === ontem.toDateString()) {
                return 'Ontem';
            } else {
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/login.html';
        }

        // Search input listener
        document.getElementById('searchInput').addEventListener('input', renderizarConversas);
    </script>
</body>
</html>
