<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calend√°rio de Agendamentos - Hor√°rio Inteligente</title>

    <!-- Branding Din√¢mico -->
    <script src="/static/branding.js"></script>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Agendamento e Gest√£o de Consultas para Profissionais de Sa√∫de">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hor√°rio Inteligente">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">
    <!-- Design System Components (carregados antes do script principal) -->
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/components/modal.js"></script>
    <style>
        /* ========== CALEND√ÅRIO CUSTOMIZADO MODERNO ========== */
        .cal-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid var(--hi-border-light, #e5e7eb);
        }

        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, var(--hi-primary, #3b82f6) 0%, var(--hi-primary-dark, #2563eb) 100%);
            color: white;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .cal-header {
                flex-direction: column;
                padding: 1rem;
            }
            .cal-nav {
                width: 100%;
                justify-content: center;
            }
            .cal-views {
                width: 100%;
                justify-content: center;
            }
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .cal-nav-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .cal-title {
            font-size: 1.25rem;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .cal-today-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-today-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .cal-views {
            display: flex;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 4px;
        }

        .cal-view-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-view-btn:hover {
            color: white;
        }

        .cal-view-btn.active {
            background: white;
            color: var(--hi-primary, #3b82f6);
        }

        /* Grid do Calend√°rio Mensal */
        .cal-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .cal-weekday {
            padding: 0.875rem 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .cal-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .cal-day {
            min-height: 120px;
            padding: 0.5rem;
            border-right: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .cal-day:nth-child(7n) {
            border-right: none;
        }

        .cal-day:hover {
            background: rgba(16, 185, 129, 0.08);
        }

        .cal-day.other-month {
            background: #fafafa;
        }

        .cal-day.other-month .cal-day-number {
            color: #cbd5e1;
        }

        .cal-day.today {
            background: linear-gradient(135deg, var(--hi-primary-50, #eff6ff) 0%, var(--hi-primary-100, #dbeafe) 100%);
        }

        .cal-day.today .cal-day-number {
            background: linear-gradient(135deg, var(--hi-primary, #3b82f6) 0%, var(--hi-primary-dark, #2563eb) 100%);
            color: white;
        }

        .cal-day-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        .cal-day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 80px;
            overflow: hidden;
        }

        .cal-event {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cal-event:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cal-event-more {
            padding: 2px 8px;
            font-size: 0.7rem;
            color: #6b7280;
            cursor: pointer;
        }

        .cal-event-more:hover {
            color: #667eea;
        }

        /* Visualiza√ß√£o Semanal */
        .cal-week-container {
            display: flex;
            flex-direction: column;
        }

        .cal-week-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .cal-week-header-cell {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-right: 1px solid #f1f5f9;
        }

        .cal-week-header-cell:last-child {
            border-right: none;
        }

        .cal-week-header-day {
            font-size: 0.7rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
        }

        .cal-week-header-date {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 2px;
        }

        .cal-week-header-cell.today .cal-week-header-date {
            background: linear-gradient(135deg, var(--hi-primary, #3b82f6) 0%, var(--hi-primary-dark, #2563eb) 100%);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .cal-week-body {
            display: flex;
            max-height: 600px;
            overflow-y: auto;
        }

        .cal-time-column {
            width: 60px;
            flex-shrink: 0;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
        }

        .cal-time-slot-label {
            height: 60px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            color: #64748b;
        }

        .cal-week-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .cal-week-column {
            border-right: 1px solid #f1f5f9;
            position: relative;
        }

        .cal-week-column:last-child {
            border-right: none;
        }

        .cal-week-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            cursor: pointer;
        }

        .cal-week-slot:hover {
            background: rgba(16, 185, 129, 0.08);
        }

        .cal-week-event {
            position: absolute;
            left: 2px;
            right: 2px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: white;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .cal-week-event:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            z-index: 20;
        }

        .cal-week-event-content {
            display: block;
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Visualiza√ß√£o Di√°ria */
        .cal-day-view {
            display: flex;
            flex-direction: column;
        }

        .cal-day-header {
            padding: 1rem 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
        }

        .cal-day-header-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .cal-day-body {
            display: flex;
            max-height: 600px;
            overflow-y: auto;
        }

        .cal-day-slots {
            flex: 1;
        }

        .cal-day-slot {
            display: flex;
            min-height: 80px;
            border-bottom: 1px solid #f1f5f9;
        }

        .cal-day-slot:hover {
            background: #fafafa;
        }

        .cal-day-slot-time {
            width: 80px;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .cal-day-slot-events {
            flex: 1;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 60px; /* Garante √°rea clic√°vel mesmo sem eventos */
            cursor: pointer;
        }

        .cal-day-slot-events:hover {
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
        }

        .cal-day-event {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cal-day-event:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .cal-day-event-info {
            flex: 1;
        }

        .cal-day-event-title {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .cal-day-event-subtitle {
            font-size: 0.8125rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        .cal-day-event-status {
            padding: 0.375rem 0.75rem;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .cal-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .cal-title {
                font-size: 1rem;
                min-width: auto;
            }

            .cal-views {
                width: 100%;
                justify-content: center;
            }

            .cal-view-btn {
                flex: 1;
                text-align: center;
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .cal-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .cal-day-number {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }

            .cal-event {
                font-size: 0.65rem;
                padding: 2px 4px;
            }

            .cal-weekday {
                font-size: 0.65rem;
                padding: 0.5rem 0.25rem;
            }

            .cal-week-header-date {
                font-size: 1rem;
            }

            .cal-time-column {
                width: 45px;
            }

            .cal-time-slot-label {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .cal-nav-btn {
                width: 36px;
                height: 36px;
            }

            .cal-today-btn {
                display: none;
            }
        }

        /* ========== FIM CALEND√ÅRIO CUSTOMIZADO ========== */

        /* ========== INDICA√á√ÉO DE INDISPONIBILIDADE ========== */

        /* Dia indispon√≠vel (visualiza√ß√£o mensal) */
        .cal-day.indisponivel {
            background: #f1f5f9 !important;
            cursor: not-allowed;
        }
        .cal-day.indisponivel:hover {
            background: #f1f5f9 !important;
        }
        .cal-day.indisponivel .cal-day-number {
            color: #94a3b8;
        }
        .cal-day.indisponivel .cal-day-events {
            opacity: 0.5;
        }

        /* Slot indispon√≠vel (visualiza√ß√£o semanal) */
        .cal-week-slot.indisponivel {
            background: repeating-linear-gradient(
                45deg,
                #f8fafc,
                #f8fafc 5px,
                #f1f5f9 5px,
                #f1f5f9 10px
            );
            cursor: not-allowed;
        }
        .cal-week-slot.indisponivel:hover {
            background: repeating-linear-gradient(
                45deg,
                #f8fafc,
                #f8fafc 5px,
                #f1f5f9 5px,
                #f1f5f9 10px
            );
        }

        /* Slot indispon√≠vel (visualiza√ß√£o di√°ria) */
        .cal-day-slot.indisponivel {
            background: #f8fafc;
        }
        .cal-day-slot.indisponivel .cal-day-slot-events {
            cursor: not-allowed;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(148, 163, 184, 0.1) 5px,
                rgba(148, 163, 184, 0.1) 10px
            );
        }
        .cal-day-slot.indisponivel .cal-day-slot-events:hover {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(148, 163, 184, 0.1) 5px,
                rgba(148, 163, 184, 0.1) 10px
            );
        }
        .cal-day-slot.indisponivel .cal-day-slot-time {
            color: #94a3b8;
        }

        /* Indicador visual de dia bloqueado */
        .cal-day.bloqueado::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }
        .cal-day {
            position: relative;
        }

        /* ========== FIM INDICA√á√ÉO DE INDISPONIBILIDADE ========== */

        /* ========== MELHORIAS DE USABILIDADE ========== */

        /* FAB Nova Consulta */
        .fab-nova-consulta {
            position: fixed;
            bottom: 100px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--hi-success, #10b981), var(--hi-success-dark, #059669));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            animation: fabEntrance 0.4s ease-out 0.5s both;
        }

        .fab-nova-consulta:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .fab-nova-consulta:active {
            transform: translateY(0);
        }

        @media (max-width: 480px) {
            .fab-nova-consulta {
                padding: 18px;
                border-radius: 50%;
                bottom: 80px;
                right: 16px;
            }
            .fab-nova-consulta .fab-text { display: none; }
        }

        @media (min-width: 769px) {
            .fab-nova-consulta { bottom: 24px; }
        }

        @keyframes fabEntrance {
            from { opacity: 0; transform: scale(0.5) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Breadcrumb */
        .breadcrumb-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--hi-gray-50, #f9fafb);
            border-bottom: 1px solid var(--hi-border-light, #e5e7eb);
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--hi-text-secondary, #6b7280);
        }

        .breadcrumb-item.active {
            color: var(--hi-success, #10b981);
            font-weight: 500;
        }

        .breadcrumb-sep {
            font-size: 0.7rem;
            color: var(--hi-gray-300, #d1d5db);
        }

        @media (max-width: 480px) {
            .breadcrumb-nav { padding: 8px 16px; font-size: 0.8rem; }
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge i { font-size: 0.7rem; }

        .status-confirmado { background: #d1fae5; color: #065f46; }
        .status-pendente, .status-agendado { background: #fef3c7; color: #92400e; }
        .status-cancelado { background: #fee2e2; color: #991b1b; }
        .status-faltou { background: #f3f4f6; color: #4b5563; }
        .status-realizado { background: #dbeafe; color: #1e40af; }

        /* Touch-Friendly */
        @media (max-width: 1024px) {
            .hi-btn, .cal-nav-btn, .cal-view-btn, .cal-today-btn {
                min-height: 48px;
                min-width: 48px;
            }

            input, select, textarea {
                min-height: 48px;
                font-size: 16px;
            }

            .cal-day-event, .cal-event {
                min-height: 44px;
                padding: 12px;
            }
        }

        /* ========== FIM MELHORIAS DE USABILIDADE ========== */
    </style>
</head>
<body class="bg-gray-50">
    <!-- Demo Banner (s√≥ aparece em modo demo) -->
    <div id="demoBanner" class="hidden bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 px-4 text-sm">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-center gap-x-4 gap-y-1">
            <span class="inline-flex items-center gap-2">
                <i class="fas fa-flask"></i>
                <span class="hidden sm:inline">Ambiente de Demonstra√ß√£o</span>
                <span class="sm:hidden">Demo</span>
            </span>
            <span class="hidden sm:inline text-white/50">|</span>
            <button onclick="voltarParaDemos()" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-exchange-alt"></i>
                <span>Trocar Perfil</span>
            </button>
            <span class="hidden sm:inline text-white/50">|</span>
            <a href="/static/dashboard-demo.html" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-home"></i>
                <span>Dashboard Demo</span>
            </a>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center flex-1 min-w-0">
                    <h1 class="text-sm sm:text-lg md:text-xl font-semibold text-gray-900 truncate">
                        <i class="fas fa-calendar-alt mr-1 sm:mr-2 text-blue-600"></i>
                        <span class="hidden sm:inline">Calend√°rio de Agendamentos</span>
                        <span class="sm:hidden">Agendamentos</span>
                    </h1>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden sm:flex items-center space-x-1 sm:space-x-2 md:space-x-4">
                    <span id="userInfo" class="hidden md:flex text-xs sm:text-sm text-gray-600 mr-0 sm:mr-2">
                        <i class="fas fa-user-circle mr-1"></i>
                        <span id="userName"></span>
                    </span>
                    <button id="btnPerfil" onclick="window.location.href='/static/perfil.html'" class="inline-flex px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 whitespace-nowrap">
                        <i class="fas fa-user-edit sm:mr-2"></i>
                        <span class="hidden md:inline">Perfil</span>
                    </button>
                    <!-- Bot√£o WhatsApp para Secret√°ria (oculto por padr√£o) -->
                    <button id="btnWhatsAppCal" onclick="window.location.href='/static/conversas.html'" class="hidden inline-flex px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200 whitespace-nowrap">
                        <i class="fab fa-whatsapp sm:mr-2"></i>
                        <span class="hidden md:inline">Conversas</span>
                    </button>
                    <!-- Bot√£o de Instala√ß√£o PWA (oculto por padr√£o) -->
                    <button id="installButton" onclick="instalarApp()" class="hidden px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 whitespace-nowrap shadow-lg">
                        <i class="fas fa-download sm:mr-2"></i>
                        <span class="hidden sm:inline">Instalar App</span>
                    </button>
                    <button onclick="abrirModalAgendamento()" class="px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap">
                        <i class="fas fa-plus sm:mr-2"></i>
                        <span class="hidden sm:inline">Nova Consulta</span>
                    </button>
                    <button onclick="window.location.href='/static/configuracoes.html'" class="inline-flex px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 whitespace-nowrap">
                        <i class="fas fa-cog sm:mr-2"></i>
                        <span class="hidden md:inline">Configura√ß√µes</span>
                    </button>
                    <button id="btnPainel" onclick="window.location.href='/static/dashboard.html'" class="hidden lg:inline-flex px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 whitespace-nowrap">
                        <i class="fas fa-arrow-left sm:mr-2"></i>
                        <span class="hidden md:inline">Painel</span>
                    </button>
                    <button onclick="logout()" class="px-2 sm:px-3 md:px-4 py-1.5 sm:py-2 text-xs sm:text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 whitespace-nowrap">
                        <i class="fas fa-sign-out-alt sm:mr-2"></i>
                        <span class="hidden sm:inline">Sair</span>
                    </button>
                </div>

                <!-- Mobile Menu -->
                <div class="sm:hidden flex items-center space-x-2">
                    <button onclick="abrirModalAgendamento()" class="px-2 py-1.5 text-xs bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button onclick="toggleMobileMenu()" class="px-2 py-1.5 text-xs bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>

            <!-- Mobile Menu Dropdown -->
            <div id="mobileMenu" class="hidden sm:hidden bg-white border-t border-gray-200 py-2">
                <div class="flex flex-col space-y-2">
                    <button id="btnPerfilMobile" onclick="window.location.href='/static/perfil.html'" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                        <i class="fas fa-user-edit mr-3 text-purple-600"></i>
                        Meu Perfil
                    </button>
                    <!-- Bot√£o WhatsApp para Secret√°ria Mobile (oculto por padr√£o) -->
                    <button id="btnWhatsAppMobile" onclick="window.location.href='/static/conversas.html'" class="hidden flex items-center px-4 py-2 text-sm text-green-700 hover:bg-green-50 rounded">
                        <i class="fab fa-whatsapp mr-3 text-green-600"></i>
                        Conversas WhatsApp
                    </button>
                    <button onclick="window.location.href='/static/configuracoes.html'" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                        <i class="fas fa-cog mr-3 text-indigo-600"></i>
                        Configura√ß√µes
                    </button>
                    <button id="btnPainelMobile" onclick="window.location.href='/static/dashboard.html'" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                        <i class="fas fa-arrow-left mr-3 text-gray-600"></i>
                        Dashboard
                    </button>
                    <!-- Bot√£o de Instala√ß√£o PWA para Mobile -->
                    <button id="installButtonMobile" onclick="instalarApp()" class="hidden flex items-center px-4 py-2 text-sm bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 rounded mx-2">
                        <i class="fas fa-download mr-3"></i>
                        Instalar App
                    </button>
                    <div class="border-t border-gray-200 my-1"></div>
                    <button onclick="logout()" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded">
                        <i class="fas fa-sign-out-alt mr-3"></i>
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb de Navega√ß√£o -->
    <nav class="breadcrumb-nav" aria-label="Navega√ß√£o">
        <span class="breadcrumb-item">
            <i class="fas fa-home"></i> Hor√°rio Inteligente
        </span>
        <i class="fas fa-chevron-right breadcrumb-sep"></i>
        <span class="breadcrumb-item active">
            <i class="fas fa-calendar-alt"></i> Calend√°rio
        </span>
    </nav>

    <!-- Filtro e Legenda -->
    <div class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8 mt-3 sm:mt-6">
        <!-- Filtro por M√©dico -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-3 sm:mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                <label class="text-xs sm:text-sm font-medium text-gray-700 whitespace-nowrap">Filtrar por m√©dico:</label>
                <select id="filtroMedico" onchange="aplicarFiltroMedico()"
                        class="w-full sm:w-auto px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="0">üìã Todos os m√©dicos</option>
                </select>
            </div>
        </div>

        <!-- Legenda por M√©dico -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-4 sm:mb-6">
            <h3 class="text-xs sm:text-sm font-medium text-gray-700 mb-2 sm:mb-3">Legenda por M√©dico:</h3>
            <div id="legendaMedicos" class="flex flex-wrap gap-2 sm:gap-3 md:gap-4 text-xs sm:text-sm">
                <!-- Ser√° preenchido dinamicamente -->
            </div>
        </div>

        <!-- Calend√°rio Customizado Moderno -->
        <div class="cal-container" id="calendarioContainer">
            <!-- Header do Calend√°rio -->
            <div class="cal-header">
                <div class="cal-nav">
                    <button class="cal-nav-btn" onclick="navegarCalendario(-1)" title="Anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="cal-title" id="calTitle">Janeiro 2025</span>
                    <button class="cal-nav-btn" onclick="navegarCalendario(1)" title="Pr√≥ximo">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="cal-today-btn" onclick="irParaHoje()">
                        <i class="fas fa-calendar-day mr-2"></i>Hoje
                    </button>
                </div>
                <div class="cal-views">
                    <button class="cal-view-btn active" data-view="month" onclick="mudarVisualizacao('month')">M√™s</button>
                    <button class="cal-view-btn" data-view="week" onclick="mudarVisualizacao('week')">Semana</button>
                    <button class="cal-view-btn" data-view="day" onclick="mudarVisualizacao('day')">Dia</button>
                </div>
            </div>

            <!-- Conte√∫do do Calend√°rio -->
            <div id="calContent">
                <!-- Visualiza√ß√£o Mensal (padr√£o) -->
                <div id="calMonthView">
                    <div class="cal-weekdays">
                        <div class="cal-weekday">Dom</div>
                        <div class="cal-weekday">Seg</div>
                        <div class="cal-weekday">Ter</div>
                        <div class="cal-weekday">Qua</div>
                        <div class="cal-weekday">Qui</div>
                        <div class="cal-weekday">Sex</div>
                        <div class="cal-weekday">S√°b</div>
                    </div>
                    <div class="cal-days" id="calDays">
                        <!-- Dias ser√£o gerados dinamicamente -->
                    </div>
                </div>

                <!-- Visualiza√ß√£o Semanal -->
                <div id="calWeekView" style="display: none;">
                    <div class="cal-week-container">
                        <div class="cal-week-header" id="calWeekHeader">
                            <!-- Header da semana ser√° gerado dinamicamente -->
                        </div>
                        <div class="cal-week-body">
                            <div class="cal-time-column" id="calTimeColumn">
                                <!-- Hor√°rios ser√£o gerados dinamicamente -->
                            </div>
                            <div class="cal-week-grid" id="calWeekGrid">
                                <!-- Grid da semana ser√° gerado dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualiza√ß√£o Di√°ria -->
                <div id="calDayView" style="display: none;">
                    <div class="cal-day-view">
                        <div class="cal-day-header">
                            <div class="cal-day-header-title" id="calDayTitle">Sexta-feira, 3 de Janeiro</div>
                        </div>
                        <div class="cal-day-body">
                            <div class="cal-day-slots" id="calDaySlots">
                                <!-- Slots ser√£o gerados dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento -->
    <div id="modalAgendamento" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-2 sm:mt-3">
                <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">
                    Nova Consulta
                </h3>

                <form id="formAgendamento" class="space-y-3 sm:space-y-4">
                    <!-- Nome do Paciente -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                            Nome do Paciente *
                        </label>
                        <input type="text" id="paciente_nome" name="paciente_nome"
                               class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Jo√£o Silva" required>
                    </div>

                    <!-- Telefone -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                            Telefone (WhatsApp) *
                        </label>
                        <input type="tel" id="paciente_telefone" name="paciente_telefone"
                               class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="(21) 99999-9999"
                               maxlength="15"
                               pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}"
                               title="Formato: (XX) XXXXX-XXXX"
                               required>
                        <span class="text-xs text-gray-500 mt-1">Formato: (XX) XXXXX-XXXX</span>
                    </div>

                    <!-- M√©dico -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                            M√©dico *
                        </label>
                        <select id="medico_id" name="medico_id"
                                onchange="verificarHorariosDisponiveis(); carregarFormasPagamento();"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="1">Dra. T√¢nia Maria - Alergista</option>
                            <option value="2">Dr. Marco Aur√©lio - Cardiologista</option>
                        </select>
                    </div>

                    <!-- Forma de Pagamento -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                            Forma de Pagamento *
                        </label>
                        <select id="convenio_id" name="convenio_id"
                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <!-- Data, Hora e Dura√ß√£o -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                                Data *
                            </label>
                            <input type="date" id="data" name="data"
                                   onchange="verificarHorariosDisponiveis()"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                                Hora *
                            </label>
                            <input type="time" id="hora" name="hora"
                                   onchange="verificarDisponibilidadeHorario()"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="col-span-2 sm:col-span-1">
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                                Dura√ß√£o (min)
                            </label>
                            <input type="number" id="duracao_minutos" name="duracao_minutos"
                                   value="30" min="5" max="480" step="5"
                                   onchange="verificarHorariosDisponiveis()"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <span class="text-xs text-gray-500">Padr√£o: 30 min</span>
                        </div>
                    </div>

                    <!-- Indicador de Disponibilidade -->
                    <div id="indicadorDisponibilidade" class="hidden p-2 sm:p-3 rounded-md text-xs sm:text-sm">
                        <span id="mensagemDisponibilidade"></span>
                    </div>

                    <!-- Hor√°rios Dispon√≠veis -->
                    <div id="horariosDisponiveisContainer" class="hidden">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>
                            Hor√°rios Dispon√≠veis:
                        </label>
                        <div id="horariosDisponiveis" class="grid grid-cols-3 sm:grid-cols-4 gap-1.5 sm:gap-2">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- Motivo -->
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                            Motivo da Consulta
                        </label>
                        <textarea id="motivo_consulta" name="motivo_consulta"
                                  class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  rows="2" placeholder="Consulta de rotina..."></textarea>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-end gap-2 sm:gap-0 sm:space-x-3">
                        <button type="button" onclick="fecharModal()"
                                class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-xs sm:text-sm font-medium rounded-md hover:bg-gray-300 order-2 sm:order-1">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-blue-700 order-1 sm:order-2">
                            Agendar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Agendamento -->
    <div id="modalDetalhes" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-20 mx-auto p-3 sm:p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white max-h-[95vh] overflow-y-auto">
            <div class="mt-2 sm:mt-3">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-base sm:text-xl font-medium text-gray-900">
                        <i class="fas fa-calendar-check mr-1 sm:mr-2 text-blue-600"></i>
                        <span class="hidden sm:inline">Detalhes do Agendamento</span>
                        <span class="sm:hidden">Detalhes</span>
                    </h3>
                    <button onclick="fecharModalDetalhes()" class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fas fa-times text-lg sm:text-xl"></i>
                    </button>
                </div>

                <!-- Informa√ß√µes do Agendamento -->
                <div id="detalhesContent" class="space-y-3 sm:space-y-4">
                    <!-- Informa√ß√µes do Paciente -->
                    <div class="bg-blue-50 rounded-lg p-3 sm:p-4">
                        <h4 class="font-semibold text-sm sm:text-base text-gray-700 mb-2 sm:mb-3 flex items-center">
                            <i class="fas fa-user mr-1 sm:mr-2 text-blue-600"></i>
                            Paciente
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs sm:text-sm">
                            <div>
                                <span class="text-gray-600">Nome:</span>
                                <p class="font-medium" id="det_paciente_nome"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Telefone:</span>
                                <p class="font-medium" id="det_paciente_telefone"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes da Consulta -->
                    <div class="bg-green-50 rounded-lg p-3 sm:p-4">
                        <h4 class="font-semibold text-sm sm:text-base text-gray-700 mb-2 sm:mb-3 flex items-center">
                            <i class="fas fa-calendar-alt mr-1 sm:mr-2 text-green-600"></i>
                            Consulta
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs sm:text-sm">
                            <div>
                                <span class="text-gray-600">M√©dico:</span>
                                <p class="font-medium break-words" id="det_medico"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Especialidade:</span>
                                <p class="font-medium" id="det_especialidade"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Data:</span>
                                <p class="font-medium" id="det_data"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Hor√°rio:</span>
                                <p class="font-medium" id="det_hora"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Dura√ß√£o:</span>
                                <p class="font-medium" id="det_duracao"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Status:</span>
                                <p class="font-medium" id="det_status"></p>
                            </div>
                            <div>
                                <span class="text-gray-600">Tipo:</span>
                                <p class="font-medium" id="det_tipo"></p>
                            </div>
                        </div>
                        <div class="mt-2 sm:mt-3">
                            <span class="text-gray-600 text-xs sm:text-sm">Motivo:</span>
                            <p class="font-medium text-xs sm:text-sm break-words" id="det_motivo"></p>
                        </div>
                    </div>

                    <!-- Informa√ß√µes de Pagamento -->
                    <div class="bg-purple-50 rounded-lg p-3 sm:p-4">
                        <h4 class="font-semibold text-sm sm:text-base text-gray-700 mb-2 sm:mb-3 flex items-center">
                            <i class="fas fa-credit-card mr-1 sm:mr-2 text-purple-600"></i>
                            Pagamento
                        </h4>
                        <div class="text-xs sm:text-sm">
                            <span class="text-gray-600">Forma de Pagamento:</span>
                            <p class="font-medium" id="det_forma_pagamento"></p>
                        </div>
                    </div>

                    <!-- ID do Agendamento (oculto) -->
                    <input type="hidden" id="det_agendamento_id">
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-2">
                    <button onclick="fecharModalDetalhes()"
                            class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-gray-200 text-gray-800 text-xs sm:text-sm font-medium rounded-md hover:bg-gray-300 order-3 sm:order-1">
                        <i class="fas fa-times mr-1 sm:mr-2"></i>
                        Fechar
                    </button>
                    <div class="flex flex-col sm:flex-row gap-2 order-1 sm:order-2">
                        <button onclick="abrirReagendamento()"
                                class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-blue-600 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-blue-700 whitespace-nowrap">
                            <i class="fas fa-calendar mr-1 sm:mr-2"></i>
                            Reagendar
                        </button>
                        <button onclick="marcarComoFalta()" id="btnMarcarFalta"
                                class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-yellow-600 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-yellow-700 whitespace-nowrap">
                            <i class="fas fa-user-times mr-1 sm:mr-2"></i>
                            <span class="hidden sm:inline">Marcar Falta</span>
                            <span class="sm:hidden">Falta</span>
                        </button>
                        <button onclick="confirmarCancelamento()"
                                class="w-full sm:w-auto px-3 sm:px-4 py-2 bg-red-600 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-red-700 whitespace-nowrap">
                            <i class="fas fa-times-circle mr-1 sm:mr-2"></i>
                            <span class="hidden sm:inline">Cancelar Consulta</span>
                            <span class="sm:hidden">Cancelar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Reagendamento -->
    <div id="modalReagendamento" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-2 sm:p-0">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-2 sm:mt-3">
                <h3 class="text-base sm:text-lg font-medium text-gray-900 mb-3 sm:mb-4">
                    <i class="fas fa-calendar-alt mr-1 sm:mr-2 text-blue-600"></i>
                    Reagendar Consulta
                </h3>

                <form id="formReagendamento" class="space-y-3 sm:space-y-4">
                    <!-- Nova Data e Hora -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                                Nova Data *
                            </label>
                            <input type="date" id="reagendar_data" name="reagendar_data"
                                   onchange="verificarHorariosDisponiveisReagendamento()"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">
                                Nova Hora *
                            </label>
                            <input type="time" id="reagendar_hora" name="reagendar_hora"
                                   class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>

                    <!-- Hor√°rios Dispon√≠veis -->
                    <div id="horariosDisponiveisReagendamento" class="hidden">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-clock mr-1"></i>
                            Hor√°rios Dispon√≠veis:
                        </label>
                        <div id="horariosListReagendamento" class="grid grid-cols-3 sm:grid-cols-4 gap-1.5 sm:gap-2">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>

                    <!-- Bot√µes -->
                    <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-end gap-2 sm:gap-0 sm:space-x-3">
                        <button type="button" onclick="fecharModalReagendamento()"
                                class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-xs sm:text-sm font-medium rounded-md hover:bg-gray-300 order-2 sm:order-1">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-blue-700 order-1 sm:order-2 whitespace-nowrap">
                            <i class="fas fa-check mr-1 sm:mr-2"></i>
                            <span class="hidden sm:inline">Confirmar Reagendamento</span>
                            <span class="sm:hidden">Confirmar</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // UTILIDADE: ESCAPE HTML (Preven√ß√£o XSS)
        // ==========================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
        // ==========================================
        let authToken = null;
        let currentUser = null;

        // Verificar autentica√ß√£o ao carregar a p√°gina
        (async function checkAuth() {
            authToken = localStorage.getItem('authToken');

            if (!authToken) {
                // N√£o est√° logado, redirecionar para login
                window.location.href = '/static/login.html';
                return;
            }

            try {
                // Buscar dados atualizados do usu√°rio
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Token inv√°lido');
                }

                currentUser = await response.json();
                console.log('Usu√°rio autenticado:', currentUser);

                // Exibir nome do usu√°rio no header
                const userNameEl = document.getElementById('userName');
                if (currentUser.tipo === 'medico') {
                    userNameEl.textContent = `Dr(a). ${currentUser.nome}`;
                } else if (currentUser.is_secretaria) {
                    userNameEl.textContent = `${currentUser.nome} (Secret√°ria)`;
                } else {
                    userNameEl.textContent = currentUser.nome;
                }

                // Ocultar filtro de m√©dico se usu√°rio for m√©dico (v√™ apenas sua agenda)
                if (currentUser.tipo === 'medico') {
                    const filtroContainer = document.querySelector('.bg-white.rounded-lg.shadow-sm.p-4.mb-4');
                    if (filtroContainer) {
                        filtroContainer.style.display = 'none';
                    }
                }

                // Configurar navega√ß√£o para secret√°ria
                if (currentUser.is_secretaria) {
                    configurarNavegacaoSecretaria();
                }

            } catch (error) {
                console.error('Erro na autentica√ß√£o:', error);
                // Limpar storage e redirecionar
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                window.location.href = '/static/login.html';
            }
        })();

        // ==========================================
        // M√ÅSCARA DE TELEFONE (WhatsApp)
        // ==========================================
        function aplicarMascaraTelefone(input) {
            let valor = input.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero

            if (valor.length > 11) {
                valor = valor.substring(0, 11); // Limita a 11 d√≠gitos
            }

            // Aplica a m√°scara progressivamente
            if (valor.length > 0) {
                valor = '(' + valor;
            }
            if (valor.length > 3) {
                valor = valor.substring(0, 3) + ') ' + valor.substring(3);
            }
            if (valor.length > 10) {
                valor = valor.substring(0, 10) + '-' + valor.substring(10);
            }

            input.value = valor;
        }

        // Validar formato do telefone
        function validarTelefone(telefone) {
            const regex = /^\([0-9]{2}\) [0-9]{5}-[0-9]{4}$/;
            return regex.test(telefone);
        }

        // Extrair apenas n√∫meros do telefone (para enviar ao backend)
        function extrairNumerosTelefone(telefone) {
            return telefone.replace(/\D/g, '');
        }

        // Inicializar m√°scara de telefone quando o DOM carregar
        document.addEventListener('DOMContentLoaded', function() {
            const telefoneInput = document.getElementById('paciente_telefone');
            if (telefoneInput) {
                telefoneInput.addEventListener('input', function() {
                    aplicarMascaraTelefone(this);
                });

                // Tamb√©m aplicar ao colar
                telefoneInput.addEventListener('paste', function(e) {
                    setTimeout(() => aplicarMascaraTelefone(this), 10);
                });
            }
        });

        // Fun√ß√£o de logout
        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                window.location.href = '/static/login.html';
            }
        }

        // Configurar navega√ß√£o para secret√°ria
        function configurarNavegacaoSecretaria() {
            // Desktop: Esconder bot√£o Perfil (secret√°ria n√£o tem perfil pr√≥prio)
            const btnPerfil = document.getElementById('btnPerfil');
            if (btnPerfil) {
                btnPerfil.style.display = 'none';
            }

            // Desktop: Esconder bot√£o Painel/Dashboard
            const btnPainel = document.getElementById('btnPainel');
            if (btnPainel) {
                btnPainel.style.display = 'none';
            }

            // Desktop: Mostrar bot√£o WhatsApp/Conversas
            const btnWhatsApp = document.getElementById('btnWhatsAppCal');
            if (btnWhatsApp) {
                btnWhatsApp.classList.remove('hidden');
            }

            // Mobile: Esconder bot√£o Perfil
            const btnPerfilMobile = document.getElementById('btnPerfilMobile');
            if (btnPerfilMobile) {
                btnPerfilMobile.style.display = 'none';
            }

            // Mobile: Esconder bot√£o Painel/Dashboard
            const btnPainelMobile = document.getElementById('btnPainelMobile');
            if (btnPainelMobile) {
                btnPainelMobile.style.display = 'none';
            }

            // Mobile: Mostrar bot√£o WhatsApp
            const btnWhatsAppMobile = document.getElementById('btnWhatsAppMobile');
            if (btnWhatsAppMobile) {
                btnWhatsAppMobile.classList.remove('hidden');
            }

            console.log('Navega√ß√£o configurada para secret√°ria');
        }

        // Fun√ß√£o para toggle do menu mobile
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
            } else {
                mobileMenu.classList.add('hidden');
            }
        }

        // Fechar menu mobile ao clicar fora
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = event.target.closest('button[onclick="toggleMobileMenu()"]');

            if (!menuButton && !mobileMenu.contains(event.target)) {
                if (!mobileMenu.classList.contains('hidden')) {
                    mobileMenu.classList.add('hidden');
                }
            }
        });

        // Fun√ß√£o para fazer requisi√ß√µes autenticadas
        async function fetchAuth(url, options = {}) {
            const token = localStorage.getItem('authToken');

            if (!token) {
                window.location.href = '/static/login.html';
                return;
            }

            // Adicionar header de autentica√ß√£o
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            const response = await fetch(url, options);

            // Se receber 401, redirecionar para login
            if (response.status === 401) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                window.location.href = '/static/login.html';
                return;
            }

            return response;
        }

        // ==========================================
        // CALEND√ÅRIO
        // ==========================================
        let calendar;
        let selectedDate = null;
        let medicosData = []; // Armazenar dados dos m√©dicos
        let todosEventos = []; // Armazenar todos os eventos

        // ==========================================
        // DISPONIBILIDADE - Vari√°veis para indica√ß√£o visual
        // ==========================================
        let configMedicoSelecionado = null;  // Configura√ß√µes de hor√°rios do m√©dico
        let bloqueiosPeriodo = [];           // Bloqueios do per√≠odo vis√≠vel

        // Paleta de cores para m√©dicos (cores distintas e agrad√°veis)
        const coresMedicos = [
            '#3b82f6', // Azul
            '#10b981', // Verde
            '#f59e0b', // Laranja
            '#8b5cf6', // Roxo
            '#ec4899', // Rosa
            '#14b8a6', // Teal
            '#f97316', // Laranja escuro
            '#06b6d4'  // Ciano
        ];

        // Inicializar calend√°rio quando a p√°gina carregar
       document.addEventListener('DOMContentLoaded', async function() {
           inicializarCalendario();
           await carregarMedicos(); // AGUARDAR m√©dicos carregarem primeiro
           await carregarEventos(); // DEPOIS carregar eventos com as cores corretas

           // Mostrar banner de demo se estiver em modo demo
           if (localStorage.getItem('demo_mode') === 'true') {
               const demoBanner = document.getElementById('demoBanner');
               if (demoBanner) {
                   demoBanner.classList.remove('hidden');
               }
           }
        });

        // Fun√ß√£o para voltar para sele√ß√£o de demos
        function voltarParaDemos() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('medico');
            localStorage.removeItem('cliente_id');
            localStorage.removeItem('demo_mode');
            localStorage.removeItem('demo_tour_done');
            window.location.href = '/static/demo/index.html';
        }

        // ========== PWA: Instala√ß√£o do App ==========
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const installButtonMobile = document.getElementById('installButtonMobile');

        // Capturar o evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir o prompt autom√°tico
            e.preventDefault();
            // Guardar o evento para usar depois
            deferredPrompt = e;
            // Mostrar os bot√µes de instala√ß√£o (desktop e mobile)
            if (installButton) {
                installButton.classList.remove('hidden');
            }
            if (installButtonMobile) {
                installButtonMobile.classList.remove('hidden');
            }
            console.log('‚úÖ PWA: Bot√µes de instala√ß√£o mostrados');
        });

        // Fun√ß√£o para instalar o app
        async function instalarApp() {
            if (!deferredPrompt) {
                console.log('‚ö†Ô∏è PWA: Prompt de instala√ß√£o n√£o dispon√≠vel');
                alert('Este aplicativo j√° est√° instalado ou n√£o pode ser instalado neste navegador.');
                return;
            }

            // Mostrar o prompt de instala√ß√£o
            deferredPrompt.prompt();

            // Aguardar a escolha do usu√°rio
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                console.log('‚úÖ PWA: Usu√°rio aceitou a instala√ß√£o');
                // Ocultar os bot√µes ap√≥s instala√ß√£o
                if (installButton) {
                    installButton.classList.add('hidden');
                }
                if (installButtonMobile) {
                    installButtonMobile.classList.add('hidden');
                }
            } else {
                console.log('‚ùå PWA: Usu√°rio recusou a instala√ß√£o');
            }

            // Limpar o prompt
            deferredPrompt = null;
        }

        // Detectar quando o app foi instalado
        window.addEventListener('appinstalled', () => {
            console.log('üéâ PWA: App instalado com sucesso!');
            // Ocultar os bot√µes
            if (installButton) {
                installButton.classList.add('hidden');
            }
            if (installButtonMobile) {
                installButtonMobile.classList.add('hidden');
            }
            deferredPrompt = null;
        });

        // ==========================================
        // CALEND√ÅRIO CUSTOMIZADO MODERNO
        // ==========================================
        let currentDate = new Date();
        let currentView = 'month'; // month, week, day
        const MESES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const DIAS_SEMANA = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
        const DIAS_SEMANA_FULL = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira',
                                   'Quinta-feira', 'Sexta-feira', 'S√°bado'];
        const HORA_INICIO = 7;
        const HORA_FIM = 20;

        function inicializarCalendario() {
            // USABILIDADE: Vis√£o di√°ria como padr√£o para todos
            // Mais √∫til para secret√°rias e m√©dicos no dia a dia
            currentView = 'day';

            // Renderizar o calend√°rio
            renderizarCalendario();

            // Atualizar bot√µes de visualiza√ß√£o
            atualizarBotoesVisualizacao();
        }

        function atualizarBotoesVisualizacao() {
            document.querySelectorAll('.cal-view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === currentView) {
                    btn.classList.add('active');
                }
            });
        }

        async function navegarCalendario(direcao) {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direcao);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direcao * 7));
            } else if (currentView === 'day') {
                currentDate.setDate(currentDate.getDate() + direcao);
            }

            // Recarregar bloqueios para o novo per√≠odo se h√° m√©dico selecionado
            const medicoSelecionado = parseInt(document.getElementById('filtroMedico')?.value || 0);
            if (medicoSelecionado > 0) {
                await carregarBloqueiosPeriodo(medicoSelecionado);
            }

            renderizarCalendario();
        }

        async function irParaHoje() {
            currentDate = new Date();

            // Recarregar bloqueios para o novo per√≠odo se h√° m√©dico selecionado
            const medicoSelecionado = parseInt(document.getElementById('filtroMedico')?.value || 0);
            if (medicoSelecionado > 0) {
                await carregarBloqueiosPeriodo(medicoSelecionado);
            }

            renderizarCalendario();
        }

        function mudarVisualizacao(view) {
            currentView = view;
            atualizarBotoesVisualizacao();
            renderizarCalendario();
        }

        function renderizarCalendario() {
            // Atualizar t√≠tulo
            atualizarTituloCalendario();

            // Esconder todas as views
            document.getElementById('calMonthView').style.display = 'none';
            document.getElementById('calWeekView').style.display = 'none';
            document.getElementById('calDayView').style.display = 'none';

            // Mostrar view atual
            if (currentView === 'month') {
                document.getElementById('calMonthView').style.display = 'block';
                renderizarMes();
            } else if (currentView === 'week') {
                document.getElementById('calWeekView').style.display = 'block';
                renderizarSemana();
            } else if (currentView === 'day') {
                document.getElementById('calDayView').style.display = 'block';
                renderizarDia();
            }
        }

        function atualizarTituloCalendario() {
            const titulo = document.getElementById('calTitle');
            if (currentView === 'month') {
                titulo.textContent = `${MESES[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            } else if (currentView === 'week') {
                const inicioSemana = new Date(currentDate);
                inicioSemana.setDate(currentDate.getDate() - currentDate.getDay());
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);
                titulo.textContent = `${inicioSemana.getDate()} - ${fimSemana.getDate()} ${MESES[fimSemana.getMonth()]} ${fimSemana.getFullYear()}`;
            } else if (currentView === 'day') {
                titulo.textContent = `${DIAS_SEMANA_FULL[currentDate.getDay()]}, ${currentDate.getDate()} de ${MESES[currentDate.getMonth()]}`;
            }
        }

        function renderizarMes() {
            const calDays = document.getElementById('calDays');
            calDays.innerHTML = '';

            const ano = currentDate.getFullYear();
            const mes = currentDate.getMonth();

            // Primeiro dia do m√™s
            const primeiroDia = new Date(ano, mes, 1);
            // √öltimo dia do m√™s
            const ultimoDia = new Date(ano, mes + 1, 0);

            // Dias do m√™s anterior para preencher
            const diasAnterior = primeiroDia.getDay();
            const ultimoDiaAnterior = new Date(ano, mes, 0).getDate();

            // Hoje
            const hoje = new Date();
            const isHoje = (d, m, a) => d === hoje.getDate() && m === hoje.getMonth() && a === hoje.getFullYear();

            // Dias do m√™s anterior
            for (let i = diasAnterior - 1; i >= 0; i--) {
                const dia = ultimoDiaAnterior - i;
                const divDia = criarDiaCalendario(dia, mes - 1, ano, true);
                calDays.appendChild(divDia);
            }

            // Dias do m√™s atual
            for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
                const divDia = criarDiaCalendario(dia, mes, ano, false, isHoje(dia, mes, ano));
                calDays.appendChild(divDia);
            }

            // Dias do pr√≥ximo m√™s para completar
            const diasRestantes = 42 - (diasAnterior + ultimoDia.getDate());
            for (let dia = 1; dia <= diasRestantes; dia++) {
                const divDia = criarDiaCalendario(dia, mes + 1, ano, true);
                calDays.appendChild(divDia);
            }

            // Adicionar eventos
            adicionarEventosAoMes();
        }

        function criarDiaCalendario(dia, mes, ano, outroMes = false, isHoje = false) {
            const divDia = document.createElement('div');
            divDia.className = 'cal-day';
            if (outroMes) divDia.classList.add('other-month');
            if (isHoje) divDia.classList.add('today');

            // Ajustar m√™s para data correta
            let dataCorreta = new Date(ano, mes, dia);
            divDia.dataset.date = dataCorreta.toISOString().split('T')[0];

            // Verificar disponibilidade do dia
            const disponivel = verificarDiaDisponivel(dataCorreta);
            const bloqueado = verificarDataBloqueada(dataCorreta);

            if (!disponivel) {
                divDia.classList.add('indisponivel');
            }
            if (bloqueado) {
                divDia.classList.add('bloqueado');
            }

            const spanNum = document.createElement('span');
            spanNum.className = 'cal-day-number';
            spanNum.textContent = dia;
            divDia.appendChild(spanNum);

            const divEventos = document.createElement('div');
            divEventos.className = 'cal-day-events';
            divDia.appendChild(divEventos);

            // Click para criar novo agendamento - apenas se dispon√≠vel
            if (disponivel) {
                divDia.addEventListener('click', (e) => {
                    if (e.target.classList.contains('cal-event') || e.target.closest('.cal-event')) return;
                    const data = divDia.dataset.date;
                    selectedDate = data;
                    document.getElementById('data').value = data;
                    document.getElementById('hora').value = '09:00';
                    abrirModalAgendamento();
                });
            }

            return divDia;
        }

        function adicionarEventosAoMes() {
            if (!todosEventos || todosEventos.length === 0) return;

            // Agrupar eventos por data LOCAL (convertendo de UTC)
            const eventosPorData = {};
            todosEventos.forEach(evento => {
                const dataEvento = new Date(evento.start);
                // Usar data LOCAL, n√£o UTC
                const data = `${dataEvento.getFullYear()}-${String(dataEvento.getMonth() + 1).padStart(2, '0')}-${String(dataEvento.getDate()).padStart(2, '0')}`;
                if (!eventosPorData[data]) eventosPorData[data] = [];
                eventosPorData[data].push(evento);
            });

            // Adicionar eventos aos dias
            Object.keys(eventosPorData).forEach(data => {
                const divDia = document.querySelector(`.cal-day[data-date="${data}"]`);
                if (!divDia) return;

                const divEventos = divDia.querySelector('.cal-day-events');
                const eventos = eventosPorData[data];

                // Mostrar at√© 3 eventos
                eventos.slice(0, 3).forEach(evento => {
                    const divEvento = criarEventoMes(evento);
                    divEventos.appendChild(divEvento);
                });

                // Se houver mais eventos
                if (eventos.length > 3) {
                    const divMore = document.createElement('div');
                    divMore.className = 'cal-event-more';
                    divMore.textContent = `+${eventos.length - 3} mais`;
                    divMore.onclick = (e) => {
                        e.stopPropagation();
                        currentDate = new Date(data);
                        mudarVisualizacao('day');
                    };
                    divEventos.appendChild(divMore);
                }
            });
        }

        function criarEventoMes(evento) {
            const div = document.createElement('div');
            div.className = 'cal-event';

            // Determinar cor
            let cor = '#3b82f6';
            if (String(evento.id).startsWith('bl_')) {
                cor = '#ef4444';
            } else if (evento.extendedProps?.status === 'faltou') {
                cor = '#f59e0b';
            } else if (['cancelado', 'cancelada'].includes(evento.extendedProps?.status)) {
                cor = '#9ca3af';
            } else if (['realizado', 'realizada', 'concluido', 'concluida'].includes(evento.extendedProps?.status)) {
                cor = '#10b981';
            } else if (evento.medico_id) {
                cor = getCorMedico(evento.medico_id);
            }

            div.style.background = cor;

            // Converter para hora LOCAL
            const dataEvento = new Date(evento.start);
            const hora = `${dataEvento.getHours().toString().padStart(2, '0')}:${dataEvento.getMinutes().toString().padStart(2, '0')}`;
            const paciente = evento.extendedProps?.paciente || evento.title?.split(' - ')[0] || 'Paciente';
            div.textContent = `${hora} ${paciente}`;
            div.title = `${hora} - ${paciente}`;

            // Click para abrir detalhes
            div.addEventListener('click', async (e) => {
                e.stopPropagation();
                const eventId = String(evento.id);
                if (eventId.startsWith('bl_')) {
                    alert('Este √© um hor√°rio bloqueado');
                } else {
                    const agendamentoId = eventId.replace('ag_', '');
                    await abrirDetalhesAgendamento(evento.id);
                }
            });

            return div;
        }

        function renderizarSemana() {
            // Calcular in√≠cio da semana (domingo)
            const inicioSemana = new Date(currentDate);
            inicioSemana.setDate(currentDate.getDate() - currentDate.getDay());

            const hoje = new Date();

            // Header da semana
            const header = document.getElementById('calWeekHeader');
            header.innerHTML = '<div class="cal-week-header-cell"></div>'; // C√©lula vazia para coluna de tempo

            for (let i = 0; i < 7; i++) {
                const dia = new Date(inicioSemana);
                dia.setDate(inicioSemana.getDate() + i);

                const isToday = dia.toDateString() === hoje.toDateString();

                const cell = document.createElement('div');
                cell.className = 'cal-week-header-cell' + (isToday ? ' today' : '');
                cell.innerHTML = `
                    <div class="cal-week-header-day">${DIAS_SEMANA[i]}</div>
                    <div class="cal-week-header-date">${dia.getDate()}</div>
                `;
                header.appendChild(cell);
            }

            // Coluna de tempo
            const timeColumn = document.getElementById('calTimeColumn');
            timeColumn.innerHTML = '';

            for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
                const slot = document.createElement('div');
                slot.className = 'cal-time-slot-label';
                slot.textContent = `${hora.toString().padStart(2, '0')}:00`;
                timeColumn.appendChild(slot);
            }

            // Grid da semana
            const grid = document.getElementById('calWeekGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const dia = new Date(inicioSemana);
                dia.setDate(inicioSemana.getDate() + i);
                const dataStr = dia.toISOString().split('T')[0];

                const coluna = document.createElement('div');
                coluna.className = 'cal-week-column';
                coluna.dataset.date = dataStr;

                for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
                    const slot = document.createElement('div');
                    slot.className = 'cal-week-slot';
                    slot.dataset.hour = hora;

                    // Verificar disponibilidade do hor√°rio
                    const disponivel = verificarHorarioDisponivel(dia, hora);
                    if (!disponivel) {
                        slot.classList.add('indisponivel');
                    } else {
                        slot.addEventListener('click', () => {
                            selectedDate = dataStr;
                            document.getElementById('data').value = dataStr;
                            document.getElementById('hora').value = `${hora.toString().padStart(2, '0')}:00`;
                            abrirModalAgendamento();
                        });
                    }

                    coluna.appendChild(slot);
                }

                grid.appendChild(coluna);
            }

            // Adicionar eventos
            adicionarEventosASemana(inicioSemana);
        }

        function adicionarEventosASemana(inicioSemana) {
            if (!todosEventos || todosEventos.length === 0) return;

            for (let i = 0; i < 7; i++) {
                const dia = new Date(inicioSemana);
                dia.setDate(inicioSemana.getDate() + i);
                const dataStr = dia.toISOString().split('T')[0];
                // Data local para compara√ß√£o
                const dataStrLocal = `${dia.getFullYear()}-${String(dia.getMonth() + 1).padStart(2, '0')}-${String(dia.getDate()).padStart(2, '0')}`;

                const coluna = document.querySelector(`.cal-week-column[data-date="${dataStr}"]`);
                if (!coluna) continue;

                // Filtrar eventos do dia usando data LOCAL
                const eventosDia = todosEventos.filter(e => {
                    const dataEvento = new Date(e.start);
                    const dataEventoLocal = `${dataEvento.getFullYear()}-${String(dataEvento.getMonth() + 1).padStart(2, '0')}-${String(dataEvento.getDate()).padStart(2, '0')}`;
                    return dataEventoLocal === dataStrLocal;
                });

                eventosDia.forEach(evento => {
                    const divEvento = criarEventoSemana(evento);
                    if (divEvento) coluna.appendChild(divEvento);
                });
            }
        }

        function criarEventoSemana(evento) {
            // Converter para hor√°rio local
            const dataEvento = new Date(evento.start);
            const hora = dataEvento.getHours();
            const minuto = dataEvento.getMinutes();

            if (hora < HORA_INICIO || hora > HORA_FIM) return null;

            const div = document.createElement('div');
            div.className = 'cal-week-event';

            // Posicionamento
            const top = (hora - HORA_INICIO) * 60 + minuto;
            const duracao = 30; // Dura√ß√£o padr√£o de 30 minutos

            div.style.top = `${top}px`;
            div.style.height = `${duracao}px`;

            // Cor
            let cor = '#3b82f6';
            if (String(evento.id).startsWith('bl_')) {
                cor = '#ef4444';
            } else if (evento.extendedProps?.status === 'faltou') {
                cor = '#f59e0b';
            } else if (['cancelado', 'cancelada'].includes(evento.extendedProps?.status)) {
                cor = '#9ca3af';
            } else if (['realizado', 'realizada', 'concluido', 'concluida'].includes(evento.extendedProps?.status)) {
                cor = '#10b981';
            } else if (evento.medico_id) {
                cor = getCorMedico(evento.medico_id);
            }
            div.style.background = cor;

            // Conte√∫do - inline como nas outras visualiza√ß√µes
            const paciente = evento.extendedProps?.paciente || evento.title?.split(' - ')[0] || 'Paciente';
            const horaFormatada = `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
            div.innerHTML = `<span class="cal-week-event-content">${horaFormatada} ${escapeHtml(paciente)}</span>`;
            div.title = `${horaFormatada} - ${paciente}`;

            // Click
            div.addEventListener('click', async (e) => {
                e.stopPropagation();
                const eventId = String(evento.id);
                if (eventId.startsWith('bl_')) {
                    alert('Este √© um hor√°rio bloqueado');
                } else {
                    await abrirDetalhesAgendamento(evento.id);
                }
            });

            return div;
        }

        function renderizarDia() {
            const hoje = new Date();
            const isToday = currentDate.toDateString() === hoje.toDateString();
            const dataStr = currentDate.toISOString().split('T')[0];

            // T√≠tulo do dia
            const titulo = document.getElementById('calDayTitle');
            titulo.textContent = `${DIAS_SEMANA_FULL[currentDate.getDay()]}, ${currentDate.getDate()} de ${MESES[currentDate.getMonth()]}`;
            if (isToday) titulo.textContent += ' (Hoje)';

            // Slots do dia
            const slotsContainer = document.getElementById('calDaySlots');
            slotsContainer.innerHTML = '';

            // Agrupar eventos por hora LOCAL (convertendo de UTC)
            const eventosPorHora = {};
            if (todosEventos) {
                todosEventos.forEach(evento => {
                    // Converter para data local para verificar o dia
                    const dataEvento = new Date(evento.start);
                    const dataEventoStr = dataEvento.toISOString().split('T')[0];
                    // Verificar se √© do mesmo dia considerando timezone local
                    const dataEventoLocal = `${dataEvento.getFullYear()}-${String(dataEvento.getMonth() + 1).padStart(2, '0')}-${String(dataEvento.getDate()).padStart(2, '0')}`;

                    if (dataEventoLocal !== dataStr) return;

                    // Usar hora LOCAL, n√£o UTC
                    const hora = dataEvento.getHours();
                    if (!eventosPorHora[hora]) eventosPorHora[hora] = [];
                    eventosPorHora[hora].push(evento);
                });
            }

            for (let hora = HORA_INICIO; hora <= HORA_FIM; hora++) {
                const slot = document.createElement('div');
                slot.className = 'cal-day-slot';

                // Verificar disponibilidade do hor√°rio
                const disponivel = verificarHorarioDisponivel(currentDate, hora);
                if (!disponivel) {
                    slot.classList.add('indisponivel');
                }

                const timeDiv = document.createElement('div');
                timeDiv.className = 'cal-day-slot-time';
                timeDiv.textContent = `${hora.toString().padStart(2, '0')}:00`;
                slot.appendChild(timeDiv);

                const eventsDiv = document.createElement('div');
                eventsDiv.className = 'cal-day-slot-events';

                // Eventos desta hora
                const eventos = eventosPorHora[hora] || [];
                eventos.forEach(evento => {
                    const divEvento = criarEventoDia(evento);
                    eventsDiv.appendChild(divEvento);
                });

                // Click para criar novo agendamento - apenas se dispon√≠vel
                if (disponivel) {
                    eventsDiv.addEventListener('click', (e) => {
                        if (e.target.classList.contains('cal-day-event') || e.target.closest('.cal-day-event')) return;
                        selectedDate = dataStr;
                        document.getElementById('data').value = dataStr;
                        document.getElementById('hora').value = `${hora.toString().padStart(2, '0')}:00`;
                        abrirModalAgendamento();
                    });
                }

                slot.appendChild(eventsDiv);
                slotsContainer.appendChild(slot);
            }
        }

        function criarEventoDia(evento) {
            const div = document.createElement('div');
            div.className = 'cal-day-event';

            // Cor
            let cor = '#3b82f6';
            if (String(evento.id).startsWith('bl_')) {
                cor = '#ef4444';
            } else if (evento.extendedProps?.status === 'faltou') {
                cor = '#f59e0b';
            } else if (['cancelado', 'cancelada'].includes(evento.extendedProps?.status)) {
                cor = '#9ca3af';
            } else if (['realizado', 'realizada', 'concluido', 'concluida'].includes(evento.extendedProps?.status)) {
                cor = '#10b981';
            } else if (evento.medico_id) {
                cor = getCorMedico(evento.medico_id);
            }
            div.style.background = cor;
            div.style.color = 'white';
            div.style.padding = '0.75rem';
            div.style.borderRadius = '8px';
            div.style.cursor = 'pointer';

            // Converter para hora LOCAL
            const dataEvento = new Date(evento.start);
            const horaStr = `${dataEvento.getHours().toString().padStart(2, '0')}:${dataEvento.getMinutes().toString().padStart(2, '0')}`;
            const paciente = evento.extendedProps?.paciente || evento.title?.split(' - ')[0] || 'Paciente';
            const telefone = evento.extendedProps?.telefone || '';
            const status = evento.extendedProps?.status || '';

            let statusIcon = '';
            if (['confirmado', 'confirmada'].includes(status)) statusIcon = '<i class="fas fa-check-circle ml-2"></i>';
            else if (['pendente', 'agendado', 'agendada'].includes(status)) statusIcon = '<i class="fas fa-clock ml-2"></i>';
            else if (['realizado', 'realizada', 'concluido', 'concluida'].includes(status)) statusIcon = '<i class="fas fa-check-double ml-2 text-green-600"></i>';
            else if (['cancelado', 'cancelada'].includes(status)) statusIcon = '<i class="fas fa-times-circle ml-2"></i>';
            else if (status === 'faltou') statusIcon = '<i class="fas fa-user-slash ml-2"></i>';
            else if (status === 'remarcado') statusIcon = '<i class="fas fa-calendar-alt ml-2"></i>';

            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600;">${horaStr} - ${escapeHtml(paciente)}</span>
                    ${statusIcon}
                </div>
                ${telefone ? `<div style="font-size: 0.875rem; opacity: 0.9; margin-top: 4px;"><i class="fas fa-phone mr-1"></i>${escapeHtml(telefone)}</div>` : ''}
            `;

            // Click
            div.addEventListener('click', async (e) => {
                e.stopPropagation();
                const eventId = String(evento.id);
                if (eventId.startsWith('bl_')) {
                    alert('Este √© um hor√°rio bloqueado');
                } else {
                    await abrirDetalhesAgendamento(evento.id);
                }
            });

            return div;
        }

        function getCorMedico(medicoId) {
            // Encontrar √≠ndice do m√©dico na lista
            const index = medicosData.findIndex(m => m.id === medicoId);
            const cor = index >= 0 ? coresMedicos[index % coresMedicos.length] : '#3b82f6';
            console.log(`getCorMedico(${medicoId}): index=${index}, cor=${cor}, medicosData=`, medicosData);
            // Retornar cor baseada no √≠ndice (cicla se houver mais m√©dicos que cores)
            return cor;
        }

        async function carregarEventos() {
            try {
                // N√£o passar medico_id - o backend decide baseado no tipo de usu√°rio
                // M√©dicos ver√£o apenas suas agendas, secret√°rias ver√£o todas
                const response = await fetch('/api/agendamentos/calendario', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                console.log('Dados recebidos da API:', data);

                if (data.eventos) {
                    // Armazenar todos os eventos
                    todosEventos = data.eventos;

                    // Re-renderizar o calend√°rio com os novos eventos
                    renderizarCalendario();

                    console.log('Eventos carregados:', data.eventos.length);
                }
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
            }
        }

        async function carregarMedicos() {
            try {
                // Backend filtra m√©dicos baseado no tipo de usu√°rio
                // M√©dicos veem apenas a si mesmos, secret√°rias veem todos
                const response = await fetch('/api/medicos', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();

                if (data.sucesso && data.medicos) {
                   // Armazenar dados dos m√©dicos
                   medicosData = data.medicos;

                   // Preencher dropdown do formul√°rio
                   const selectMedico = document.getElementById('medico_id');
                   selectMedico.innerHTML = '';

                   data.medicos.forEach(medico => {
                       const option = document.createElement('option');
                       option.value = medico.id;
                       option.textContent = `${medico.nome} - ${medico.especialidade}`;
                       selectMedico.appendChild(option);
                   });

                   // Preencher dropdown de filtro
                   const filtroMedico = document.getElementById('filtroMedico');
                   // Manter a op√ß√£o "Todos os m√©dicos"
                   filtroMedico.innerHTML = '<option value="0">üìã Todos os m√©dicos</option>';

                   data.medicos.forEach(medico => {
                       const option = document.createElement('option');
                       option.value = medico.id;
                       option.textContent = `${medico.nome} - ${medico.especialidade}`;
                       filtroMedico.appendChild(option);
                   });

                   // Criar legenda com cores
                   const legendaDiv = document.getElementById('legendaMedicos');
                   legendaDiv.innerHTML = '';

                   data.medicos.forEach((medico, index) => {
                       const cor = coresMedicos[index % coresMedicos.length];
                       const legendaItem = document.createElement('div');
                       legendaItem.className = 'flex items-center';
                       legendaItem.innerHTML = `
                           <span class="w-4 h-4 rounded mr-2" style="background-color: ${cor}"></span>
                           <span class="text-sm">${escapeHtml(medico.nome)} - ${escapeHtml(medico.especialidade)}</span>
                       `;
                       legendaDiv.appendChild(legendaItem);
                   });

                   // Adicionar item para bloqueios
                   const bloqueioItem = document.createElement('div');
                   bloqueioItem.className = 'flex items-center';
                   bloqueioItem.innerHTML = `
                       <span class="w-4 h-4 bg-red-500 rounded mr-2"></span>
                       <span class="text-sm">Hor√°rio Bloqueado</span>
                   `;
                   legendaDiv.appendChild(bloqueioItem);

                   // Adicionar item para indispon√≠vel
                   const indisponivelItem = document.createElement('div');
                   indisponivelItem.className = 'flex items-center';
                   indisponivelItem.innerHTML = `
                       <span class="w-4 h-4 rounded mr-2" style="background: repeating-linear-gradient(45deg, #f8fafc, #f8fafc 2px, #e2e8f0 2px, #e2e8f0 4px);"></span>
                       <span class="text-sm text-gray-500">Fora do Expediente</span>
                   `;
                   legendaDiv.appendChild(indisponivelItem);

                   console.log('M√©dicos carregados:', data.medicos.length);

                   // Carregar formas de pagamento do primeiro m√©dico
                   await carregarFormasPagamento();

                   // Se usu√°rio √© m√©dico (apenas 1 m√©dico na lista), carregar sua disponibilidade automaticamente
                   // Ou se √© secret√°ria mas h√° m√©dico selecionado no filtro
                   if (data.medicos.length === 1) {
                       // M√©dico logado v√™ apenas sua pr√≥pria agenda
                       const medicoId = data.medicos[0].id;
                       filtroMedico.value = medicoId;
                       await carregarDisponibilidadeMedico(medicoId);
                       console.log('‚úÖ Disponibilidade carregada automaticamente para m√©dico:', medicoId);
                       // Re-renderizar calend√°rio com as indica√ß√µes de disponibilidade
                       renderizarCalendario();
                   }
                }
            } catch (error) {
                console.error('Erro ao carregar m√©dicos:', error);
            }
        }

        // Vari√°vel para armazenar eventos filtrados
        let eventosFiltrados = [];

        async function aplicarFiltroMedico() {
            const medicoSelecionado = parseInt(document.getElementById('filtroMedico').value);

            // Carregar disponibilidade do m√©dico selecionado
            await carregarDisponibilidadeMedico(medicoSelecionado);

            // Filtrar eventos
            eventosFiltrados = medicoSelecionado === 0
                ? [...todosEventos]
                : todosEventos.filter(evento => evento.medico_id === medicoSelecionado);

            // Temporariamente substituir todosEventos pelos filtrados para renderiza√ß√£o
            const eventosOriginais = todosEventos;
            todosEventos = eventosFiltrados;

            // Re-renderizar calend√°rio
            renderizarCalendario();

            // Restaurar eventos originais
            todosEventos = eventosOriginais;

            console.log(`Filtro aplicado: ${eventosFiltrados.length} eventos exibidos`);
        }

        // ==========================================
        // DISPONIBILIDADE - Fun√ß√µes de verifica√ß√£o
        // ==========================================

        // Carregar configura√ß√µes e bloqueios do m√©dico selecionado
        async function carregarDisponibilidadeMedico(medicoId) {
            console.log('üîÑ carregarDisponibilidadeMedico chamada para m√©dico:', medicoId);

            if (!medicoId || medicoId === 0) {
                console.log('‚ùå M√©dico n√£o selecionado, limpando configura√ß√µes');
                configMedicoSelecionado = null;
                bloqueiosPeriodo = [];
                return;
            }

            try {
                // Carregar configura√ß√µes do m√©dico
                console.log('üì° Buscando configura√ß√µes do m√©dico...');
                const configResp = await fetch(`/api/medicos/${medicoId}/configuracoes`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                console.log('üì° Resposta status:', configResp.status);

                if (configResp.ok) {
                    const configData = await configResp.json();
                    console.log('üì° Dados recebidos:', configData);

                    if (configData.sucesso) {
                        configMedicoSelecionado = configData.configuracoes;
                        console.log('‚úÖ Configura√ß√µes do m√©dico carregadas:', configMedicoSelecionado);
                        console.log('   - dias_atendimento:', configMedicoSelecionado.dias_atendimento);
                        console.log('   - horario_inicio:', configMedicoSelecionado.horario_inicio);
                        console.log('   - horario_fim:', configMedicoSelecionado.horario_fim);
                    } else {
                        console.log('‚ö†Ô∏è API retornou sucesso=false, usando configura√ß√µes padr√£o');
                        // Usar configura√ß√µes padr√£o se a API n√£o retornou sucesso
                        configMedicoSelecionado = {
                            dias_atendimento: '[1,2,3,4,5]',
                            horario_inicio: '08:00',
                            horario_fim: '18:00'
                        };
                    }
                } else {
                    console.log('‚ùå Erro na requisi√ß√£o:', configResp.status, configResp.statusText);
                    // Usar configura√ß√µes padr√£o se houve erro na requisi√ß√£o
                    configMedicoSelecionado = {
                        dias_atendimento: '[1,2,3,4,5]',
                        horario_inicio: '08:00',
                        horario_fim: '18:00'
                    };
                }

                // Carregar bloqueios do per√≠odo vis√≠vel
                await carregarBloqueiosPeriodo(medicoId);

            } catch (error) {
                console.error('‚ùå Erro ao carregar disponibilidade do m√©dico:', error);
                // Em caso de erro, usar configura√ß√µes padr√£o em vez de null
                configMedicoSelecionado = {
                    dias_atendimento: '[1,2,3,4,5]',
                    horario_inicio: '08:00',
                    horario_fim: '18:00'
                };
                bloqueiosPeriodo = [];
            }
        }

        // Carregar bloqueios do per√≠odo vis√≠vel
        async function carregarBloqueiosPeriodo(medicoId) {
            console.log('üîÑ carregarBloqueiosPeriodo chamada para m√©dico:', medicoId);

            if (!medicoId || medicoId === 0) {
                bloqueiosPeriodo = [];
                return;
            }

            try {
                const resp = await fetch(`/api/medicos/${medicoId}/bloqueios`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                console.log('üì° Resposta bloqueios status:', resp.status);

                if (resp.ok) {
                    const data = await resp.json();
                    console.log('üì° Dados bloqueios:', data);

                    if (data.sucesso && data.bloqueios) {
                        // Filtrar bloqueios ativos para o per√≠odo vis√≠vel
                        const { inicio, fim } = obterPeriodoVisivel();
                        console.log('üìÖ Per√≠odo vis√≠vel:', inicio, '-', fim);

                        bloqueiosPeriodo = data.bloqueios.filter(b => {
                            const bInicio = new Date(b.data_inicio);
                            const bFim = new Date(b.data_fim);
                            return bInicio <= fim && bFim >= inicio;
                        });
                        console.log('‚úÖ Bloqueios do per√≠odo carregados:', bloqueiosPeriodo.length);
                    }
                } else {
                    console.log('‚ùå Erro na requisi√ß√£o de bloqueios:', resp.status);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar bloqueios:', error);
                bloqueiosPeriodo = [];
            }
        }

        // Obter per√≠odo vis√≠vel no calend√°rio (in√≠cio e fim)
        function obterPeriodoVisivel() {
            let inicio, fim;

            if (currentView === 'month') {
                // Primeiro dia do m√™s com margem para dias do m√™s anterior
                inicio = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                inicio.setDate(inicio.getDate() - 7); // Margem para dias do m√™s anterior
                // √öltimo dia do m√™s com margem para dias do pr√≥ximo m√™s
                fim = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                fim.setDate(fim.getDate() + 7); // Margem para dias do pr√≥ximo m√™s
            } else if (currentView === 'week') {
                // In√≠cio da semana
                inicio = new Date(currentDate);
                inicio.setDate(currentDate.getDate() - currentDate.getDay());
                // Fim da semana
                fim = new Date(inicio);
                fim.setDate(inicio.getDate() + 6);
            } else {
                // Visualiza√ß√£o di√°ria
                inicio = new Date(currentDate);
                inicio.setHours(0, 0, 0, 0);
                fim = new Date(currentDate);
                fim.setHours(23, 59, 59, 999);
            }

            return { inicio, fim };
        }

        // Verificar se um dia est√° dispon√≠vel para agendamento
        function verificarDiaDisponivel(data) {
            // Se n√£o h√° m√©dico selecionado no filtro, todos os dias s√£o clic√°veis
            if (!configMedicoSelecionado) {
                return true;
            }

            // Verificar se o dia da semana est√° ativo nas configura√ß√µes
            const diasAtendimento = configMedicoSelecionado.dias_atendimento;
            if (diasAtendimento) {
                try {
                    // dias_atendimento pode ser string JSON ou array
                    const dias = typeof diasAtendimento === 'string'
                        ? JSON.parse(diasAtendimento)
                        : diasAtendimento;

                    // Backend usa: 1=Segunda, 2=Ter√ßa, ..., 7=Domingo
                    // JavaScript: 0=Domingo, 1=Segunda, ..., 6=S√°bado
                    const diaSemanaJS = data.getDay(); // 0-6 (Dom-S√°b)
                    const diaSemanaBackend = diaSemanaJS === 0 ? 7 : diaSemanaJS; // Converter para formato backend

                    if (!dias.includes(diaSemanaBackend)) {
                        return false;
                    }
                } catch (e) {
                    console.error('Erro ao parsear dias_atendimento:', e);
                }
            }

            // Verificar se est√° em per√≠odo bloqueado
            if (verificarDataBloqueada(data)) {
                return false;
            }

            return true;
        }

        // Verificar se um hor√°rio espec√≠fico est√° dispon√≠vel
        function verificarHorarioDisponivel(data, hora) {
            // Se o dia n√£o est√° dispon√≠vel, o hor√°rio tamb√©m n√£o est√°
            if (!verificarDiaDisponivel(data)) return false;

            // Se n√£o h√° configura√ß√µes do m√©dico, considerar dispon√≠vel
            if (!configMedicoSelecionado) return true;

            // Verificar se hora est√° dentro do expediente
            const horarioInicio = configMedicoSelecionado.horario_inicio || '08:00';
            const horarioFim = configMedicoSelecionado.horario_fim || '18:00';
            const horaStr = `${hora.toString().padStart(2, '0')}:00`;

            if (horaStr < horarioInicio || horaStr >= horarioFim) {
                return false;
            }

            // Verificar intervalo de almo√ßo
            const almocoInicio = configMedicoSelecionado.intervalo_almoco_inicio;
            const almocoFim = configMedicoSelecionado.intervalo_almoco_fim;

            if (almocoInicio && almocoFim) {
                if (horaStr >= almocoInicio && horaStr < almocoFim) {
                    return false;
                }
            }

            return true;
        }

        // Verificar se uma data est√° em per√≠odo bloqueado
        function verificarDataBloqueada(data) {
            if (!bloqueiosPeriodo || bloqueiosPeriodo.length === 0) return false;

            // Normalizar a data para compara√ß√£o (apenas data, sem hora)
            const dataStr = data.toISOString().split('T')[0];

            return bloqueiosPeriodo.some(b => {
                const inicio = b.data_inicio.split('T')[0];
                const fim = b.data_fim.split('T')[0];
                return dataStr >= inicio && dataStr <= fim;
            });
        }

        // ==========================================
        // FIM DISPONIBILIDADE
        // ==========================================

        function abrirModalAgendamento() {
            document.getElementById('modalAgendamento').classList.remove('hidden');

            // Definir data m√≠nima como hoje
            const hoje = new Date().toISOString().split('T')[0];
            const inputData = document.getElementById('data');
            inputData.min = hoje;

            // Se a data selecionada for no passado, limpar
            if (inputData.value && inputData.value < hoje) {
                inputData.value = '';
                document.getElementById('hora').value = '';
            }

            carregarFormasPagamento();
        }

        // Carregar formas de pagamento do m√©dico selecionado
        // Busca do endpoint /api/medicos/{medico_id}/formas-pagamento
        async function carregarFormasPagamento() {
            const convenioSelect = document.getElementById('convenio_id');
            const medicoSelect = document.getElementById('medico_id');
            const medicoId = medicoSelect?.value;

            // Se n√£o h√° m√©dico selecionado, mostrar op√ß√£o padr√£o
            if (!medicoId) {
                convenioSelect.innerHTML = '<option value="">Selecione um m√©dico primeiro...</option>';
                return;
            }

            convenioSelect.innerHTML = '<option value="">Carregando...</option>';

            try {
                const response = await fetch(`/api/medicos/${medicoId}/formas-pagamento`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                convenioSelect.innerHTML = '<option value="">Selecione...</option>';

                if (response.ok) {
                    const data = await response.json();

                    if (data.formas_pagamento && data.formas_pagamento.length > 0) {
                        data.formas_pagamento.forEach(forma => {
                            const option = document.createElement('option');
                            option.value = forma.id;

                            // Mostrar apenas o nome
                            option.textContent = forma.nome;

                            // Armazenar dados extras no data attribute (para uso posterior se necess√°rio)
                            option.dataset.valor = forma.valor || '';
                            option.dataset.tipo = forma.tipo || '';

                            convenioSelect.appendChild(option);
                        });
                    } else {
                        // Fallback: apenas Particular
                        const particularOption = document.createElement('option');
                        particularOption.value = 'particular';
                        particularOption.textContent = 'Particular';
                        convenioSelect.appendChild(particularOption);
                    }
                } else {
                    // Se falhar, usar fallback
                    const particularOption = document.createElement('option');
                    particularOption.value = 'particular';
                    particularOption.textContent = 'Particular';
                    convenioSelect.appendChild(particularOption);
                }
            } catch (error) {
                console.error('Erro ao carregar formas de pagamento:', error);
                convenioSelect.innerHTML = '<option value="">Selecione...</option><option value="particular">Particular</option>';
            }
        }

        // Fun√ß√£o legada para compatibilidade (redireciona para nova fun√ß√£o)
        async function carregarConvenios() {
            await carregarFormasPagamento();
        }

        function fecharModal() {
            document.getElementById('modalAgendamento').classList.add('hidden');
            document.getElementById('formAgendamento').reset();
            // Limpar indicadores
            document.getElementById('indicadorDisponibilidade').classList.add('hidden');
            document.getElementById('horariosDisponiveisContainer').classList.add('hidden');
        }

        // Verificar hor√°rios dispon√≠veis quando m√©dico, data ou dura√ß√£o mudam
        async function verificarHorariosDisponiveis() {
            const medicoId = document.getElementById('medico_id').value;
            const data = document.getElementById('data').value;
            const duracao = document.getElementById('duracao_minutos').value || 30;

            if (!medicoId || !data) {
                return;
            }

            try {
                // Incluir dura√ß√£o na requisi√ß√£o para filtrar hor√°rios com espa√ßo suficiente
                const response = await fetch(`/api/horarios-disponiveis?medico_id=${medicoId}&data=${data}&duracao=${duracao}`);
                const result = await response.json();

                if (result.sucesso && result.horarios.length > 0) {
                    mostrarHorariosDisponiveis(result.horarios);
                } else {
                    document.getElementById('horariosDisponiveisContainer').classList.add('hidden');
                    const msg = parseInt(duracao) > 30
                        ? `Nenhum hor√°rio dispon√≠vel com ${duracao} minutos livres`
                        : 'Nenhum hor√°rio dispon√≠vel para esta data';
                    mostrarMensagem(msg, 'warning');
                }
            } catch (error) {
                console.error('Erro ao buscar hor√°rios:', error);
            }
        }

        function mostrarHorariosDisponiveis(horarios) {
            const container = document.getElementById('horariosDisponiveisContainer');
            const horariosDiv = document.getElementById('horariosDisponiveis');

            // Esconder mensagem de aviso anterior (bug fix)
            document.getElementById('indicadorDisponibilidade').classList.add('hidden');

            horariosDiv.innerHTML = '';

            // Filtrar hor√°rios passados se for o dia atual
            const dataSelecionada = document.getElementById('data').value;
            const hoje = new Date().toISOString().split('T')[0];
            const agora = new Date();

            let horariosFiltrados = horarios;
            if (dataSelecionada === hoje) {
                const horaAtual = agora.getHours();
                const minutoAtual = agora.getMinutes();

                horariosFiltrados = horarios.filter(horario => {
                    const [hora, minuto] = horario.split(':').map(Number);
                    // S√≥ mostrar hor√°rios futuros (com margem de 5 minutos)
                    return (hora > horaAtual) || (hora === horaAtual && minuto > minutoAtual + 5);
                });
            }

            if (horariosFiltrados.length === 0) {
                container.classList.add('hidden');
                mostrarMensagem('N√£o h√° mais hor√°rios dispon√≠veis para hoje', 'warning');
                return;
            }

            horariosFiltrados.forEach(horario => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'px-3 py-2 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200 transition';
                button.textContent = horario;
                button.onclick = () => selecionarHorario(horario);
                horariosDiv.appendChild(button);
            });

            container.classList.remove('hidden');
        }

        function selecionarHorario(horario) {
            document.getElementById('hora').value = horario;
            verificarDisponibilidadeHorario();
        }

        // Verificar disponibilidade de um hor√°rio espec√≠fico
        async function verificarDisponibilidadeHorario() {
            const medicoId = document.getElementById('medico_id').value;
            const data = document.getElementById('data').value;
            const hora = document.getElementById('hora').value;

            if (!medicoId || !data || !hora) {
                return;
            }

            try {
                const response = await fetch('/api/verificar-disponibilidade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `medico_id=${medicoId}&data=${data}&hora=${hora}`
                });

                const result = await response.json();

                if (result.sucesso) {
                    if (result.disponivel) {
                        mostrarMensagem('‚úì Hor√°rio dispon√≠vel!', 'success');
                    } else {
                        mostrarMensagem('‚úó Hor√°rio n√£o dispon√≠vel. Escolha outro hor√°rio.', 'error');
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar disponibilidade:', error);
            }
        }

        function mostrarMensagem(mensagem, tipo) {
            const indicador = document.getElementById('indicadorDisponibilidade');
            const mensagemSpan = document.getElementById('mensagemDisponibilidade');

            indicador.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');

            if (tipo === 'success') {
                indicador.classList.add('bg-green-100', 'text-green-800');
            } else if (tipo === 'error') {
                indicador.classList.add('bg-red-100', 'text-red-800');
            } else if (tipo === 'warning') {
                indicador.classList.add('bg-yellow-100', 'text-yellow-800');
            }

            mensagemSpan.textContent = mensagem;
        }

        // Handler do formul√°rio de agendamento
        document.getElementById('formAgendamento')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('=== FORM SUBMIT AGENDAMENTO ===');

            // Fun√ß√µes auxiliares com fallback
            const mostrarErro = (titulo, msg) => {
                console.log('Erro:', titulo, msg);
                if (typeof HiToast !== 'undefined' && HiToast.error) {
                    HiToast.error(titulo, msg);
                } else {
                    alert(`${titulo}: ${msg}`);
                }
            };

            const mostrarSucesso = (titulo, msg) => {
                console.log('Sucesso:', titulo, msg);
                if (typeof HiToast !== 'undefined' && HiToast.success) {
                    HiToast.success(titulo, msg);
                } else {
                    alert(`${titulo}: ${msg}`);
                }
            };

            const telefoneRaw = document.getElementById('paciente_telefone').value;

            // VALIDA√á√ÉO: Telefone no formato correto
            if (!validarTelefone(telefoneRaw)) {
                mostrarErro('Telefone Inv√°lido', 'Digite o telefone no formato (XX) XXXXX-XXXX');
                document.getElementById('paciente_telefone').focus();
                return;
            }

            // Obter forma de pagamento selecionada e seu valor
            const convenioSelect = document.getElementById('convenio_id');
            const selectedOption = convenioSelect.options[convenioSelect.selectedIndex];
            const formaPagamento = convenioSelect.value || 'particular';
            const valorConsulta = selectedOption?.dataset?.valor || '';

            const formData = {
                paciente_nome: document.getElementById('paciente_nome').value,
                paciente_telefone: extrairNumerosTelefone(telefoneRaw), // Envia apenas n√∫meros
                medico_id: parseInt(document.getElementById('medico_id').value),
                data: document.getElementById('data').value,
                hora: document.getElementById('hora').value,
                duracao_minutos: parseInt(document.getElementById('duracao_minutos').value) || 30,
                motivo_consulta: document.getElementById('motivo_consulta').value || 'Consulta',
                forma_pagamento: formaPagamento,
                valor_consulta: valorConsulta
            };

            console.log('FormData:', formData);

            // VALIDA√á√ÉO: N√£o permitir agendamentos no passado
            const agora = new Date();
            const dataAgendamento = new Date(formData.data + 'T' + formData.hora);

            if (dataAgendamento < agora) {
                const hoje = agora.toISOString().split('T')[0];
                if (formData.data < hoje) {
                    mostrarErro('Data Inv√°lida', 'N√£o √© poss√≠vel agendar para datas passadas');
                } else {
                    mostrarErro('Hor√°rio Inv√°lido', 'Este hor√°rio j√° passou. Selecione um hor√°rio futuro.');
                }
                return;
            }

            try {
                console.log('Enviando requisi√ß√£o...');
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log('Resposta:', result);

                if (result.sucesso) {
                    const dataFormatada = new Date(formData.data + 'T' + formData.hora).toLocaleDateString('pt-BR');
                    mostrarSucesso('Consulta Agendada!', `${formData.paciente_nome} - ${dataFormatada} √†s ${formData.hora}`);
                    fecharModal();

                    // Navegar para a data do agendamento e recarregar
                    currentDate = new Date(formData.data + 'T12:00:00');
                    await carregarEventos();
                    renderizarCalendario();

                    console.log('Navegado para:', formData.data);
                } else {
                    mostrarErro('Erro ao Agendar', result.erro || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                mostrarErro('Erro ao Agendar', 'N√£o foi poss√≠vel criar o agendamento');
            }
        });

        // ==========================================
        // FUN√á√ïES DE DETALHES E GERENCIAMENTO
        // ==========================================
        let agendamentoAtual = null;

        async function abrirDetalhesAgendamento(agendamentoId) {
            try {
                const response = await fetch(`/api/agendamentos/${agendamentoId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();

                if (result.sucesso && result.agendamento) {
                    const ag = result.agendamento;
                    agendamentoAtual = {
                        id: ag.id,
                        data_hora: ag.data_hora,
                        duracao_minutos: ag.duracao_minutos || 30,
                        status: ag.status,
                        tipo: ag.tipo_atendimento,
                        motivo_consulta: ag.motivo_consulta,
                        paciente_nome: ag.paciente?.nome || ag.paciente_nome,
                        paciente_telefone: ag.paciente?.telefone || ag.paciente_telefone,
                        medico_id: ag.medico?.id || ag.medico_id,
                        medico_nome: ag.medico?.nome || ag.medico_nome,
                        especialidade: ag.medico?.especialidade || ag.especialidade,
                        forma_pagamento: ag.forma_pagamento,
                        valor_consulta: ag.valor_consulta
                    };

                    // Preencher detalhes no modal
                    document.getElementById('det_agendamento_id').value = agendamentoAtual.id;
                    document.getElementById('det_paciente_nome').textContent = agendamentoAtual.paciente_nome || '-';
                    document.getElementById('det_paciente_telefone').textContent = agendamentoAtual.paciente_telefone || '-';
                    document.getElementById('det_medico').textContent = agendamentoAtual.medico_nome || '-';
                    document.getElementById('det_especialidade').textContent = agendamentoAtual.especialidade || '-';

                    // Formatar data e hora
                    const dataHora = new Date(agendamentoAtual.data_hora);
                    const dataFormatada = dataHora.toLocaleDateString('pt-BR');
                    const horaFormatada = dataHora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    document.getElementById('det_data').textContent = dataFormatada;
                    document.getElementById('det_hora').textContent = horaFormatada;
                    document.getElementById('det_duracao').textContent = `${agendamentoAtual.duracao_minutos} minutos`;

                    // USABILIDADE: Status com badge visual (√≠cone + cor + texto)
                    const statusElement = document.getElementById('det_status');
                    const statusTexto = agendamentoAtual.status || 'agendado';
                    const statusConfig = {
                        'agendado': { icon: 'fa-clock', texto: 'Agendado', classe: 'status-agendado' },
                        'agendada': { icon: 'fa-clock', texto: 'Agendado', classe: 'status-agendado' },
                        'pendente': { icon: 'fa-clock', texto: 'Pendente', classe: 'status-pendente' },
                        'confirmado': { icon: 'fa-check-circle', texto: 'Confirmado', classe: 'status-confirmado' },
                        'confirmada': { icon: 'fa-check-circle', texto: 'Confirmado', classe: 'status-confirmado' },
                        'realizado': { icon: 'fa-check-double', texto: 'Realizado', classe: 'status-realizado' },
                        'realizada': { icon: 'fa-check-double', texto: 'Realizado', classe: 'status-realizado' },
                        'concluido': { icon: 'fa-check-double', texto: 'Conclu√≠do', classe: 'status-realizado' },
                        'concluida': { icon: 'fa-check-double', texto: 'Conclu√≠do', classe: 'status-realizado' },
                        'cancelado': { icon: 'fa-times-circle', texto: 'Cancelado', classe: 'status-cancelado' },
                        'cancelada': { icon: 'fa-times-circle', texto: 'Cancelado', classe: 'status-cancelado' },
                        'remarcado': { icon: 'fa-calendar-alt', texto: 'Remarcado', classe: 'status-pendente' },
                        'faltou': { icon: 'fa-user-slash', texto: 'Faltou', classe: 'status-faltou' }
                    };
                    const config = statusConfig[statusTexto] || statusConfig['agendado'];
                    statusElement.innerHTML = `<span class="status-badge ${config.classe}"><i class="fas ${config.icon}"></i> ${config.texto}</span>`;

                    document.getElementById('det_tipo').textContent = agendamentoAtual.tipo || '-';
                    document.getElementById('det_motivo').textContent = agendamentoAtual.motivo_consulta || 'N√£o informado';

                    // Informa√ß√µes de pagamento
                    const formaPagamento = agendamentoAtual.forma_pagamento || 'particular';
                    let formaPagamentoTexto = 'Particular';
                    if (formaPagamento.startsWith('convenio_')) {
                        // Buscar nome do conv√™nio do cadastro do m√©dico
                        const medicoData = medicosData.find(m => m.id === agendamentoAtual.medico_id);
                        if (medicoData && medicoData.convenios_aceitos) {
                            try {
                                const idx = parseInt(formaPagamento.replace('convenio_', ''));
                                const convenios = typeof medicoData.convenios_aceitos === 'string'
                                    ? JSON.parse(medicoData.convenios_aceitos)
                                    : medicoData.convenios_aceitos;
                                if (convenios && convenios[idx]) {
                                    formaPagamentoTexto = convenios[idx].nome || 'Conv√™nio';
                                } else {
                                    formaPagamentoTexto = 'Conv√™nio';
                                }
                            } catch (e) {
                                formaPagamentoTexto = 'Conv√™nio';
                            }
                        } else {
                            formaPagamentoTexto = 'Conv√™nio';
                        }
                    } else if (formaPagamento === 'particular') {
                        formaPagamentoTexto = 'Particular';
                    }
                    document.getElementById('det_forma_pagamento').textContent = formaPagamentoTexto;

                    // Gerenciar bot√£o "Marcar Falta"
                    const btnMarcarFalta = document.getElementById('btnMarcarFalta');
                    btnMarcarFalta.disabled = false;
                    btnMarcarFalta.innerHTML = '<i class="fas fa-user-times mr-1 sm:mr-2"></i><span class="hidden sm:inline">Marcar Falta</span><span class="sm:hidden">Falta</span>';

                    // Ocultar bot√£o se status n√£o permite marcar falta
                    const statusFinais = ['faltou', 'realizado', 'realizada', 'concluido', 'concluida', 'cancelado', 'cancelada', 'remarcado'];
                    if (statusFinais.includes(statusTexto)) {
                        btnMarcarFalta.style.display = 'none';
                    } else {
                        btnMarcarFalta.style.display = '';
                    }

                    // Abrir modal
                    document.getElementById('modalDetalhes').classList.remove('hidden');
                } else {
                    alert('Erro ao carregar detalhes do agendamento');
                }
            } catch (error) {
                console.error('Erro ao carregar agendamento:', error);
                alert('Erro ao carregar detalhes do agendamento');
            }
        }

        function fecharModalDetalhes() {
            document.getElementById('modalDetalhes').classList.add('hidden');
            agendamentoAtual = null;
        }

        function abrirReagendamento() {
            if (!agendamentoAtual) return;

            // Fechar modal de detalhes
            document.getElementById('modalDetalhes').classList.add('hidden');

            // Definir data m√≠nima (hoje)
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('reagendar_data').min = hoje;

            // Abrir modal de reagendamento
            document.getElementById('modalReagendamento').classList.remove('hidden');
        }

        function fecharModalReagendamento() {
            document.getElementById('modalReagendamento').classList.add('hidden');
            document.getElementById('formReagendamento').reset();
            document.getElementById('horariosDisponiveisReagendamento').classList.add('hidden');
        }

        async function verificarHorariosDisponiveisReagendamento() {
            if (!agendamentoAtual) return;

            const data = document.getElementById('reagendar_data').value;
            if (!data) return;

            try {
                const response = await fetch(`/api/horarios-disponiveis?medico_id=${agendamentoAtual.medico_id}&data=${data}`);
                const result = await response.json();

                if (result.sucesso && result.horarios.length > 0) {
                    const container = document.getElementById('horariosListReagendamento');
                    container.innerHTML = '';

                    // Filtrar hor√°rios passados se for o dia atual
                    const hoje = new Date().toISOString().split('T')[0];
                    const agora = new Date();
                    let horariosFiltrados = result.horarios;

                    if (data === hoje) {
                        const horaAtual = agora.getHours();
                        const minutoAtual = agora.getMinutes();

                        horariosFiltrados = result.horarios.filter(horario => {
                            const [hora, minuto] = horario.split(':').map(Number);
                            return (hora > horaAtual) || (hora === horaAtual && minuto > minutoAtual + 5);
                        });
                    }

                    if (horariosFiltrados.length === 0) {
                        document.getElementById('horariosDisponiveisReagendamento').classList.add('hidden');
                        if (typeof HiToast !== 'undefined' && HiToast.warning) {
                            HiToast.warning('Sem Hor√°rios', 'N√£o h√° mais hor√°rios dispon√≠veis para hoje');
                        } else {
                            alert('N√£o h√° mais hor√°rios dispon√≠veis para hoje');
                        }
                        return;
                    }

                    horariosFiltrados.forEach(horario => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'px-3 py-2 text-sm bg-green-100 text-green-800 rounded hover:bg-green-200 transition';
                        button.textContent = horario;
                        button.onclick = () => {
                            document.getElementById('reagendar_hora').value = horario;
                        };
                        container.appendChild(button);
                    });

                    document.getElementById('horariosDisponiveisReagendamento').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao buscar hor√°rios:', error);
            }
        }

        // Handler do formul√°rio de reagendamento
        document.getElementById('formReagendamento')?.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!agendamentoAtual) return;

            const novaData = document.getElementById('reagendar_data').value;
            const novaHora = document.getElementById('reagendar_hora').value;

            // VALIDA√á√ÉO: N√£o permitir reagendamento para o passado
            const agora = new Date();
            const dataReagendamento = new Date(novaData + 'T' + novaHora);

            // Fun√ß√µes auxiliares com fallback
            const mostrarErroReag = (titulo, msg) => {
                if (typeof HiToast !== 'undefined' && HiToast.error) {
                    HiToast.error(titulo, msg);
                } else {
                    alert(`${titulo}: ${msg}`);
                }
            };

            const mostrarSucessoReag = (titulo, msg) => {
                if (typeof HiToast !== 'undefined' && HiToast.success) {
                    HiToast.success(titulo, msg);
                } else {
                    alert(`${titulo}: ${msg}`);
                }
            };

            if (dataReagendamento < agora) {
                const hoje = agora.toISOString().split('T')[0];
                if (novaData < hoje) {
                    mostrarErroReag('Data Inv√°lida', 'N√£o √© poss√≠vel reagendar para datas passadas');
                } else {
                    mostrarErroReag('Hor√°rio Inv√°lido', 'Este hor√°rio j√° passou. Selecione um hor√°rio futuro.');
                }
                return;
            }

            // USABILIDADE: Modal de confirma√ß√£o para reagendamento
            const dataFormatada = new Date(novaData + 'T' + novaHora).toLocaleDateString('pt-BR');

            let confirmado = false;
            if (typeof HiModal !== 'undefined' && HiModal.confirm) {
                try {
                    confirmado = await HiModal.confirm(
                        'Confirmar Reagendamento?',
                        `A consulta de <strong>${agendamentoAtual.paciente_nome}</strong> ser√° reagendada para ${dataFormatada} √†s ${novaHora}.`,
                        {
                            confirmText: 'Sim, Reagendar',
                            cancelText: 'Voltar'
                        }
                    );
                } catch (e) {
                    confirmado = confirm(`Reagendar consulta de ${agendamentoAtual.paciente_nome} para ${dataFormatada} √†s ${novaHora}?`);
                }
            } else {
                confirmado = confirm(`Reagendar consulta de ${agendamentoAtual.paciente_nome} para ${dataFormatada} √†s ${novaHora}?`);
            }

            if (!confirmado) return;

            try {
                const response = await fetch(`/api/agendamentos/${agendamentoAtual.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        data: novaData,
                        hora: novaHora
                    })
                });

                const result = await response.json();

                if (result.sucesso || response.ok) {
                    // USABILIDADE: Toast de sucesso
                    mostrarSucessoReag('Consulta Reagendada!', `Nova data: ${dataFormatada} √†s ${novaHora}`);
                    fecharModalReagendamento();
                    carregarEventos(); // Recarregar calend√°rio
                } else {
                    mostrarErroReag('Erro ao Reagendar', result.mensagem || result.erro || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro ao reagendar:', error);
                mostrarErroReag('Erro ao Reagendar', 'N√£o foi poss√≠vel reagendar o agendamento');
            }
        });

        async function marcarComoFalta() {
            console.log('marcarComoFalta() chamada, agendamentoAtual:', agendamentoAtual);

            if (!agendamentoAtual) {
                alert('Erro: Nenhum agendamento selecionado. Feche o modal e tente novamente.');
                return;
            }

            try {
                const dataFormatada = new Date(agendamentoAtual.data_hora).toLocaleString('pt-BR');

                // Usar confirm nativo (HiModal n√£o tem m√©todo confirm)
                const confirmado = confirm(`Marcar ${agendamentoAtual.paciente_nome} como falta?\n\nData: ${dataFormatada}\n\nUma mensagem ser√° enviada por WhatsApp.`);

                if (!confirmado) return;

                const btnMarcarFalta = document.getElementById('btnMarcarFalta');
                btnMarcarFalta.disabled = true;
                btnMarcarFalta.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processando...';

                const response = await fetch(`/api/agendamentos/${agendamentoAtual.id}/marcar-falta`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.sucesso || response.ok) {
                    const msg = result.whatsapp_enviado
                        ? 'Falta registrada! Mensagem de reagendamento enviada por WhatsApp.'
                        : 'Falta registrada no sistema.';
                    if (typeof HiToast !== 'undefined' && HiToast.warning) {
                        HiToast.warning('Falta Registrada', msg);
                    } else {
                        alert(msg);
                    }
                    fecharModalDetalhes();
                    await carregarEventos();
                } else {
                    const erro = result.mensagem || result.detail || result.erro || 'Erro desconhecido';
                    if (typeof HiToast !== 'undefined' && HiToast.error) {
                        HiToast.error('Erro ao Marcar Falta', erro);
                    } else {
                        alert('Erro ao marcar falta: ' + erro);
                    }
                    btnMarcarFalta.disabled = false;
                    btnMarcarFalta.innerHTML = '<i class="fas fa-user-times mr-2"></i><span class="hidden sm:inline">Marcar Falta</span><span class="sm:hidden">Falta</span>';
                }
            } catch (error) {
                console.error('Erro ao marcar falta:', error);
                alert('Erro ao marcar falta: ' + error.message);
                const btnMarcarFalta = document.getElementById('btnMarcarFalta');
                if (btnMarcarFalta) {
                    btnMarcarFalta.disabled = false;
                    btnMarcarFalta.innerHTML = '<i class="fas fa-user-times mr-2"></i><span class="hidden sm:inline">Marcar Falta</span><span class="sm:hidden">Falta</span>';
                }
            }
        }

        async function confirmarCancelamento() {
            console.log('confirmarCancelamento() chamada, agendamentoAtual:', agendamentoAtual);

            if (!agendamentoAtual) {
                alert('Erro: Nenhum agendamento selecionado. Feche o modal e tente novamente.');
                return;
            }

            try {
                // Pedir motivo usando prompt nativo
                const motivo = prompt('Digite o motivo do cancelamento:\n\n(Ex: Paciente solicitou, M√©dico indispon√≠vel, etc.)');

                if (!motivo) {
                    return; // Usu√°rio cancelou
                }

                // Confirmar cancelamento
                const confirmado = confirm(`Cancelar consulta de ${agendamentoAtual.paciente_nome}?\n\nMotivo: ${motivo}\n\nEsta a√ß√£o n√£o pode ser desfeita.`);

                if (!confirmado) return;

                const response = await fetch(`/api/agendamentos/${agendamentoAtual.id}?motivo=${encodeURIComponent(motivo)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (result.sucesso || response.ok) {
                    if (typeof HiToast !== 'undefined' && HiToast.warning) {
                        HiToast.warning('Consulta Cancelada', 'O paciente ser√° notificado');
                    } else {
                        alert('Consulta cancelada com sucesso!');
                    }
                    fecharModalDetalhes();
                    await carregarEventos();
                } else {
                    const erro = result.mensagem || result.detail || result.erro || 'Erro desconhecido';
                    if (typeof HiToast !== 'undefined' && HiToast.error) {
                        HiToast.error('Erro ao Cancelar', erro);
                    } else {
                        alert('Erro ao cancelar: ' + erro);
                    }
                }
            } catch (error) {
                console.error('Erro ao cancelar:', error);
                alert('Erro ao cancelar agendamento: ' + error.message);
            }
        }
    </script>

    <!-- Design System Scripts (toast.js e modal.js j√° carregados no head) -->
    <script src="/static/js/components/empty-state.js"></script>
    <script src="/static/js/components/patient-details.js"></script>
    <script src="/static/js/components/schedule-settings.js"></script>
    <script src="/static/js/components/block-period.js"></script>
    <script src="/static/js/components/quick-actions.js"></script>
    <script src="/static/js/components/bottom-nav.js"></script>
    <script src="/static/js/components/swipe-actions.js"></script>
    <script src="/static/js/components/mobile-form.js"></script>
    <script src="/static/js/components/pull-refresh.js"></script>
    <script src="/static/js/hi-design-system.js"></script>

    <!-- Integra√ß√£o dos componentes do m√©dico -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializa FAB de a√ß√µes r√°pidas
            if (typeof HiQuickActions !== 'undefined') {
                HiQuickActions.setupDefaults({
                    onScheduleSettings: () => {
                        // Abre modal de configura√ß√£o de hor√°rios
                        if (typeof HiScheduleSettings !== 'undefined') {
                            // Busca configura√ß√£o atual da API
                            const token = localStorage.getItem('authToken');
                            fetch('/api/configuracao-agenda', {
                                headers: { 'Authorization': `Bearer ${token}` }
                            })
                            .then(r => r.json())
                            .then(config => {
                                HiScheduleSettings.show({
                                    config: config,
                                    onSave: async (newConfig) => {
                                        const response = await fetch('/api/configuracao-agenda', {
                                            method: 'PUT',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': `Bearer ${token}`
                                            },
                                            body: JSON.stringify(newConfig)
                                        });
                                        if (!response.ok) throw new Error('Falha ao salvar');
                                        if (typeof carregarEventos === 'function') carregarEventos();
                                    }
                                });
                            })
                            .catch(() => {
                                HiScheduleSettings.show({
                                    onSave: async (newConfig) => {
                                        console.log('Config:', newConfig);
                                    }
                                });
                            });
                        }
                    },
                    onBlockPeriod: () => {
                        // Abre modal de bloqueio de per√≠odo
                        if (typeof HiBlockPeriod !== 'undefined') {
                            const token = localStorage.getItem('authToken');
                            HiBlockPeriod.show({
                                onSave: async (bloqueio) => {
                                    const response = await fetch('/api/bloqueios', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify(bloqueio)
                                    });
                                    if (!response.ok) throw new Error('Falha ao criar bloqueio');
                                    if (typeof carregarEventos === 'function') carregarEventos();
                                }
                            });
                        }
                    },
                    onDashboard: () => {
                        window.location.href = '/static/dashboard.html';
                    },
                    onNewAppointment: () => {
                        // Abre modal de novo agendamento existente
                        if (typeof abrirModalNovoAgendamento === 'function') {
                            abrirModalNovoAgendamento();
                        }
                    }
                });
            }

            // Melhora o click em eventos do calend√°rio para usar HiPatientDetails
            document.addEventListener('hi:event-click', function(e) {
                const { agendamento } = e.detail;
                if (typeof HiPatientDetails !== 'undefined' && agendamento) {
                    HiPatientDetails.show({
                        paciente: agendamento.paciente || { nome: agendamento.paciente_nome },
                        agendamento: {
                            id: agendamento.id,
                            data: agendamento.data,
                            hora: agendamento.hora,
                            tipo: agendamento.tipo_consulta,
                            convenio: agendamento.convenio,
                            status: agendamento.status,
                            observacoes: agendamento.observacoes
                        },
                        onConfirm: async () => {
                            const token = localStorage.getItem('authToken');
                            await fetch(`/api/agendamentos/${agendamento.id}/confirmar`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (typeof carregarEventos === 'function') carregarEventos();
                            if (typeof HiToast !== 'undefined') HiToast.success('Presen√ßa confirmada!');
                        },
                        onReschedule: () => {
                            // Abre modal de reagendamento
                            if (typeof HiToast !== 'undefined') {
                                HiToast.info('Funcionalidade de reagendamento em desenvolvimento');
                            }
                        },
                        onCancel: async () => {
                            const token = localStorage.getItem('authToken');
                            await fetch(`/api/agendamentos/${agendamento.id}/cancelar`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (typeof carregarEventos === 'function') carregarEventos();
                            if (typeof HiToast !== 'undefined') HiToast.success('Agendamento cancelado');
                        }
                    });
                }
            });

            // Inicializa Bottom Navigation (apenas mobile)
            if (typeof HiBottomNav !== 'undefined') {
                HiBottomNav.init({
                    activeId: 'agenda',
                    items: [
                        {
                            id: 'agenda',
                            label: 'Agenda',
                            icon: 'fa-calendar-alt',
                            href: '/static/calendario-unificado.html'
                        },
                        {
                            id: 'config',
                            label: 'Hor√°rios',
                            icon: 'fa-clock',
                            onClick: () => {
                                if (typeof HiScheduleSettings !== 'undefined') {
                                    const token = localStorage.getItem('authToken');
                                    fetch('/api/configuracao-agenda', {
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    })
                                    .then(r => r.json())
                                    .then(config => {
                                        HiScheduleSettings.show({ config });
                                    })
                                    .catch(() => HiScheduleSettings.show({}));
                                }
                            }
                        },
                        {
                            id: 'novo',
                            label: 'Consulta',
                            icon: 'fa-plus',
                            primary: true,
                            onClick: () => {
                                if (typeof abrirModalNovoAgendamento === 'function') {
                                    abrirModalNovoAgendamento();
                                } else {
                                    document.dispatchEvent(new CustomEvent('hi:new-appointment'));
                                }
                            }
                        },
                        {
                            id: 'dashboard',
                            label: 'Painel',
                            icon: 'fa-chart-line',
                            href: '/static/dashboard.html'
                        },
                        {
                            id: 'perfil',
                            label: 'Perfil',
                            icon: 'fa-user',
                            href: '/static/perfil.html'
                        }
                    ]
                });
            }

            // Inicializa Pull-to-Refresh
            if (typeof HiPullRefresh !== 'undefined') {
                HiPullRefresh.init({
                    onRefresh: async () => {
                        if (typeof carregarEventos === 'function') {
                            await carregarEventos();
                        }
                        if (typeof HiToast !== 'undefined') {
                            HiToast.success('Agenda atualizada!');
                        }
                    }
                });
            }

            // WebSocket para atualiza√ß√µes em tempo real
            initWebSocket();
        });

        // ==================== WEBSOCKET TEMPO REAL ====================
        let ws = null;
        let wsReconnectAttempts = 0;
        const wsMaxReconnectAttempts = 5;

        function initWebSocket() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/conversas?token=${token}`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('üì° WebSocket conectado - atualiza√ß√µes em tempo real ativas');
                    wsReconnectAttempts = 0;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Erro ao processar mensagem WebSocket:', e);
                    }
                };

                ws.onclose = (event) => {
                    console.log('WebSocket desconectado:', event.code);
                    // Tentar reconectar
                    if (wsReconnectAttempts < wsMaxReconnectAttempts) {
                        wsReconnectAttempts++;
                        setTimeout(initWebSocket, 5000 * wsReconnectAttempts);
                    }
                };

                ws.onerror = (error) => {
                    console.error('Erro WebSocket:', error);
                };

            } catch (e) {
                console.error('Erro ao criar WebSocket:', e);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.tipo) {
                case 'novo_agendamento':
                    console.log('üìÖ Novo agendamento recebido via WebSocket:', data.agendamento);
                    // Recarregar eventos do calend√°rio
                    if (typeof carregarEventos === 'function') {
                        carregarEventos();
                    }
                    // Mostrar notifica√ß√£o
                    if (typeof HiToast !== 'undefined') {
                        const ag = data.agendamento;
                        HiToast.info(`Novo agendamento: ${ag.paciente_nome || 'Paciente'}`);
                    }
                    break;

                case 'agendamento_atualizado':
                    console.log('üîÑ Agendamento atualizado via WebSocket:', data.agendamento);
                    if (typeof carregarEventos === 'function') {
                        carregarEventos();
                    }
                    break;

                case 'conectado':
                    console.log('‚úÖ WebSocket confirmado:', data.message);
                    break;

                case 'pong':
                    // Resposta ao ping, n√£o faz nada
                    break;
            }
        }

        // Ping peri√≥dico para manter conex√£o viva
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ tipo: 'ping' }));
            }
        }, 30000);
    </script>

    <!-- PWA Update Manager -->
    <script src="/static/js/pwa-updater.js?v=1.1.0"></script>

    <!-- FAB Nova Consulta -->
    <button id="fab-nova-consulta" class="fab-nova-consulta" onclick="abrirModalAgendamento()" aria-label="Agendar nova consulta">
        <i class="fas fa-plus"></i>
        <span class="fab-text">Nova Consulta</span>
    </button>
</body>
</html>
