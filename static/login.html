<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Horário Inteligente</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Agendamento e Gestão de Consultas para Profissionais de Saúde">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Horário Inteligente">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="/static/branding.js"></script>
    <script src="/static/js/utils/csrf.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">

    <style>
        /* Tema padrão (cliente) */
        body.context-default {
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
        }
        /* Tema admin */
        body.context-admin {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body.context-admin .login-card {
            background: #111827;
            border: 1px solid #374151;
        }
        body.context-admin .login-card * { color: #e5e7eb; }
        body.context-admin .login-card .text-gray-600 { color: #9ca3af !important; }
        body.context-admin .login-card input {
            background: #1f2937;
            border-color: #374151;
            color: #fff;
        }
        body.context-admin .login-card input::placeholder { color: #6b7280; }
        body.context-admin .login-card .btn-login {
            background: linear-gradient(to right, #7c3aed, #db2777);
        }
        body.context-admin .login-card .btn-login:hover {
            background: linear-gradient(to right, #6d28d9, #be185d);
        }
        body.context-admin .login-card .link-forgot { color: #9ca3af !important; }
        body.context-admin .login-card .link-forgot:hover { color: #a78bfa !important; }
        body.context-admin .login-logo { filter: brightness(0) invert(1); }
        /* Tema parceiro */
        body.context-parceiro {
            background: #0f172a;
        }
        body.context-parceiro .login-card {
            background: #111827;
            border: 1px solid #1f2937;
        }
        body.context-parceiro .login-card * { color: #e5e7eb; }
        body.context-parceiro .login-card .text-gray-600 { color: #9ca3af !important; }
        body.context-parceiro .login-card input {
            background: #1f2937;
            border-color: #374151;
            color: #fff;
        }
        body.context-parceiro .login-card input::placeholder { color: #6b7280; }
        body.context-parceiro .login-card .btn-login {
            background: linear-gradient(to right, #22c55e, #059669);
        }
        body.context-parceiro .login-card .btn-login:hover {
            background: linear-gradient(to right, #16a34a, #047857);
        }
        body.context-parceiro .login-card .link-forgot { color: #9ca3af !important; }
        body.context-parceiro .login-card .link-forgot:hover { color: #4ade80 !important; }
        body.context-parceiro .login-logo { filter: brightness(0) invert(1); }
    </style>
</head>
<body class="context-default min-h-screen flex items-center justify-center p-4">
    <div class="login-card bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 w-full max-w-md mx-auto">
        <!-- Logo e Título -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="inline-flex items-center justify-center mb-3 sm:mb-4">
                <img src="/static/images/logo.png" alt="Horário Inteligente" class="login-logo h-16 sm:h-20">
            </div>
            <p id="loginSubtitle" class="text-sm sm:text-base text-gray-600">Sistema de Agendamento para Profissionais de Saúde</p>
        </div>

        <!-- Mensagem de erro -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText"></span>
            </div>
        </div>

        <!-- Mensagem de email não verificado -->
        <div id="emailNaoVerificado" class="hidden bg-yellow-50 border border-yellow-400 text-yellow-800 px-4 py-4 rounded-lg mb-4">
            <div class="flex items-start mb-3">
                <i class="fas fa-envelope-circle-check mr-2 mt-1 text-yellow-600"></i>
                <div>
                    <p class="font-semibold">Email ainda não verificado</p>
                    <p class="text-sm mt-1">Verifique sua caixa de entrada e spam para o email de confirmação.</p>
                </div>
            </div>
            <button onclick="reenviarVerificacao()" id="btnReenviar" class="w-full bg-yellow-500 text-white py-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition">
                <i class="fas fa-paper-plane mr-1"></i>Reenviar Email de Verificação
            </button>
        </div>

        <!-- Mensagem de parceiro pendente -->
        <div id="parceiroPendente" class="hidden bg-blue-50 border border-blue-400 text-blue-800 px-4 py-4 rounded-lg mb-4">
            <div class="flex items-start">
                <i class="fas fa-clock mr-2 mt-1 text-blue-600"></i>
                <div>
                    <p class="font-semibold" id="parceiroStatusTitle">Cadastro em análise</p>
                    <p class="text-sm mt-1" id="parceiroStatusText"></p>
                </div>
            </div>
        </div>

        <!-- Formulário de Login -->
        <form id="loginForm" class="space-y-4 sm:space-y-6">
            <div>
                <label for="email" class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-envelope mr-1 sm:mr-2 text-gray-500"></i>
                    Email
                </label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    class="w-full px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="seu@email.com"
                    required
                    autocomplete="email"
                >
            </div>

            <div>
                <label for="password" class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-lock mr-1 sm:mr-2 text-gray-500"></i>
                    Senha
                </label>
                <div class="relative">
                    <input
                        type="password"
                        id="password"
                        name="password"
                        class="w-full px-3 py-2 sm:px-4 sm:py-3 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="••••••••"
                        required
                        autocomplete="current-password"
                    >
                    <button
                        type="button"
                        onclick="togglePassword()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 p-2 min-w-[44px] min-h-[44px] flex items-center justify-center"
                        aria-label="Mostrar senha"
                        id="togglePasswordBtn"
                    >
                        <i id="toggleIcon" class="fas fa-eye text-sm" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <button
                type="submit"
                id="submitBtn"
                class="btn-login w-full bg-blue-600 text-white py-3 text-base rounded-lg font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center min-h-[44px]"
            >
                <i class="fas fa-sign-in-alt mr-2" aria-hidden="true"></i>
                <span id="submitText">Entrar</span>
            </button>

            <!-- Links Úteis -->
            <div class="mt-4 text-center text-xs sm:text-sm">
                <a href="/static/esqueci-senha.html" class="link-forgot text-blue-600 hover:text-blue-800 hover:underline">
                    <i class="fas fa-key mr-1"></i>Esqueci minha senha
                </a>
            </div>

            <!-- Link de registro de parceiro (só no contexto parceiro) -->
            <div id="parceiroRegisterLink" class="hidden mt-4 text-center text-xs sm:text-sm">
                <a href="/static/parceiro/registro.html" class="text-green-400 hover:text-green-300">
                    <i class="fas fa-user-plus mr-1"></i>Quero ser parceiro
                </a>
            </div>

            <!-- Ainda não é cliente (só no contexto padrão) -->
            <div id="clienteContactLink" class="mt-6 pt-6 border-t border-gray-200 text-center">
                <p class="text-gray-600 text-sm">
                    Ainda não é cliente?
                    <a href="https://horariointeligente.com.br/#contato" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline ml-1">
                        Entre em contato
                    </a>
                </p>
            </div>
        </form>

        <!-- Footer segurança (admin/parceiro) -->
        <div id="securityFooter" class="hidden mt-6 text-center">
            <p class="text-xs text-gray-500">
                <i class="fas fa-shield-alt mr-1"></i>
                <span id="securityFooterText">Acesso restrito a usuários autorizados</span>
            </p>
        </div>
    </div>

    <script>
        // ============================================================
        // Detectar contexto (admin, parceiro, padrão)
        // ============================================================
        const urlParams = new URLSearchParams(window.location.search);
        const context = urlParams.get('context') || 'default';

        // Aplicar tema visual
        document.body.classList.remove('context-default');
        document.body.classList.add('context-' + (context === 'admin' || context === 'parceiro' ? context : 'default'));

        // Ajustar textos e links conforme contexto
        (function applyContext() {
            const subtitle = document.getElementById('loginSubtitle');
            const parceiroRegLink = document.getElementById('parceiroRegisterLink');
            const clienteLink = document.getElementById('clienteContactLink');
            const secFooter = document.getElementById('securityFooter');
            const secFooterText = document.getElementById('securityFooterText');

            if (context === 'admin') {
                subtitle.textContent = 'Painel Administrativo - Gestão Interna';
                document.title = 'Admin - Horário Inteligente';
                clienteLink.classList.add('hidden');
                secFooter.classList.remove('hidden');
                secFooterText.textContent = 'Acesso restrito a administradores';
            } else if (context === 'parceiro') {
                subtitle.textContent = 'Portal do Parceiro';
                document.title = 'Portal do Parceiro - Horário Inteligente';
                clienteLink.classList.add('hidden');
                parceiroRegLink.classList.remove('hidden');
                secFooter.classList.remove('hidden');
                secFooterText.textContent = 'Conexão segura';
            }
        })();

        // ============================================================
        // Verificar se já está logado
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar tokens existentes e redirecionar
            const authToken = localStorage.getItem('authToken');
            const adminToken = localStorage.getItem('adminToken');
            const parceiroToken = localStorage.getItem('parceiroToken');

            if (context === 'admin' && adminToken) {
                const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
                const dashboards = {
                    'admin': '/static/admin/dashboard.html',
                    'financeiro': '/static/admin/dashboard-financeiro.html',
                    'suporte': '/static/admin/dashboard-suporte.html'
                };
                window.location.href = dashboards[adminData.perfil] || '/static/admin/dashboard.html';
                return;
            }

            if (context === 'parceiro' && parceiroToken) {
                window.location.href = '/static/parceiro/dashboard.html';
                return;
            }

            if (context === 'default' && authToken) {
                verificarToken(authToken);
            }
        });

        async function verificarToken(token) {
            try {
                const response = await fetch('/api/auth/verify-token', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    redirectByUserType(data.user_type, JSON.parse(localStorage.getItem('userData') || '{}'));
                } else {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userData');
                }
            } catch (error) {
                console.error('Erro ao verificar token:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
            }
        }

        // ============================================================
        // Redirect baseado no tipo de usuário
        // ============================================================
        function redirectByUserType(userType, userData) {
            const v = Date.now(); // cache-bust
            const redirectMap = {
                'medico':      '/static/calendario-unificado.html?v=' + v,
                'secretaria':  '/static/conversas.html?v=' + v,
                'admin':       '/static/admin/dashboard.html?v=' + v,
                'financeiro':  '/static/admin/dashboard-financeiro.html?v=' + v,
                'suporte':     '/static/admin/dashboard-suporte.html?v=' + v,
                'parceiro':    '/static/parceiro/dashboard.html?v=' + v,
            };

            // Para admin, checar perfil específico
            if (userType === 'admin' && userData.perfil) {
                const perfilDashboard = redirectMap[userData.perfil];
                if (perfilDashboard) {
                    window.location.href = perfilDashboard;
                    return;
                }
            }

            // Secretária: fallback via is_secretaria
            if (userData.is_secretaria) {
                window.location.href = redirectMap['secretaria'];
                return;
            }

            window.location.href = redirectMap[userType] || ('/static/calendario-unificado.html?v=' + v);
        }

        // ============================================================
        // Toggle senha
        // ============================================================
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleBtn = document.getElementById('togglePasswordBtn');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
                toggleBtn.setAttribute('aria-label', 'Ocultar senha');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
                toggleBtn.setAttribute('aria-label', 'Mostrar senha');
            }
        }

        // ============================================================
        // Mensagens de erro e status
        // ============================================================
        let emailParaReenvio = '';

        function showError(message) {
            const emailNaoVerificado = document.getElementById('emailNaoVerificado');
            const parceiroPendente = document.getElementById('parceiroPendente');
            emailNaoVerificado.classList.add('hidden');
            parceiroPendente.classList.add('hidden');

            if (typeof HiToast !== 'undefined') {
                HiToast.error('Erro', message);
            } else {
                const errorDiv = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                setTimeout(() => { errorDiv.classList.add('hidden'); }, 5000);
            }
        }

        function showEmailNaoVerificado() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('parceiroPendente').classList.add('hidden');
            document.getElementById('emailNaoVerificado').classList.remove('hidden');
        }

        function showParceiroStatus(detail) {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('emailNaoVerificado').classList.add('hidden');

            const statusDiv = document.getElementById('parceiroPendente');
            const title = document.getElementById('parceiroStatusTitle');
            const text = document.getElementById('parceiroStatusText');

            if (detail === 'pendente_aprovacao') {
                title.textContent = 'Cadastro em análise';
                text.textContent = 'Seu cadastro está em análise. Você receberá um email quando sua parceria for aprovada.';
            } else if (detail === 'pendente_ativacao') {
                window.location.href = '/static/parceiro/pendente-ativacao.html';
                return;
            } else if (detail === 'conta_suspensa') {
                title.textContent = 'Conta suspensa';
                text.textContent = 'Sua conta está suspensa. Entre em contato com o administrador.';
            } else if (detail === 'conta_inativa') {
                title.textContent = 'Conta inativa';
                text.textContent = 'Sua conta está inativa. Entre em contato com o administrador.';
            } else {
                title.textContent = 'Acesso negado';
                text.textContent = detail || 'Conta do parceiro não está ativa';
            }

            statusDiv.classList.remove('hidden');
        }

        async function reenviarVerificacao() {
            if (!emailParaReenvio) {
                emailParaReenvio = document.getElementById('email').value;
            }

            if (!emailParaReenvio) {
                showError('Digite seu email para reenviar a verificação.');
                return;
            }

            const btn = document.getElementById('btnReenviar');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Enviando...';

            try {
                const response = await fetch('/api/auth/resend-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailParaReenvio })
                });

                const result = await response.json();

                if (result.sucesso) {
                    btn.innerHTML = '<i class="fas fa-check mr-1"></i>Email Enviado!';
                    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    btn.classList.add('bg-green-500');

                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Reenviar Email de Verificação';
                        btn.classList.remove('bg-green-500');
                        btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    }, 3000);
                } else {
                    showError(result.detail || 'Erro ao reenviar email.');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Reenviar Email de Verificação';
                }
            } catch (error) {
                console.error('Erro:', error);
                showError('Erro de conexão. Tente novamente.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Reenviar Email de Verificação';
            }
        }

        function setLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');

            if (loading) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
                submitText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entrando...';
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                submitText.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Entrar';
            }
        }

        // ============================================================
        // Armazenar tokens (unificado + legado para compatibilidade)
        // ============================================================
        function storeTokens(data) {
            const user = data.user;
            const userType = user.user_type || user.tipo;

            // Token unificado principal
            localStorage.setItem('authToken', data.access_token);
            localStorage.setItem('userData', JSON.stringify(user));

            if (data.refresh_token) {
                localStorage.setItem('refreshToken', data.refresh_token);
            }

            // Chaves legadas para compatibilidade com páginas existentes
            if (userType === 'admin' || userType === 'financeiro' || userType === 'suporte') {
                localStorage.setItem('adminToken', data.access_token);
                localStorage.setItem('adminData', JSON.stringify({
                    id: user.id,
                    nome: user.nome,
                    email: user.email,
                    perfil: user.perfil || userType
                }));
                // Financeiro também usa financeiroToken (dashboard legado)
                if (userType === 'financeiro') {
                    localStorage.setItem('financeiroToken', data.access_token);
                    localStorage.setItem('financeiroUser', JSON.stringify({
                        id: user.id,
                        nome: user.nome,
                        email: user.email,
                        perfil: user.perfil || userType
                    }));
                }
            }

            if (userType === 'parceiro') {
                localStorage.setItem('parceiroToken', data.access_token);
                localStorage.setItem('parceiroData', JSON.stringify({
                    id: user.id,
                    nome: user.nome,
                    email: user.email
                }));
            }
        }

        // ============================================================
        // Handler do formulário - Login unificado via JSON
        // ============================================================
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            setLoading(true);

            // Esconder mensagens anteriores
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('emailNaoVerificado').classList.add('hidden');
            document.getElementById('parceiroPendente').classList.add('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        senha: password
                    })
                });

                const data = await response.json();

                // Extrair mensagem de erro (detail pode ser string ou array de objetos)
                function extractDetail(d) {
                    if (!d) return '';
                    if (typeof d === 'string') return d;
                    if (Array.isArray(d)) return d.map(e => e.msg || e.message || JSON.stringify(e)).join('; ');
                    return String(d);
                }

                if (response.ok) {
                    // Login bem-sucedido
                    storeTokens(data);
                    redirectByUserType(data.user.user_type || data.user.tipo, data.user);
                } else if (response.status === 403) {
                    const detail = extractDetail(data.detail);

                    // Parceiro com status pendente/suspenso
                    if (['pendente_aprovacao', 'pendente_ativacao', 'conta_suspensa', 'conta_inativa'].includes(detail)) {
                        showParceiroStatus(detail);
                    }
                    // Email não verificado (cliente)
                    else if (detail.includes('Email não verificado') || detail.includes('email não verificado')) {
                        emailParaReenvio = email;
                        showEmailNaoVerificado();
                    }
                    else {
                        showError(detail || 'Acesso negado');
                    }
                    setLoading(false);
                } else {
                    showError(extractDetail(data.detail) || 'Email ou senha incorretos');
                    setLoading(false);
                }
            } catch (error) {
                console.error('Erro ao fazer login:', error);
                showError('Erro ao conectar com o servidor. Tente novamente.');
                setLoading(false);
            }
        });

        // Permitir Enter para submeter
        document.getElementById('email').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });
    </script>

    <!-- Design System Scripts -->
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/components/modal.js"></script>
    <script src="/static/js/utils/validation.js?v=1.1.0"></script>
    <script src="/static/js/hi-design-system.js?v=1.1.0"></script>

    <!-- PWA Update Manager (substitui registro manual do SW) -->
    <script src="/static/js/pwa-updater.js?v=1.1.0"></script>
</body>
</html>
