<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Profissional - Horário Inteligente</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Design System -->
    <link rel="stylesheet" href="/static/css/design-system.css">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: white;
            color: #6b7280;
        }
        .tab-inactive:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
    <!-- Demo Banner (só aparece em modo demo) -->
    <div id="demoBanner" class="hidden bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 px-4 text-sm">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-center gap-x-4 gap-y-1">
            <span class="inline-flex items-center gap-2">
                <i class="fas fa-flask"></i>
                <span class="hidden sm:inline">Ambiente de Demonstração</span>
                <span class="sm:hidden">Demo</span>
            </span>
            <span class="hidden sm:inline text-white/50">|</span>
            <button onclick="voltarParaDemos()" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-exchange-alt"></i>
                <span>Trocar Perfil</span>
            </button>
            <span class="hidden sm:inline text-white/50">|</span>
            <a href="/static/dashboard-demo.html" class="inline-flex items-center gap-1 hover:underline">
                <i class="fas fa-home"></i>
                <span>Dashboard Demo</span>
            </a>
        </div>
    </div>

    <div id="app" class="min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="/static/images/logo.png" alt="Horário Inteligente" class="w-20 h-20 object-contain">
                    <div>
                        <h1 class="text-2xl font-bold text-purple-600">Horário Inteligente</h1>
                        <p class="text-sm text-gray-600">Dashboard Analítico</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-gray-700 hidden sm:inline" id="userName">
                        <i class="fas fa-user-circle mr-2"></i>
                        Carregando...
                    </span>
                    <button
                        onclick="window.location.href = '/static/calendario-unificado.html'"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                    >
                        <i class="fas fa-calendar-alt"></i>
                        <span class="hidden sm:inline">Calendário</span>
                    </button>
                    <button
                        onclick="window.location.href = '/static/conversas.html'"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2 relative"
                    >
                        <i class="fas fa-comments"></i>
                        <span class="hidden sm:inline">Conversas</span>
                        <span id="badgeConversas" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                    <button
                        onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center gap-2"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Sair</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Filtro de Período -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex flex-wrap gap-3 justify-center items-center">
                    <span class="text-white font-semibold hidden sm:inline">
                        <i class="fas fa-calendar-check mr-2"></i>
                        Período:
                    </span>
                    <button
                        onclick="setPeriodo('mes_atual')"
                        id="btn_mes_atual"
                        class="tab-active px-6 py-3 rounded-lg font-semibold transition shadow-lg"
                    >
                        <i class="fas fa-calendar-day mr-2"></i>
                        Mês Atual
                    </button>
                    <button
                        onclick="setPeriodo('mes_anterior')"
                        id="btn_mes_anterior"
                        class="tab-inactive px-6 py-3 rounded-lg font-semibold transition shadow-lg"
                    >
                        <i class="fas fa-calendar-minus mr-2"></i>
                        Mês Anterior
                    </button>
                    <button
                        onclick="setPeriodo('12_meses')"
                        id="btn_12_meses"
                        class="tab-inactive px-6 py-3 rounded-lg font-semibold transition shadow-lg"
                    >
                        <i class="fas fa-chart-line mr-2"></i>
                        Últimos 12 Meses
                    </button>
                    <button
                        onclick="loadData()"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-3 rounded-lg transition flex items-center gap-2"
                    >
                        <i class="fas fa-sync-alt"></i>
                        Atualizar
                    </button>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-4">
            <!-- Título do Período -->
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-800 text-center" id="periodoTitulo">
                    <i class="fas fa-chart-pie mr-2"></i>
                    Carregando...
                </h2>
            </div>

            <!-- Cards de Métricas Principais -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Card Total Agendamentos -->
                <div class="bg-white p-6 rounded-lg shadow-lg card-hover border-l-4 border-blue-500">
                    <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                        <i class="fas fa-calendar-check text-blue-500 mr-2"></i>
                        Total Agendamentos
                    </h3>
                    <p class="text-4xl font-bold text-gray-800 mt-2" id="totalAgendamentos">0</p>
                    <p class="text-sm mt-2" id="variacaoAgendamentos">
                        <i class="fas fa-minus"></i> Aguardando dados...
                    </p>
                </div>

                <!-- Card Concluídos -->
                <div class="bg-white p-6 rounded-lg shadow-lg card-hover border-l-4 border-green-500">
                    <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Atendimentos Concluídos
                    </h3>
                    <p class="text-4xl font-bold text-gray-800 mt-2" id="totalConcluidos">0</p>
                    <p class="text-sm text-gray-600 mt-2" id="percentualConcluidos">0% do total</p>
                </div>

                <!-- Card Taxa de Comparecimento -->
                <div class="bg-white p-6 rounded-lg shadow-lg card-hover border-l-4 border-purple-500">
                    <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                        <i class="fas fa-user-check text-purple-500 mr-2"></i>
                        Taxa de Comparecimento
                    </h3>
                    <p class="text-4xl font-bold text-gray-800 mt-2" id="taxaComparecimento">0%</p>
                    <p class="text-sm mt-2" id="variacaoTaxa">
                        <i class="fas fa-minus"></i> Aguardando dados...
                    </p>
                </div>

            </div>

            <!-- Cards Secundários -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg shadow border-l-4 border-blue-400">
                    <h3 class="text-blue-700 text-sm font-semibold">Confirmados</h3>
                    <p class="text-2xl font-bold text-blue-900" id="totalConfirmados">0</p>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg shadow border-l-4 border-yellow-400">
                    <h3 class="text-yellow-700 text-sm font-semibold">Remarcados</h3>
                    <p class="text-2xl font-bold text-yellow-900" id="totalRemarcados">0</p>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg shadow border-l-4 border-red-400">
                    <h3 class="text-red-700 text-sm font-semibold">Cancelados</h3>
                    <p class="text-2xl font-bold text-red-900" id="totalCancelados">0</p>
                </div>
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-4 rounded-lg shadow border-l-4 border-gray-400">
                    <h3 class="text-gray-700 text-sm font-semibold">Faltas</h3>
                    <p class="text-2xl font-bold text-gray-900" id="totalFaltas">0</p>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de Pizza - Distribuição por Status -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie text-purple-600 mr-2"></i>
                        Distribuição por Status
                    </h3>
                    <canvas id="chartStatus" style="max-height: 300px;"></canvas>
                </div>

                <!-- Gráfico de Barras - Agendamentos por Período -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-bar text-blue-600 mr-2"></i>
                        Agendamentos por <span id="tipoGraficoBarra">Dia</span>
                    </h3>
                    <canvas id="chartAgendamentos" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Informações Adicionais -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top Convênios -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-hospital-user text-green-600 mr-2"></i>
                        Top 5 Convênios
                    </h3>
                    <div id="topConvenios" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">Carregando...</p>
                    </div>
                </div>

                <!-- Horários Mais Populares -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-clock text-orange-600 mr-2"></i>
                        Horários Mais Procurados
                    </h3>
                    <div id="topHorarios" class="space-y-2">
                        <p class="text-gray-500 text-center py-4">Carregando...</p>
                    </div>
                </div>
            </div>

            <!-- Seção Financeira (Oculta por Padrão) -->
            <div class="mb-6">
                <!-- Botão para exibir dados financeiros -->
                <div id="btnExibirFinanceiro" class="bg-white p-4 rounded-lg shadow-lg border-2 border-dashed border-gray-300 hover:border-emerald-400 transition cursor-pointer" onclick="toggleDadosFinanceiros()">
                    <div class="flex items-center justify-center gap-3 text-gray-600 hover:text-emerald-600 transition">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-lock text-xl"></i>
                        </div>
                        <div class="text-left">
                            <p class="font-semibold">Dados Financeiros</p>
                            <p class="text-sm text-gray-500">Clique para exibir faturamento e valores</p>
                        </div>
                        <i class="fas fa-chevron-down ml-4"></i>
                    </div>
                </div>

                <!-- Conteúdo Financeiro (Oculto) -->
                <div id="secaoFinanceira" class="hidden mt-4">
                    <!-- Header da Seção -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-dollar-sign text-emerald-600 mr-2"></i>
                            Dados Financeiros
                        </h3>
                        <button onclick="toggleDadosFinanceiros()" class="text-gray-500 hover:text-gray-700 flex items-center gap-2 text-sm">
                            <i class="fas fa-eye-slash"></i>
                            Ocultar
                        </button>
                    </div>

                    <!-- Cards Financeiros -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-green-600 p-6 rounded-lg shadow-lg">
                            <h3 class="text-emerald-100 text-sm font-semibold flex items-center">
                                <i class="fas fa-coins mr-2"></i>
                                Faturamento do Período
                            </h3>
                            <p class="text-3xl font-bold text-white mt-2" id="faturamentoTotal">R$ 0</p>
                            <p class="text-sm text-emerald-200 mt-1" id="qtdAtendimentos">0 atendimentos</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-indigo-500">
                            <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                                <i class="fas fa-user-md text-indigo-500 mr-2"></i>
                                Consultas Particulares
                            </h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="faturamentoParticular">R$ 0</p>
                            <p class="text-sm text-indigo-600 mt-1" id="qtdParticular">0 consultas</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
                            <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                                <i class="fas fa-hospital text-blue-500 mr-2"></i>
                                Convênios (Repasse)
                            </h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="faturamentoConvenio">R$ 0</p>
                            <p class="text-sm text-blue-600 mt-1" id="qtdConvenio">0 consultas</p>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-purple-500">
                            <h3 class="text-gray-500 text-sm font-semibold flex items-center">
                                <i class="fas fa-receipt text-purple-500 mr-2"></i>
                                Ticket Médio
                            </h3>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="ticketMedio">R$ 0</p>
                            <p class="text-sm text-purple-600 mt-1">por atendimento</p>
                        </div>
                    </div>

                    <!-- Gráfico Previsto vs Realizado -->
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-4">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-chart-bar text-emerald-500 mr-2"></i>
                                Previsto vs Realizado
                            </h4>
                            <select id="mesFaturamentoPrevisto" class="text-sm border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-emerald-500" onchange="carregarPrevistoRealizado()">
                                <!-- Opções serão preenchidas dinamicamente -->
                            </select>
                        </div>

                        <!-- Cards de resumo -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <div class="bg-blue-50 rounded-lg p-3 text-center">
                                <p class="text-xs text-blue-600 font-medium">Previsto</p>
                                <p class="text-lg font-bold text-blue-700" id="previstoValor">R$ 0</p>
                                <p class="text-xs text-blue-500" id="previstoQtd">0 consultas</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-3 text-center">
                                <p class="text-xs text-green-600 font-medium">Realizado</p>
                                <p class="text-lg font-bold text-green-700" id="realizadoValor">R$ 0</p>
                                <p class="text-xs text-green-500" id="realizadoQtd">0 consultas</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                <p class="text-xs text-yellow-600 font-medium">Pendente</p>
                                <p class="text-lg font-bold text-yellow-700" id="pendenteValor">R$ 0</p>
                                <p class="text-xs text-yellow-500" id="pendenteQtd">0 consultas</p>
                            </div>
                            <div class="bg-red-50 rounded-lg p-3 text-center">
                                <p class="text-xs text-red-600 font-medium">Perdido</p>
                                <p class="text-lg font-bold text-red-700" id="perdidoValor">R$ 0</p>
                                <p class="text-xs text-red-500" id="perdidoQtd">0 consultas</p>
                            </div>
                        </div>

                        <!-- Gráfico de barras -->
                        <div class="relative" style="height: 250px;">
                            <canvas id="chartPrevistoRealizado"></canvas>
                        </div>

                        <!-- Barra de progresso -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-600">Realizado vs Previsto</span>
                                <span class="text-sm font-bold text-emerald-600" id="percentualRealizadoFinanceiro">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full transition-all duration-500" id="barraProgressoFinanceiro" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Breakdown por Convênio com Gráfico -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Gráfico de Pizza -->
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                                Distribuição por Tipo
                            </h4>
                            <div class="flex justify-center">
                                <canvas id="chartFinanceiro" style="max-height: 280px; max-width: 280px;"></canvas>
                            </div>
                        </div>

                        <!-- Cards por Convênio -->
                        <div class="bg-white p-6 rounded-lg shadow-lg">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-list-ol text-emerald-500 mr-2"></i>
                                Detalhamento
                            </h4>
                            <div id="faturamentoPorTipo" class="space-y-3">
                                <p class="text-gray-500 text-center py-4">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utilidade: Escape HTML (Prevenção XSS)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Estado Global
        let periodoAtual = 'mes_atual';
        let chartStatusInstance = null;
        let chartAgendamentosInstance = null;
        let chartFinanceiroInstance = null;
        let chartPrevistoRealizadoInstance = null;

        // Verificar autenticação
        const token = localStorage.getItem('authToken');
        const userData = localStorage.getItem('userData');

        if (!token || !userData) {
            window.location.href = '/static/login.html';
        }

        const user = JSON.parse(userData);

        // Secretárias não têm acesso ao dashboard
        if (user.is_secretaria) {
            window.location.href = '/static/conversas.html';
        }

        document.getElementById('userName').innerHTML = `<i class="fas fa-user-circle mr-2"></i>${escapeHtml(user.nome)}`;

        // Função de Logout
        function logout() {
            localStorage.clear();
            window.location.href = '/static/login.html';
        }

        // Carregar badge de conversas não lidas
        async function carregarBadgeConversas() {
            try {
                const response = await fetch('/api/conversas/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const stats = await response.json();
                    const badge = document.getElementById('badgeConversas');
                    if (stats.total_nao_lidas > 0) {
                        badge.textContent = stats.total_nao_lidas > 9 ? '9+' : stats.total_nao_lidas;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (e) {
                console.log('Erro ao carregar badge conversas:', e);
            }
        }
        // Carregar badge ao iniciar e a cada 30 segundos
        carregarBadgeConversas();
        setInterval(carregarBadgeConversas, 30000);

        // Estado dos dados financeiros
        let dadosFinanceirosVisiveis = false;
        let dadosFinanceirosCarregados = false;

        // Função para exibir/ocultar dados financeiros
        function toggleDadosFinanceiros() {
            dadosFinanceirosVisiveis = !dadosFinanceirosVisiveis;

            const btnExibir = document.getElementById('btnExibirFinanceiro');
            const secaoFinanceira = document.getElementById('secaoFinanceira');

            if (dadosFinanceirosVisiveis) {
                btnExibir.classList.add('hidden');
                secaoFinanceira.classList.remove('hidden');

                // Carregar dados financeiros se ainda não foram carregados
                if (!dadosFinanceirosCarregados) {
                    carregarDadosFinanceiros();
                }
            } else {
                btnExibir.classList.remove('hidden');
                secaoFinanceira.classList.add('hidden');
            }
        }

        // Função para carregar dados financeiros
        async function carregarDadosFinanceiros() {
            try {
                const response = await fetch(`/api/dashboard/financeiro?periodo=${periodoAtual}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderizarDadosFinanceiros(data);
                    dadosFinanceirosCarregados = true;
                } else {
                    // Se não houver API de financeiro, usar dados simulados para demo
                    renderizarDadosFinanceirosDemo();
                    dadosFinanceirosCarregados = true;
                }
            } catch (error) {
                console.error('Erro ao carregar dados financeiros:', error);
                // Usar dados simulados em caso de erro
                renderizarDadosFinanceirosDemo();
                dadosFinanceirosCarregados = true;
            }

            // Inicializar e carregar gráfico Previsto vs Realizado
            inicializarSeletorMesPrevisto();
            carregarPrevistoRealizado();
        }

        // Função para renderizar dados financeiros da API
        function renderizarDadosFinanceiros(data) {
            document.getElementById('faturamentoTotal').textContent = `R$ ${data.faturamento_total.toLocaleString('pt-BR')}`;
            document.getElementById('qtdAtendimentos').textContent = `${data.total_atendimentos} atendimentos`;

            document.getElementById('faturamentoParticular').textContent = `R$ ${data.particular.valor.toLocaleString('pt-BR')}`;
            document.getElementById('qtdParticular').textContent = `${data.particular.quantidade} consultas`;

            document.getElementById('faturamentoConvenio').textContent = `R$ ${data.convenio.valor.toLocaleString('pt-BR')}`;
            document.getElementById('qtdConvenio').textContent = `${data.convenio.quantidade} consultas`;

            document.getElementById('ticketMedio').textContent = `R$ ${data.ticket_medio.toLocaleString('pt-BR')}`;

            // Renderizar breakdown por tipo
            renderizarBreakdown(data.por_convenio);
        }

        // Função para mostrar dados zerados quando não há dados financeiros reais
        function renderizarDadosFinanceirosDemo() {
            // Sem dados reais - mostrar zeros
            document.getElementById('faturamentoTotal').textContent = 'R$ 0';
            document.getElementById('qtdAtendimentos').textContent = '0 atendimentos';

            document.getElementById('faturamentoParticular').textContent = 'R$ 0';
            document.getElementById('qtdParticular').textContent = '0 consultas';

            document.getElementById('faturamentoConvenio').textContent = 'R$ 0';
            document.getElementById('qtdConvenio').textContent = '0 consultas';

            document.getElementById('ticketMedio').textContent = 'R$ 0';

            // Sem breakdown - array vazio
            renderizarBreakdown([]);
        }

        // Função para renderizar breakdown por tipo/convênio
        function renderizarBreakdown(data) {
            const container = document.getElementById('faturamentoPorTipo');

            const coresHex = {
                'Particular': '#6366f1',
                'SulAmérica': '#22c55e',
                'Amil': '#3b82f6',
                'Unimed': '#f97316',
                'Bradesco Saúde': '#ef4444',
                'Hapvida': '#14b8a6'
            };

            const coresTailwind = {
                'Particular': 'indigo',
                'SulAmérica': 'green',
                'Amil': 'blue',
                'Unimed': 'orange',
                'Bradesco Saúde': 'red',
                'Hapvida': 'teal'
            };

            // Sempre renderizar o gráfico (mesmo com dados vazios)
            renderizarGraficoFinanceiro(data || [], coresHex);

            // Verificar se há dados para o detalhamento
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Sem dados disponíveis</p>';
                return;
            }

            // Renderizar lista de detalhamento
            container.innerHTML = data.map((item, index) => {
                const cor = coresTailwind[item.nome] || 'gray';
                const percent = item.percent || 0;
                const valor = item.valor || 0;
                const corHex = coresHex[item.nome] || '#6b7280';

                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${corHex}"></div>
                            <span class="font-medium text-gray-700">${escapeHtml(item.nome)}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800">R$ ${valor.toLocaleString('pt-BR')}</p>
                            <p class="text-xs text-gray-500">${percent}%</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Função para renderizar gráfico de pizza financeiro
        function renderizarGraficoFinanceiro(data, coresHex) {
            const canvas = document.getElementById('chartFinanceiro');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destruir gráfico anterior se existir
            if (chartFinanceiroInstance) {
                chartFinanceiroInstance.destroy();
                chartFinanceiroInstance = null;
            }

            // Se não houver dados, mostrar mensagem no lugar do gráfico
            if (!data || data.length === 0) {
                // Limpar canvas e mostrar mensagem
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const container = canvas.parentElement;

                // Verificar se já existe mensagem de "sem dados"
                let msgElement = container.querySelector('.no-data-msg');
                if (!msgElement) {
                    msgElement = document.createElement('div');
                    msgElement.className = 'no-data-msg text-gray-500 text-center py-8';
                    msgElement.innerHTML = '<i class="fas fa-chart-pie text-4xl text-gray-300 mb-2"></i><p>Sem dados para exibir</p>';
                    container.appendChild(msgElement);
                }
                canvas.style.display = 'none';
                return;
            }

            // Remover mensagem de "sem dados" se existir e mostrar canvas
            const container = canvas.parentElement;
            const msgElement = container.querySelector('.no-data-msg');
            if (msgElement) {
                msgElement.remove();
            }
            canvas.style.display = 'block';

            const labels = data.map(item => item.nome);
            const valores = data.map(item => item.valor);
            const cores = data.map(item => coresHex[item.nome] || '#6b7280');

            chartFinanceiroInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: cores,
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '55%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: R$ ${value.toLocaleString('pt-BR')} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // GRÁFICO PREVISTO VS REALIZADO
        // ==========================================
        function inicializarSeletorMesPrevisto() {
            const select = document.getElementById('mesFaturamentoPrevisto');
            if (!select) return;

            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const hoje = new Date();
            const anoAtual = hoje.getFullYear();
            const mesAtual = hoje.getMonth();

            // Opções: 3 meses anteriores + mês atual + 2 próximos meses
            for (let i = -3; i <= 2; i++) {
                let mes = mesAtual + i;
                let ano = anoAtual;
                if (mes < 0) { mes += 12; ano--; }
                if (mes > 11) { mes -= 12; ano++; }

                const option = document.createElement('option');
                option.value = `${ano}-${mes + 1}`;
                option.textContent = `${meses[mes]} ${ano}`;
                if (i === 0) option.selected = true;
                select.appendChild(option);
            }
        }

        async function carregarPrevistoRealizado() {
            const select = document.getElementById('mesFaturamentoPrevisto');
            if (!select || !select.value) return;

            const [ano, mes] = select.value.split('-').map(Number);

            try {
                const response = await fetch(`/api/dashboard/financeiro/resumo?mes=${mes}&ano=${ano}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Erro ao carregar dados');

                const data = await response.json();
                atualizarUIPrevistoRealizado(data);
                renderizarGraficoPrevistoRealizado(data);

            } catch (error) {
                console.error('Erro ao carregar previsto/realizado:', error);
                // Mostrar dados zerados em caso de erro
                atualizarUIPrevistoRealizado({
                    previsto: { total_consultas: 0, valor: 0 },
                    realizado: { total_consultas: 0, valor: 0 },
                    pendente: { total_consultas: 0, valor: 0 },
                    perdido: { total_consultas: 0, valor: 0 },
                    percentual_realizado: 0
                });
            }
        }

        function formatarMoedaBR(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }

        function atualizarUIPrevistoRealizado(data) {
            // Atualizar cards
            document.getElementById('previstoValor').textContent = formatarMoedaBR(data.previsto?.valor);
            document.getElementById('previstoQtd').textContent = `${data.previsto?.total_consultas || 0} consultas`;

            document.getElementById('realizadoValor').textContent = formatarMoedaBR(data.realizado?.valor);
            document.getElementById('realizadoQtd').textContent = `${data.realizado?.total_consultas || 0} consultas`;

            document.getElementById('pendenteValor').textContent = formatarMoedaBR(data.pendente?.valor);
            document.getElementById('pendenteQtd').textContent = `${data.pendente?.total_consultas || 0} consultas`;

            document.getElementById('perdidoValor').textContent = formatarMoedaBR(data.perdido?.valor);
            document.getElementById('perdidoQtd').textContent = `${data.perdido?.total_consultas || 0} consultas`;

            // Atualizar barra de progresso
            const percentual = Math.min(100, data.percentual_realizado || 0);
            document.getElementById('percentualRealizadoFinanceiro').textContent = `${percentual.toFixed(1)}%`;
            document.getElementById('barraProgressoFinanceiro').style.width = `${percentual}%`;
        }

        function renderizarGraficoPrevistoRealizado(data) {
            const canvas = document.getElementById('chartPrevistoRealizado');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // Destruir gráfico anterior se existir
            if (chartPrevistoRealizadoInstance) {
                chartPrevistoRealizadoInstance.destroy();
            }

            chartPrevistoRealizadoInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Previsto', 'Realizado', 'Pendente', 'Perdido'],
                    datasets: [{
                        label: 'Valor (R$)',
                        data: [
                            data.previsto?.valor || 0,
                            data.realizado?.valor || 0,
                            data.pendente?.valor || 0,
                            data.perdido?.valor || 0
                        ],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',   // Azul - Previsto
                            'rgba(34, 197, 94, 0.8)',   // Verde - Realizado
                            'rgba(234, 179, 8, 0.8)',   // Amarelo - Pendente
                            'rgba(239, 68, 68, 0.8)'    // Vermelho - Perdido
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(234, 179, 8)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatarMoedaBR(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Função para trocar período
        function setPeriodo(periodo) {
            periodoAtual = periodo;

            // Resetar flag para recarregar dados financeiros quando o período muda
            dadosFinanceirosCarregados = false;
            if (dadosFinanceirosVisiveis) {
                carregarDadosFinanceiros();
            }

            // Atualizar visual das abas
            document.querySelectorAll('[id^="btn_"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });

            document.getElementById(`btn_${periodo}`).classList.remove('tab-inactive');
            document.getElementById(`btn_${periodo}`).classList.add('tab-active');

            // Carregar dados
            loadData();
        }

        // Função para carregar dados da API
        async function loadData() {
            try {
                const response = await fetch(`/api/dashboard/metricas?periodo=${periodoAtual}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar dados');
                }

                const data = await response.json();
                renderizarDashboard(data);
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar métricas. Verifique sua conexão.');
            }
        }

        // Função para renderizar dashboard
        function renderizarDashboard(data) {
            // Título do período
            document.getElementById('periodoTitulo').textContent = data.mes_ano;

            // Cards principais
            document.getElementById('totalAgendamentos').textContent = data.total_agendamentos;
            document.getElementById('totalConcluidos').textContent = data.concluidos;
            document.getElementById('taxaComparecimento').textContent = `${data.taxa_comparecimento}%`;

            // Percentual de concluídos
            const percConcluidos = data.total_agendamentos > 0
                ? ((data.concluidos / data.total_agendamentos) * 100).toFixed(1)
                : 0;
            document.getElementById('percentualConcluidos').textContent = `${percConcluidos}% do total`;

            // Comparativo (se disponível)
            if (data.comparativo_anterior) {
                const varAgend = data.comparativo_anterior.variacao_agendamentos;
                const iconAgend = varAgend >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const colorAgend = varAgend >= 0 ? 'text-green-600' : 'text-red-600';

                document.getElementById('variacaoAgendamentos').innerHTML = `
                    <i class="fas ${iconAgend} ${colorAgend}"></i>
                    <span class="${colorAgend} font-semibold">${Math.abs(varAgend).toFixed(1)}%</span>
                    <span class="text-gray-600"> vs período anterior</span>
                `;

                const varTaxa = data.comparativo_anterior.variacao_taxa;
                const iconTaxa = varTaxa >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const colorTaxa = varTaxa >= 0 ? 'text-green-600' : 'text-red-600';

                document.getElementById('variacaoTaxa').innerHTML = `
                    <i class="fas ${iconTaxa} ${colorTaxa}"></i>
                    <span class="${colorTaxa} font-semibold">${Math.abs(varTaxa).toFixed(1)}%</span>
                    <span class="text-gray-600"> vs período anterior</span>
                `;
            } else {
                document.getElementById('variacaoAgendamentos').innerHTML = `
                    <i class="fas fa-info-circle text-gray-400"></i>
                    <span class="text-gray-500">Sem comparativo disponível</span>
                `;
                document.getElementById('variacaoTaxa').innerHTML = `
                    <i class="fas fa-info-circle text-gray-400"></i>
                    <span class="text-gray-500">Sem comparativo disponível</span>
                `;
            }

            // Cards secundários
            document.getElementById('totalConfirmados').textContent = data.confirmados;
            document.getElementById('totalRemarcados').textContent = data.remarcados;
            document.getElementById('totalCancelados').textContent = data.cancelados;
            document.getElementById('totalFaltas').textContent = data.faltou;

            // Gráficos
            renderizarGraficoStatus(data.por_status);
            renderizarGraficoAgendamentos(data.por_dia);

            // Convênios e Horários
            renderizarTopConvenios(data.por_convenio || []);
            renderizarTopHorarios(data.horarios_populares || []);

            // Atualizar label do gráfico de barras
            document.getElementById('tipoGraficoBarra').textContent =
                periodoAtual === '12_meses' ? 'Mês' : 'Dia';
        }

        // Gráfico de Pizza - Status
        function renderizarGraficoStatus(porStatus) {
            const ctx = document.getElementById('chartStatus').getContext('2d');

            // Destruir gráfico anterior se existir
            if (chartStatusInstance) {
                chartStatusInstance.destroy();
            }

            const labels = porStatus.map(item => item.status);
            const valores = porStatus.map(item => item.quantidade);
            const cores = porStatus.map(item => item.cor);

            chartStatusInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: cores,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de Barras - Agendamentos por Dia/Mês
        function renderizarGraficoAgendamentos(porDia) {
            const ctx = document.getElementById('chartAgendamentos').getContext('2d');

            // Destruir gráfico anterior se existir
            if (chartAgendamentosInstance) {
                chartAgendamentosInstance.destroy();
            }

            const labels = porDia.map(item => item.dia);
            const valores = porDia.map(item => item.quantidade);

            chartAgendamentosInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Agendamentos',
                        data: valores,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Agendamentos: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Renderizar Top Convênios
        function renderizarTopConvenios(convenios) {
            const container = document.getElementById('topConvenios');

            if (convenios.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum dado disponível</p>';
                return;
            }

            const maxQtd = Math.max(...convenios.map(c => c.quantidade));

            container.innerHTML = convenios.map((item, index) => {
                const percentage = (item.quantidade / maxQtd) * 100;
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500'];

                return `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 w-1/3">${escapeHtml(item.convenio)}</span>
                        <div class="flex-1 mx-3">
                            <div class="bg-gray-200 rounded-full h-4">
                                <div class="${colors[index % colors.length]} h-4 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-bold text-gray-800">${item.quantidade}</span>
                    </div>
                `;
            }).join('');
        }

        // Renderizar Top Horários
        function renderizarTopHorarios(horarios) {
            const container = document.getElementById('topHorarios');

            if (horarios.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum dado disponível</p>';
                return;
            }

            const maxQtd = Math.max(...horarios.map(h => h.quantidade));

            container.innerHTML = horarios.map((item, index) => {
                const percentage = (item.quantidade / maxQtd) * 100;
                const colors = ['bg-orange-500', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500'];

                return `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700 w-1/4">
                            <i class="fas fa-clock text-orange-500 mr-2"></i>${escapeHtml(item.horario)}
                        </span>
                        <div class="flex-1 mx-3">
                            <div class="bg-gray-200 rounded-full h-4">
                                <div class="${colors[index % colors.length]} h-4 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-bold text-gray-800">${item.quantidade}</span>
                    </div>
                `;
            }).join('');
        }

        // Carregar dados iniciais
        loadData();
    </script>

    <!-- Mobile Components -->
    <script src="/static/js/components/toast.js"></script>
    <script src="/static/js/components/bottom-nav.js"></script>
    <script src="/static/js/components/pull-refresh.js"></script>

    <!-- Mobile Navigation & Demo Mode -->
    <script>
        // Função para voltar para seleção de demos
        function voltarParaDemos() {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('medico');
            localStorage.removeItem('cliente_id');
            localStorage.removeItem('demo_mode');
            localStorage.removeItem('demo_tour_done');
            window.location.href = '/static/demo/index.html';
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar banner de demo se estiver em modo demo
            if (localStorage.getItem('demo_mode') === 'true') {
                const demoBanner = document.getElementById('demoBanner');
                if (demoBanner) {
                    demoBanner.classList.remove('hidden');
                }
            }

            // Inicializa Bottom Navigation
            if (typeof HiBottomNav !== 'undefined') {
                HiBottomNav.init({
                    activeId: 'dashboard',
                    items: [
                        { id: 'agenda', label: 'Agenda', icon: 'fa-calendar-alt', href: '/static/calendario-unificado.html' },
                        { id: 'conversas', label: 'Conversas', icon: 'fa-comments', href: '/static/conversas.html' },
                        { id: 'novo', label: 'Novo', icon: 'fa-plus', primary: true, onClick: () => { window.location.href = '/static/calendario-unificado.html'; }},
                        { id: 'dashboard', label: 'Painel', icon: 'fa-chart-line', href: '/static/dashboard.html' },
                        { id: 'perfil', label: 'Perfil', icon: 'fa-user', href: '/static/perfil.html' }
                    ]
                });
            }

            // Inicializa Pull-to-Refresh
            if (typeof HiPullRefresh !== 'undefined') {
                HiPullRefresh.init({
                    onRefresh: async () => {
                        if (typeof loadData === 'function') await loadData();
                        if (typeof HiToast !== 'undefined') HiToast.success('Painel atualizado!');
                    }
                });
            }
        });
    </script>

    <!-- PWA Update Manager -->
    <script src="/static/js/pwa-updater.js?v=1.1.0"></script>
</body>
</html>
