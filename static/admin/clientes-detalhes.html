<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Cliente - Admin Horário Inteligente</title>

    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #0f172a; }
        .loader {
            border: 3px solid #374151;
            border-top: 3px solid #8b5cf6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="/static/admin/clientes.html" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-500">
                    <i class="fas fa-building text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white" id="headerNome">Carregando...</h1>
                    <p class="text-sm text-gray-400" id="headerSubdomain">-</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a id="btnSetup" href="#" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition text-sm flex items-center gap-2">
                    <i class="fas fa-cogs"></i>
                    <span class="hidden sm:inline">Setup</span>
                </a>
                <span id="statusBadge" class="px-3 py-1 rounded-full text-sm font-medium">-</span>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loadingState" class="flex items-center justify-center py-20">
            <div class="loader"></div>
            <span class="text-gray-400 ml-3">Carregando detalhes...</span>
        </div>

        <!-- Conteúdo -->
        <div id="conteudo" class="hidden">
            <!-- Estatísticas -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-center justify-between">
                        <i class="fas fa-user-md text-purple-500 text-xl"></i>
                        <span class="text-2xl font-bold text-white" id="statMedicos">0</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">Profissionais</p>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-center justify-between">
                        <i class="fas fa-users text-blue-500 text-xl"></i>
                        <span class="text-2xl font-bold text-white" id="statPacientes">0</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">Pacientes</p>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-center justify-between">
                        <i class="fas fa-calendar-check text-green-500 text-xl"></i>
                        <span class="text-2xl font-bold text-white" id="statAgendamentos">0</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">Agendamentos</p>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
                    <div class="flex items-center justify-between">
                        <i class="fas fa-calendar text-yellow-500 text-xl"></i>
                        <span class="text-2xl font-bold text-white" id="statCriado">-</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-1">Cliente desde</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Coluna 1: Dados da Clínica -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Informações -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center justify-between">
                            <span><i class="fas fa-info-circle mr-2 text-blue-400"></i>Informações</span>
                            <button onclick="toggleEditMode()" id="btnEditar" class="text-sm text-purple-400 hover:text-purple-300">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                        </h2>

                        <div id="infoView" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-500 text-sm">Nome</span>
                                <p class="text-white" id="infoNome">-</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">Email</span>
                                <p class="text-white" id="infoEmail">-</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">Telefone</span>
                                <p class="text-white" id="infoTelefone">-</p>
                            </div>
                            <div>
                                <span class="text-gray-500 text-sm">WhatsApp</span>
                                <p class="text-white" id="infoWhatsApp">-</p>
                            </div>
                            <div class="md:col-span-2">
                                <span class="text-gray-500 text-sm">Endereço</span>
                                <p class="text-white" id="infoEndereco">-</p>
                            </div>
                        </div>

                        <div id="infoEdit" class="hidden space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Nome</label>
                                    <input type="text" id="editNome"
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Email</label>
                                    <input type="email" id="editEmail"
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Telefone</label>
                                    <input type="tel" id="editTelefone"
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-400 mb-1">Endereço</label>
                                    <input type="text" id="editEndereco"
                                           class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="salvarEdicao()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                    <i class="fas fa-save mr-1"></i>Salvar
                                </button>
                                <button onclick="toggleEditMode()" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Médicos -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center justify-between">
                            <span><i class="fas fa-user-md mr-2 text-purple-400"></i>Profissionais</span>
                            <button onclick="abrirModalMedico()" class="text-sm bg-purple-600 text-white px-3 py-1 rounded-lg hover:bg-purple-700 transition">
                                <i class="fas fa-plus mr-1"></i>Adicionar
                            </button>
                        </h2>
                        <div id="listaMedicos" class="space-y-3">
                            <!-- Preenchido via JS -->
                        </div>
                    </div>

                    <!-- Usuários -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center justify-between">
                            <span><i class="fas fa-users-cog mr-2 text-green-400"></i>Usuários</span>
                            <button onclick="abrirModalUsuario()" class="text-sm bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition">
                                <i class="fas fa-plus mr-1"></i>Adicionar
                            </button>
                        </h2>
                        <div id="listaUsuarios" class="space-y-3">
                            <!-- Preenchido via JS -->
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Assinatura e Ações -->
                <div class="space-y-6">
                    <!-- Acesso -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-globe mr-2 text-cyan-400"></i>Acesso
                        </h2>
                        <a id="linkAcesso" href="#" target="_blank"
                           class="block bg-gray-800 rounded-lg p-4 hover:bg-gray-700 transition">
                            <p class="text-purple-400 text-sm font-mono break-all" id="urlAcesso">-</p>
                            <p class="text-gray-500 text-xs mt-2">
                                <i class="fas fa-external-link-alt mr-1"></i>Clique para abrir
                            </p>
                        </a>
                    </div>

                    <!-- Plano -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4 flex items-center justify-between">
                            <span><i class="fas fa-tag mr-2 text-yellow-400"></i>Plano</span>
                            <button onclick="abrirModalPlano()" class="text-sm text-purple-400 hover:text-purple-300">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                        </h2>
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-white font-semibold" id="planoNome">-</span>
                                <span class="text-green-400 font-bold" id="planoValor">-</span>
                            </div>
                            <p class="text-gray-400 text-sm" id="planoDescricao">-</p>
                        </div>
                    </div>

                    <!-- Ações -->
                    <div class="bg-gray-900 rounded-xl border border-gray-800 p-6">
                        <h2 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-cog mr-2 text-gray-400"></i>Ações
                        </h2>
                        <div class="space-y-3">
                            <div id="credenciaisButtonContainer"></div>
                            <button onclick="toggleStatusCliente()" id="btnToggleStatus"
                                    class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-ban"></i>
                                <span>Desativar Cliente</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Médico -->
    <div id="modalMedico" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4">Adicionar Profissional</h3>
                <form id="formMedico" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Nome *</label>
                        <input type="text" name="nome" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Especialidade *</label>
                        <input type="text" name="especialidade" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Registro (CRM/CRO) *</label>
                        <input type="text" name="registro_profissional" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email *</label>
                        <input type="email" name="email" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="pode_fazer_login" id="checkLogin" checked
                               class="w-4 h-4 bg-gray-800 border-gray-700 rounded">
                        <label for="checkLogin" class="text-gray-400 text-sm">Pode fazer login</label>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">
                            Adicionar
                        </button>
                        <button type="button" onclick="fecharModalMedico()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Usuário -->
    <div id="modalUsuario" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4">Adicionar Usuário</h3>
                <form id="formUsuario" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Nome *</label>
                        <input type="text" name="nome" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email *</label>
                        <input type="email" name="email" required
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Telefone</label>
                        <input type="tel" name="telefone"
                               class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Tipo</label>
                        <select name="tipo" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-purple-500 focus:outline-none">
                            <option value="secretaria">Secretária</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                            Adicionar
                        </button>
                        <button type="button" onclick="fecharModalUsuario()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Credenciais -->
    <div id="modalCredenciais" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-green-500 w-full max-w-sm">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-check text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">Credenciais Geradas</h3>
                </div>
                <div class="bg-gray-800 rounded-lg p-4 mb-4">
                    <p class="text-gray-400 text-sm">Email:</p>
                    <p class="text-white font-mono" id="credEmail">-</p>
                    <p class="text-gray-400 text-sm mt-2">Senha:</p>
                    <p class="text-yellow-400 font-mono font-bold text-lg" id="credSenha">-</p>
                </div>
                <button onclick="copiarCredenciaisSimples()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition mb-2">
                    <i class="fas fa-copy mr-2"></i>Copiar
                </button>
                <button onclick="fecharModalCredenciais()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Resultado Envio Credenciais -->
    <div id="modalResultadoCredenciais" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-md">
            <div class="p-6">
                <div class="text-center mb-4">
                    <div id="resultadoIcone" class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-envelope text-white text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">Resultado do Envio</h3>
                </div>
                <div class="flex gap-4 mb-4">
                    <div class="flex-1 bg-green-900/30 border border-green-700 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-green-400" id="resultTotalEnviados">0</p>
                        <p class="text-xs text-green-300">Enviados</p>
                    </div>
                    <div class="flex-1 bg-red-900/30 border border-red-700 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-red-400" id="resultTotalFalhas">0</p>
                        <p class="text-xs text-red-300">Falhas</p>
                    </div>
                </div>
                <div id="resultDetalhes" class="space-y-2 max-h-60 overflow-y-auto mb-4">
                    <!-- Preenchido via JS -->
                </div>
                <button onclick="fecharModalResultadoCredenciais()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Selecionar Destinatários -->
    <div id="modalSelecionarDestinatarios" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-paper-plane mr-2 text-blue-400"></i>Enviar Credenciais
                </h3>
                <p class="text-gray-400 text-sm mb-4">Selecione quem deve receber as credenciais de acesso:</p>

                <div class="mb-4">
                    <label class="flex items-center gap-2 text-gray-300 text-sm mb-2 cursor-pointer">
                        <input type="checkbox" id="checkTodos" onchange="toggleTodosDestinatarios()"
                               class="w-4 h-4 bg-gray-800 border-gray-700 rounded text-blue-500">
                        <span class="font-medium">Selecionar todos</span>
                    </label>
                </div>

                <div id="listaDestinatarios" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                    <!-- Preenchido via JS -->
                </div>

                <div class="bg-yellow-900/30 border border-yellow-700 rounded-lg p-3 mb-4">
                    <p class="text-yellow-300 text-xs">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        Isso vai gerar novas senhas temporarias para os selecionados.
                    </p>
                </div>

                <div class="flex gap-3">
                    <button onclick="confirmarEnvioCredenciais()" id="btnConfirmarEnvio"
                            class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-paper-plane mr-1"></i>Enviar
                    </button>
                    <button onclick="fecharModalSelecionarDestinatarios()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Plano -->
    <div id="modalPlano" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 rounded-xl border border-gray-700 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h3 class="text-xl font-bold text-white mb-4">
                    <i class="fas fa-tag mr-2 text-yellow-400"></i>Editar Plano
                </h3>

                <!-- Info do Cliente -->
                <div class="bg-gray-800/50 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-user-md text-purple-400"></i>
                            <span class="text-gray-300 text-sm">Medicos cadastrados:</span>
                        </div>
                        <span class="text-gray-400 text-sm" id="modalMedicosCadastrados">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calculator text-blue-400"></i>
                            <span class="text-gray-300 text-sm">Profissionais para cobranca:</span>
                        </div>
                        <input type="number" id="modalTotalProfissionais" min="1" max="20"
                               class="w-16 px-2 py-1 bg-gray-700 border border-gray-600 rounded text-white text-center font-bold focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               onchange="calcularValorPlano()">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Ajuste se necessario (secretarias nao contam)</p>
                </div>

                <!-- Cards de Plano -->
                <div class="space-y-3 mb-5">
                    <div id="planoCardIndividual" onclick="selecionarPlanoModal('individual')"
                         class="cursor-pointer rounded-lg border-2 border-gray-700 p-4 hover:border-blue-500 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div>
                                    <p class="text-white font-semibold">Individual</p>
                                    <p class="text-gray-400 text-sm">1 profissional incluso</p>
                                </div>
                            </div>
                            <span class="text-green-400 font-bold">R$ 150</span>
                        </div>
                    </div>

                    <div id="planoCardClinica" onclick="selecionarPlanoModal('clinica')"
                         class="cursor-pointer rounded-lg border-2 border-gray-700 p-4 hover:border-blue-500 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                                <div>
                                    <p class="text-white font-semibold">Consultorio</p>
                                    <p class="text-gray-400 text-sm">2 profissionais inclusos</p>
                                </div>
                            </div>
                            <span class="text-green-400 font-bold">R$ 200</span>
                        </div>
                    </div>

                    <div id="planoCardProfissional" onclick="selecionarPlanoModal('profissional')"
                         class="cursor-pointer rounded-lg border-2 border-gray-700 p-4 hover:border-blue-500 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-cyan-600 flex items-center justify-center">
                                    <i class="fas fa-briefcase-medical text-white"></i>
                                </div>
                                <div>
                                    <p class="text-white font-semibold">Profissional</p>
                                    <p class="text-gray-400 text-sm">2 profissionais inclusos</p>
                                </div>
                            </div>
                            <span class="text-green-400 font-bold">R$ 200</span>
                        </div>
                    </div>
                </div>

                <!-- Opcionais -->
                <div class="mb-5">
                    <label class="flex items-center gap-3 cursor-pointer bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-green-500 transition">
                        <input type="checkbox" id="planoLinhaDedicada" onchange="calcularValorPlano()"
                               class="w-5 h-5 rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500 focus:ring-offset-gray-900">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <i class="fab fa-whatsapp text-green-400"></i>
                                <span class="text-white font-medium">Linha WhatsApp Dedicada</span>
                            </div>
                            <p class="text-gray-400 text-xs mt-1">Numero exclusivo para a clinica</p>
                        </div>
                        <span class="text-green-400 font-bold">+R$ 40</span>
                    </label>
                </div>

                <!-- Resumo do Calculo -->
                <div class="bg-gray-800 rounded-lg p-4 mb-5 border border-gray-700">
                    <p class="text-gray-400 text-sm mb-3 font-medium">Resumo do Calculo</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Plano base</span>
                            <span class="text-white" id="resumoPlanoBase">R$ 150,00</span>
                        </div>
                        <div class="flex justify-between" id="resumoExtrasRow">
                            <span class="text-gray-400">Profissionais extras (<span id="resumoQtdExtras">0</span> x R$50)</span>
                            <span class="text-white" id="resumoExtrasValor">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between" id="resumoLinhaRow" style="display: none;">
                            <span class="text-gray-400">Linha WhatsApp dedicada</span>
                            <span class="text-white">R$ 40,00</span>
                        </div>
                        <div class="border-t border-gray-600 pt-2 mt-2 flex justify-between">
                            <span class="text-gray-300 font-medium">Total calculado</span>
                            <span class="text-green-400 font-bold text-lg" id="resumoTotalCalculado">R$ 150,00</span>
                        </div>
                    </div>
                </div>

                <!-- Valor Final (editavel) -->
                <div class="mb-6">
                    <label class="block text-sm text-gray-400 mb-2">Valor Final da Mensalidade</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">R$</span>
                        <input type="text" id="planoValorInput"
                               class="w-full pl-10 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-lg font-semibold focus:ring-2 focus:ring-purple-500 focus:outline-none"
                               placeholder="150.00">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Voce pode ajustar o valor final se necessario</p>
                </div>

                <input type="hidden" id="planoSelecionado" value="">

                <div class="flex gap-3">
                    <button onclick="salvarPlano()" id="btnSalvarPlano"
                            class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-save mr-1"></i>Salvar
                    </button>
                    <button onclick="fecharModalPlano()" class="flex-1 bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 transition">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Verificar autenticação
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/static/admin/login.html';
        }

        // Obter ID do cliente da URL
        const urlParams = new URLSearchParams(window.location.search);
        const clienteId = urlParams.get('id');

        if (!clienteId) {
            window.location.href = '/static/admin/clientes.html';
        }

        // Configurar link do botão Setup
        document.getElementById('btnSetup').href = `/static/admin/cliente-setup.html?id=${clienteId}`;

        let clienteData = null;
        let isEditMode = false;

        async function carregarCliente() {
            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Host': 'admin.horariointeligente.com.br'
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar cliente');

                clienteData = await response.json();
                renderizarCliente();
                await carregarMedicos();
                await carregarUsuarios();

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('conteudo').classList.remove('hidden');

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao carregar dados do cliente');
                window.location.href = '/static/admin/clientes.html';
            }
        }

        function renderizarCliente() {
            const c = clienteData;

            // Header
            document.getElementById('headerNome').textContent = c.nome;
            document.getElementById('headerSubdomain').textContent = c.subdomain + '.horariointeligente.com.br';

            // Status badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = c.ativo ? 'Ativo' : 'Inativo';
            statusBadge.className = `px-3 py-1 rounded-full text-sm font-medium ${c.ativo ? 'bg-green-900/50 text-green-300' : 'bg-red-900/50 text-red-300'}`;

            // Stats
            const totalMedicos = c.total_medicos || 0;
            const totalSecretarias = c.total_secretarias || 0;
            document.getElementById('statMedicos').textContent = totalMedicos;
            document.getElementById('statMedicos').title = totalSecretarias > 0 ? `+ ${totalSecretarias} secretária(s)` : '';
            document.getElementById('statPacientes').textContent = c.total_pacientes || 0;
            document.getElementById('statAgendamentos').textContent = c.total_agendamentos || 0;
            document.getElementById('statCriado').textContent = c.criado_em ? new Date(c.criado_em).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }) : '-';

            // Informações
            document.getElementById('infoNome').textContent = c.nome || '-';
            document.getElementById('infoEmail').textContent = c.email || '-';
            document.getElementById('infoTelefone').textContent = c.telefone || '-';
            document.getElementById('infoWhatsApp').textContent = c.whatsapp_numero || 'Não configurado';
            document.getElementById('infoEndereco').textContent = c.endereco || 'Não informado';

            // Edit fields
            document.getElementById('editNome').value = c.nome || '';
            document.getElementById('editEmail').value = c.email || '';
            document.getElementById('editTelefone').value = c.telefone || '';
            document.getElementById('editEndereco').value = c.endereco || '';

            // Acesso
            const url = `https://${c.subdomain}.horariointeligente.com.br`;
            document.getElementById('urlAcesso').textContent = url;
            document.getElementById('linkAcesso').href = url;

            // Plano
            const planos = {
                'individual': { nome: 'Individual', desc: '1 profissional incluso' },
                'clinica': { nome: 'Consultório', desc: '2 profissionais inclusos' },
                'profissional': { nome: 'Profissional', desc: '2 profissionais inclusos' }
            };
            const plano = planos[c.plano] || { nome: c.plano || 'Não definido', desc: '-' };
            document.getElementById('planoNome').textContent = plano.nome;

            // Mostrar valor real da mensalidade
            const valorMensalidade = c.valor_mensalidade ? parseFloat(c.valor_mensalidade) : 0;
            document.getElementById('planoValor').textContent = valorMensalidade > 0
                ? `R$ ${valorMensalidade.toFixed(2).replace('.', ',')}/mês`
                : '-';
            document.getElementById('planoDescricao').textContent = plano.desc;

            // Botão status
            const btnStatus = document.getElementById('btnToggleStatus');
            if (c.ativo) {
                btnStatus.innerHTML = '<i class="fas fa-ban"></i><span>Desativar Cliente</span>';
                btnStatus.className = 'w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2';
            } else {
                btnStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Reativar Cliente</span>';
                btnStatus.className = 'w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2';
            }

            // Botão credenciais
            renderizarCredenciaisButton();
        }

        async function carregarMedicos() {
            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/medicos`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Host': 'admin.horariointeligente.com.br'
                    }
                });

                const data = await response.json();
                const lista = document.getElementById('listaMedicos');

                if (!data.medicos || data.medicos.length === 0) {
                    lista.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum profissional cadastrado</p>';
                    return;
                }

                lista.innerHTML = data.medicos.map(m => `
                    <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center">
                                <i class="fas fa-user-md text-white"></i>
                            </div>
                            <div>
                                <p class="text-white font-medium">${escapeHtml(m.nome)}</p>
                                <p class="text-gray-400 text-sm">${escapeHtml(m.especialidade)} - ${escapeHtml(m.crm)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${m.is_admin ? '<span class="px-2 py-1 bg-yellow-900/50 text-yellow-300 text-xs rounded">Admin</span>' : ''}
                            ${m.ativo ? '<span class="text-green-400"><i class="fas fa-check-circle"></i></span>' : '<span class="text-red-400"><i class="fas fa-times-circle"></i></span>'}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar médicos:', error);
            }
        }

        async function carregarUsuarios() {
            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/usuarios`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Host': 'admin.horariointeligente.com.br'
                    }
                });

                const data = await response.json();
                const lista = document.getElementById('listaUsuarios');

                if (!data.usuarios || data.usuarios.length === 0) {
                    lista.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum usuário adicional</p>';
                    return;
                }

                lista.innerHTML = data.usuarios.map(u => `
                    <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <p class="text-white font-medium">${escapeHtml(u.nome)}</p>
                                <p class="text-gray-400 text-sm">${escapeHtml(u.email)}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 bg-gray-700 text-gray-300 text-xs rounded">${escapeHtml(u.tipo)}</span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('infoView').classList.toggle('hidden', isEditMode);
            document.getElementById('infoEdit').classList.toggle('hidden', !isEditMode);
            document.getElementById('btnEditar').innerHTML = isEditMode ?
                '<i class="fas fa-times mr-1"></i>Cancelar' :
                '<i class="fas fa-edit mr-1"></i>Editar';
        }

        async function salvarEdicao() {
            const dados = {
                nome_fantasia: document.getElementById('editNome').value,
                email: document.getElementById('editEmail').value,
                telefone: document.getElementById('editTelefone').value,
                endereco: document.getElementById('editEndereco').value
            };

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) throw new Error('Erro ao salvar');

                await carregarCliente();
                toggleEditMode();

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar alterações');
            }
        }

        async function toggleStatusCliente() {
            const novoStatus = !clienteData.ativo;
            const acao = novoStatus ? 'reativar' : 'desativar';

            if (!confirm(`Deseja ${acao} este cliente?`)) return;

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify({
                        ativo: novoStatus,
                        motivo: `${acao === 'desativar' ? 'Desativado' : 'Reativado'} via painel admin`
                    })
                });

                if (!response.ok) throw new Error('Erro ao alterar status');

                await carregarCliente();

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao alterar status');
            }
        }

        // Credenciais
        function renderizarCredenciaisButton() {
            const container = document.getElementById('credenciaisButtonContainer');
            if (!clienteData || !clienteData.ativo) {
                container.innerHTML = '';
                return;
            }

            const enviadas = clienteData.credenciais_enviadas_em;
            if (enviadas) {
                const dataEnvio = new Date(enviadas).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                container.innerHTML = `
                    <button onclick="enviarCredenciais()"
                            class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-redo"></i>
                        <span>Reenviar Credenciais</span>
                    </button>
                    <p class="text-xs text-gray-500 text-center mt-1">Enviadas em ${dataEnvio}</p>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="enviarCredenciais()"
                            class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        <span>Enviar Credenciais</span>
                    </button>
                `;
            }
        }

        let profissionaisParaCredenciais = [];

        async function enviarCredenciais() {
            // Carregar lista de profissionais elegíveis
            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/profissionais-credenciais`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Host': 'admin.horariointeligente.com.br'
                    }
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Erro ao carregar profissionais');

                profissionaisParaCredenciais = data.profissionais;

                if (profissionaisParaCredenciais.length === 0) {
                    alert('Nenhum profissional elegível para receber credenciais.');
                    return;
                }

                // Renderizar lista no modal
                const lista = document.getElementById('listaDestinatarios');
                lista.innerHTML = profissionaisParaCredenciais.map(p => `
                    <label class="flex items-center gap-3 bg-gray-800 rounded-lg p-3 cursor-pointer hover:bg-gray-700 transition">
                        <input type="checkbox" class="checkDestinatario w-4 h-4 bg-gray-700 border-gray-600 rounded text-blue-500"
                               value="${p.id}" checked>
                        <div class="flex-1">
                            <p class="text-white text-sm font-medium">${escapeHtml(p.nome)}</p>
                            <p class="text-gray-400 text-xs">${escapeHtml(p.email)} - ${escapeHtml(p.tipo)}</p>
                        </div>
                        ${p.is_admin ? '<span class="px-2 py-1 bg-yellow-900/50 text-yellow-300 text-xs rounded">Admin</span>' : ''}
                    </label>
                `).join('');

                document.getElementById('checkTodos').checked = true;
                document.getElementById('modalSelecionarDestinatarios').classList.remove('hidden');

            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        }

        function toggleTodosDestinatarios() {
            const checkTodos = document.getElementById('checkTodos').checked;
            document.querySelectorAll('.checkDestinatario').forEach(cb => cb.checked = checkTodos);
        }

        function fecharModalSelecionarDestinatarios() {
            document.getElementById('modalSelecionarDestinatarios').classList.add('hidden');
        }

        async function confirmarEnvioCredenciais() {
            const selecionados = Array.from(document.querySelectorAll('.checkDestinatario:checked')).map(cb => parseInt(cb.value));

            if (selecionados.length === 0) {
                alert('Selecione pelo menos um destinatário.');
                return;
            }

            const btn = document.getElementById('btnConfirmarEnvio');
            const btnOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader" style="width:18px;height:18px;border-width:2px;display:inline-block;margin-right:8px;"></div>Enviando...';

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/enviar-credenciais`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify({ profissional_ids: selecionados })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erro ao enviar credenciais');

                // Atualizar dados locais
                clienteData.credenciais_enviadas_em = result.credenciais_enviadas_em;
                renderizarCredenciaisButton();

                // Fechar modal de seleção e mostrar resultado
                fecharModalSelecionarDestinatarios();
                mostrarResultadoCredenciais(result);

            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = btnOriginal;
            }
        }

        function mostrarResultadoCredenciais(result) {
            document.getElementById('resultTotalEnviados').textContent = result.total_enviados;
            document.getElementById('resultTotalFalhas').textContent = result.total_falhas;

            const icone = document.getElementById('resultadoIcone');
            if (result.total_falhas === 0) {
                icone.className = 'w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3';
                icone.innerHTML = '<i class="fas fa-check text-white text-xl"></i>';
            } else {
                icone.className = 'w-12 h-12 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-3';
                icone.innerHTML = '<i class="fas fa-exclamation-triangle text-white text-xl"></i>';
            }

            const detalhesContainer = document.getElementById('resultDetalhes');
            detalhesContainer.innerHTML = result.detalhes.map(d => `
                <div class="bg-gray-800 rounded-lg p-3 flex items-center justify-between">
                    <div>
                        <p class="text-white text-sm font-medium">${escapeHtml(d.nome)}</p>
                        <p class="text-gray-400 text-xs">${escapeHtml(d.email)} - ${d.tipo === 'secretaria' ? 'Secretária' : 'Médico(a)'}</p>
                    </div>
                    ${d.email_enviado
                        ? '<span class="text-green-400"><i class="fas fa-check-circle"></i></span>'
                        : '<span class="text-red-400"><i class="fas fa-times-circle"></i></span>'}
                </div>
            `).join('');

            document.getElementById('modalResultadoCredenciais').classList.remove('hidden');
        }

        function fecharModalResultadoCredenciais() {
            document.getElementById('modalResultadoCredenciais').classList.add('hidden');
        }

        // Modais
        function abrirModalMedico() {
            document.getElementById('modalMedico').classList.remove('hidden');
        }
        function fecharModalMedico() {
            document.getElementById('modalMedico').classList.add('hidden');
            document.getElementById('formMedico').reset();
        }
        function abrirModalUsuario() {
            document.getElementById('modalUsuario').classList.remove('hidden');
        }
        function fecharModalUsuario() {
            document.getElementById('modalUsuario').classList.add('hidden');
            document.getElementById('formUsuario').reset();
        }
        function fecharModalCredenciais() {
            document.getElementById('modalCredenciais').classList.add('hidden');
        }

        // Forms
        document.getElementById('formMedico').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/medicos`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify({
                        nome: formData.get('nome'),
                        especialidade: formData.get('especialidade'),
                        registro_profissional: formData.get('registro_profissional'),
                        email: formData.get('email'),
                        pode_fazer_login: formData.get('pode_fazer_login') === 'on',
                        is_admin: false
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erro');

                fecharModalMedico();
                await carregarMedicos();

                if (result.credenciais) {
                    document.getElementById('credEmail').textContent = result.credenciais.email;
                    document.getElementById('credSenha').textContent = result.credenciais.senha_temporaria;
                    document.getElementById('modalCredenciais').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        });

        document.getElementById('formUsuario').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/usuarios`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify({
                        nome: formData.get('nome'),
                        email: formData.get('email'),
                        telefone: formData.get('telefone') || null,
                        tipo: formData.get('tipo')
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erro');

                fecharModalUsuario();
                await carregarUsuarios();

                if (result.credenciais) {
                    document.getElementById('credEmail').textContent = result.credenciais.email;
                    document.getElementById('credSenha').textContent = result.credenciais.senha_temporaria;
                    document.getElementById('modalCredenciais').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            }
        });

        function copiarCredenciaisSimples() {
            const email = document.getElementById('credEmail').textContent;
            const senha = document.getElementById('credSenha').textContent;
            navigator.clipboard.writeText(`Email: ${email}\nSenha: ${senha}`).then(() => {
                alert('Copiado!');
            });
        }

        // Fechar modais ao clicar fora
        ['modalMedico', 'modalUsuario', 'modalCredenciais', 'modalResultadoCredenciais', 'modalPlano', 'modalSelecionarDestinatarios'].forEach(id => {
            document.getElementById(id).addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
        });

        // ========== Funções do Modal de Plano ==========

        function abrirModalPlano() {
            // Obter total de médicos cadastrados (sem secretárias)
            const medicosCadastrados = clienteData.total_medicos || 0;
            document.getElementById('modalMedicosCadastrados').textContent = medicosCadastrados;

            // Definir profissionais para cobrança (editável)
            document.getElementById('modalTotalProfissionais').value = medicosCadastrados || 1;

            // Pré-selecionar plano atual
            const planoAtual = clienteData.plano || 'individual';
            selecionarPlanoModal(planoAtual);

            // Verificar se tem linha dedicada (baseado no valor atual vs calculado)
            // Por enquanto, iniciar desmarcado
            document.getElementById('planoLinhaDedicada').checked = false;

            // Calcular e preencher valor
            calcularValorPlano();

            // Se já tem um valor salvo diferente do calculado, usar o salvo
            const valorAtual = parseFloat(clienteData.valor_mensalidade) || 0;
            if (valorAtual > 0) {
                document.getElementById('planoValorInput').value = valorAtual.toFixed(2);
            }

            document.getElementById('modalPlano').classList.remove('hidden');
        }

        function fecharModalPlano() {
            document.getElementById('modalPlano').classList.add('hidden');
        }

        function selecionarPlanoModal(plano) {
            document.getElementById('planoSelecionado').value = plano;

            // Remover seleção de todos os cards
            ['Individual', 'Clinica', 'Profissional'].forEach(p => {
                const card = document.getElementById('planoCard' + p);
                card.classList.remove('border-purple-500', 'bg-purple-900/20');
                card.classList.add('border-gray-700');
            });

            // Aplicar seleção no card escolhido
            const cardId = 'planoCard' + plano.charAt(0).toUpperCase() + plano.slice(1);
            const cardSelecionado = document.getElementById(cardId);
            cardSelecionado.classList.remove('border-gray-700');
            cardSelecionado.classList.add('border-purple-500', 'bg-purple-900/20');

            // Recalcular valor
            calcularValorPlano();
        }

        function calcularValorPlano() {
            const plano = document.getElementById('planoSelecionado').value || 'individual';
            const linhaDedicada = document.getElementById('planoLinhaDedicada').checked;
            const totalProfissionais = parseInt(document.getElementById('modalTotalProfissionais').value) || 1;

            // Valores base e profissionais inclusos por plano
            const planosConfig = {
                'individual': { base: 150, inclusos: 1 },
                'clinica': { base: 200, inclusos: 2 },
                'profissional': { base: 200, inclusos: 2 }
            };

            const config = planosConfig[plano] || planosConfig['individual'];
            const valorBase = config.base;
            const profissionaisInclusos = config.inclusos;

            // Calcular extras
            const profissionaisExtras = Math.max(0, totalProfissionais - profissionaisInclusos);
            const valorExtras = profissionaisExtras * 50;
            const valorLinha = linhaDedicada ? 40 : 0;
            const valorTotal = valorBase + valorExtras + valorLinha;

            // Atualizar resumo
            document.getElementById('resumoPlanoBase').textContent = `R$ ${valorBase.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoQtdExtras').textContent = profissionaisExtras;
            document.getElementById('resumoExtrasValor').textContent = `R$ ${valorExtras.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoTotalCalculado').textContent = `R$ ${valorTotal.toFixed(2).replace('.', ',')}`;

            // Mostrar/ocultar linha de extras
            document.getElementById('resumoExtrasRow').style.display = profissionaisExtras > 0 ? 'flex' : 'none';
            document.getElementById('resumoLinhaRow').style.display = linhaDedicada ? 'flex' : 'none';

            // Atualizar input de valor
            document.getElementById('planoValorInput').value = valorTotal.toFixed(2);
        }

        async function salvarPlano() {
            const plano = document.getElementById('planoSelecionado').value;
            const valor = document.getElementById('planoValorInput').value.trim().replace(',', '.');
            const linhaDedicada = document.getElementById('planoLinhaDedicada').checked;

            if (!plano) {
                alert('Selecione um plano');
                return;
            }

            if (!valor || isNaN(parseFloat(valor)) || parseFloat(valor) < 0) {
                alert('Informe um valor valido');
                return;
            }

            const btn = document.getElementById('btnSalvarPlano');
            const btnOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader" style="width:18px;height:18px;border-width:2px;display:inline-block;margin-right:8px;"></div>Salvando...';

            try {
                const response = await fetch(`/api/admin/clientes/${clienteId}/plano`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Host': 'admin.horariointeligente.com.br'
                    },
                    body: JSON.stringify({
                        plano: plano,
                        valor_mensalidade: parseFloat(valor).toFixed(2),
                        linha_dedicada: linhaDedicada
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erro ao salvar plano');

                // Atualizar dados locais
                clienteData.plano = plano;
                clienteData.valor_mensalidade = parseFloat(valor).toFixed(2);

                // Re-renderizar a seção de plano
                renderizarCliente();

                fecharModalPlano();
                alert('Plano atualizado com sucesso!');

            } catch (error) {
                console.error('Erro:', error);
                alert(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = btnOriginal;
            }
        }

        // Carregar dados
        carregarCliente();
    </script>
</body>
</html>
